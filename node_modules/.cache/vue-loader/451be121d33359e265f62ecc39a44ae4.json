{"remainingRequest":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/@rancher/shell/edit/provisioning.cattle.io.cluster/rke2.vue?vue&type=script&lang=js","dependencies":[{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/@rancher/shell/edit/provisioning.cattle.io.cluster/rke2.vue","mtime":1716430447141},{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/cache-loader/dist/cjs.js","mtime":1716430465924},{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/babel-loader/lib/index.js","mtime":1716430465839},{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/cache-loader/dist/cjs.js","mtime":1716430465924},{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js","mtime":1716430467929}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmltcG9ydCBkaWZmZXJlbmNlIGZyb20gJ2xvZGFzaC9kaWZmZXJlbmNlJzsKaW1wb3J0IHRocm90dGxlIGZyb20gJ2xvZGFzaC90aHJvdHRsZSc7CmltcG9ydCBpc0FycmF5IGZyb20gJ2xvZGFzaC9pc0FycmF5JzsKaW1wb3J0IG1lcmdlIGZyb20gJ2xvZGFzaC9tZXJnZSc7CmltcG9ydCBDcmVhdGVFZGl0VmlldyBmcm9tICdAc2hlbGwvbWl4aW5zL2NyZWF0ZS1lZGl0LXZpZXcnOwppbXBvcnQgRm9ybVZhbGlkYXRpb24gZnJvbSAnQHNoZWxsL21peGlucy9mb3JtLXZhbGlkYXRpb24nOwppbXBvcnQgeyBub3JtYWxpemVOYW1lIH0gZnJvbSAnQHNoZWxsL3V0aWxzL2t1YmUnOwoKaW1wb3J0IHsKICBDQVBJLAogIE1BTkFHRU1FTlQsCiAgTkFNRVNQQUNFLAogIE5PUk1BTiwKICBTQ0hFTUEsCiAgREVGQVVMVF9XT1JLU1BBQ0UsCiAgU0VDUkVULAogIEhDSSwKICBQU1BTLAp9IGZyb20gJ0BzaGVsbC9jb25maWcvdHlwZXMnOwppbXBvcnQgeyBfQ1JFQVRFLCBfRURJVCwgX1ZJRVcgfSBmcm9tICdAc2hlbGwvY29uZmlnL3F1ZXJ5LXBhcmFtcyc7CgppbXBvcnQgeyBmaW5kQnksIHJlbW92ZU9iamVjdCwgY2xlYXIgfSBmcm9tICdAc2hlbGwvdXRpbHMvYXJyYXknOwppbXBvcnQgeyBjcmVhdGVZYW1sIH0gZnJvbSAnQHNoZWxsL3V0aWxzL2NyZWF0ZS15YW1sJzsKaW1wb3J0IHsKICBjbG9uZSwgZGlmZiwgc2V0LCBnZXQsIGlzRW1wdHkKfSBmcm9tICdAc2hlbGwvdXRpbHMvb2JqZWN0JzsKaW1wb3J0IHsgYWxsSGFzaCB9IGZyb20gJ0BzaGVsbC91dGlscy9wcm9taXNlJzsKaW1wb3J0IHsgc29ydEJ5IH0gZnJvbSAnQHNoZWxsL3V0aWxzL3NvcnQnOwoKaW1wb3J0IHsgY2FtZWxUb1RpdGxlIH0gZnJvbSAnQHNoZWxsL3V0aWxzL3N0cmluZyc7CmltcG9ydCB7IGNvbXBhcmUsIHNvcnRhYmxlIH0gZnJvbSAnQHNoZWxsL3V0aWxzL3ZlcnNpb24nOwppbXBvcnQgeyBpc0hhcnZlc3RlclNhdGlzZmllc1ZlcnNpb24gfSBmcm9tICdAc2hlbGwvdXRpbHMvY2x1c3Rlcic7CmltcG9ydCAqIGFzIFZFUlNJT04gZnJvbSAnQHNoZWxsL3V0aWxzL3ZlcnNpb24nOwoKaW1wb3J0IEFycmF5TGlzdCBmcm9tICdAc2hlbGwvY29tcG9uZW50cy9mb3JtL0FycmF5TGlzdCc7CmltcG9ydCBBcnJheUxpc3RHcm91cGVkIGZyb20gJ0BzaGVsbC9jb21wb25lbnRzL2Zvcm0vQXJyYXlMaXN0R3JvdXBlZCc7CmltcG9ydCB7IEJhZGdlU3RhdGUgfSBmcm9tICdAY29tcG9uZW50cy9CYWRnZVN0YXRlJzsKaW1wb3J0IHsgQmFubmVyIH0gZnJvbSAnQGNvbXBvbmVudHMvQmFubmVyJzsKaW1wb3J0IHsgQ2hlY2tib3ggfSBmcm9tICdAY29tcG9uZW50cy9Gb3JtL0NoZWNrYm94JzsKaW1wb3J0IENydVJlc291cmNlLCB7IENPTlRFWFRfSE9PS19FRElUX1lBTUwgfSBmcm9tICdAc2hlbGwvY29tcG9uZW50cy9DcnVSZXNvdXJjZSc7CmltcG9ydCB7IExhYmVsZWRJbnB1dCB9IGZyb20gJ0Bjb21wb25lbnRzL0Zvcm0vTGFiZWxlZElucHV0JzsKaW1wb3J0IExhYmVsZWRTZWxlY3QgZnJvbSAnQHNoZWxsL2NvbXBvbmVudHMvZm9ybS9MYWJlbGVkU2VsZWN0JzsKaW1wb3J0IExvYWRpbmcgZnJvbSAnQHNoZWxsL2NvbXBvbmVudHMvTG9hZGluZyc7CmltcG9ydCBNYXRjaEV4cHJlc3Npb25zIGZyb20gJ0BzaGVsbC9jb21wb25lbnRzL2Zvcm0vTWF0Y2hFeHByZXNzaW9ucyc7CmltcG9ydCBOYW1lTnNEZXNjcmlwdGlvbiBmcm9tICdAc2hlbGwvY29tcG9uZW50cy9mb3JtL05hbWVOc0Rlc2NyaXB0aW9uJzsKaW1wb3J0IHsgUmFkaW9Hcm91cCB9IGZyb20gJ0Bjb21wb25lbnRzL0Zvcm0vUmFkaW8nOwppbXBvcnQgVGFiIGZyb20gJ0BzaGVsbC9jb21wb25lbnRzL1RhYmJlZC9UYWInOwppbXBvcnQgVGFiYmVkIGZyb20gJ0BzaGVsbC9jb21wb25lbnRzL1RhYmJlZCc7CmltcG9ydCBVbml0SW5wdXQgZnJvbSAnQHNoZWxsL2NvbXBvbmVudHMvZm9ybS9Vbml0SW5wdXQnOwppbXBvcnQgWWFtbEVkaXRvciBmcm9tICdAc2hlbGwvY29tcG9uZW50cy9ZYW1sRWRpdG9yJzsKaW1wb3J0IFF1ZXN0aW9ucyBmcm9tICdAc2hlbGwvY29tcG9uZW50cy9RdWVzdGlvbnMnOwoKaW1wb3J0IHsgY2FuVmlld0NsdXN0ZXJNZW1iZXJzaGlwRWRpdG9yIH0gZnJvbSAnQHNoZWxsL2NvbXBvbmVudHMvZm9ybS9NZW1iZXJzL0NsdXN0ZXJNZW1iZXJzaGlwRWRpdG9yJzsKaW1wb3J0IFNlbGVjdE9yQ3JlYXRlQXV0aFNlY3JldCBmcm9tICdAc2hlbGwvY29tcG9uZW50cy9mb3JtL1NlbGVjdE9yQ3JlYXRlQXV0aFNlY3JldCc7CmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJzsKCmltcG9ydCB7IFNFVFRJTkcgfSBmcm9tICdAc2hlbGwvY29uZmlnL3NldHRpbmdzJzsKaW1wb3J0IHsgYmFzZTY0RW5jb2RlIH0gZnJvbSAnQHNoZWxsL3V0aWxzL2NyeXB0byc7CmltcG9ydCB7IENBUEkgYXMgQ0FQSV9BTk5PVEFUSU9OUyB9IGZyb20gJ0BzaGVsbC9jb25maWcvbGFiZWxzLWFubm90YXRpb25zJzsKaW1wb3J0IEFDRSBmcm9tICcuL0FDRSc7CmltcG9ydCBBZ2VudEVudiBmcm9tICcuL0FnZW50RW52JzsKaW1wb3J0IERyYWluT3B0aW9ucyBmcm9tICcuL0RyYWluT3B0aW9ucyc7CmltcG9ydCBMYWJlbHMgZnJvbSAnLi9MYWJlbHMnOwppbXBvcnQgTWFjaGluZVBvb2wgZnJvbSAnLi9NYWNoaW5lUG9vbCc7CmltcG9ydCBSZWdpc3RyeUNvbmZpZ3MgZnJvbSAnLi9SZWdpc3RyeUNvbmZpZ3MnOwppbXBvcnQgUmVnaXN0cnlNaXJyb3JzIGZyb20gJy4vUmVnaXN0cnlNaXJyb3JzJzsKaW1wb3J0IFMzQ29uZmlnIGZyb20gJy4vUzNDb25maWcnOwppbXBvcnQgU2VsZWN0Q3JlZGVudGlhbCBmcm9tICcuL1NlbGVjdENyZWRlbnRpYWwnOwppbXBvcnQgQWR2YW5jZWRTZWN0aW9uIGZyb20gJ0BzaGVsbC9jb21wb25lbnRzL0FkdmFuY2VkU2VjdGlvbi52dWUnOwppbXBvcnQgeyBFTEVNRU5UQUxfU0NIRU1BX0lEUywgS0lORCwgRUxFTUVOVEFMX0NMVVNURVJfUFJPVklERVIgfSBmcm9tICcuLi8uLi9jb25maWcvZWxlbWVudGFsLXR5cGVzJzsKaW1wb3J0IEFnZW50Q29uZmlndXJhdGlvbiBmcm9tICcuL0FnZW50Q29uZmlndXJhdGlvbic7CmltcG9ydCB7IGdldEFwcGxpY2FibGVFeHRlbnNpb25FbmhhbmNlbWVudHMgfSBmcm9tICdAc2hlbGwvY29yZS9wbHVnaW4taGVscGVycyc7CmltcG9ydCB7IEV4dGVuc2lvblBvaW50LCBUYWJMb2NhdGlvbiB9IGZyb20gJ0BzaGVsbC9jb3JlL3R5cGVzJzsKaW1wb3J0IE1lbWJlclJvbGVzIGZyb20gJ0BzaGVsbC9lZGl0L3Byb3Zpc2lvbmluZy5jYXR0bGUuaW8uY2x1c3Rlci9NZW1iZXJSb2xlcyc7CmltcG9ydCBCYXNpY3MgZnJvbSAnQHNoZWxsL2VkaXQvcHJvdmlzaW9uaW5nLmNhdHRsZS5pby5jbHVzdGVyL0Jhc2ljcyc7Cgpjb25zdCBIQVJWRVNURVIgPSAnaGFydmVzdGVyJzsKY29uc3QgSEFSVkVTVEVSX0NMT1VEX1BST1ZJREVSID0gJ2hhcnZlc3Rlci1jbG91ZC1wcm92aWRlcic7Cgpjb25zdCBORVRCSU9TX1RSVU5DQVRJT05fTEVOR1RIID0gMTU7CgovKioKICogQ2xhc3NlcyB0byBiZSBhZG9wdGVkIGJ5IHRoZSBub2RlIGJhZGdlcyBpbiBNYWNoaW5lIHBvb2xzCiAqLwpjb25zdCBOT0RFX1RPVEFMID0gewogIGVycm9yOiB7CiAgICBjb2xvcjogJ2JnLWVycm9yJywKICAgIGljb246ICAnaWNvbi14JywKICB9LAogIHdhcm5pbmc6IHsKICAgIGNvbG9yOiAnYmctd2FybmluZycsCiAgICBpY29uOiAgJ2ljb24td2FybmluZycsCiAgfSwKICBzdWNjZXNzOiB7CiAgICBjb2xvcjogJ2JnLXN1Y2Nlc3MnLAogICAgaWNvbjogICdpY29uLWNoZWNrbWFyaycKICB9Cn07CmNvbnN0IENMVVNURVJfQUdFTlRfQ1VTVE9NSVpBVElPTiA9ICdjbHVzdGVyQWdlbnREZXBsb3ltZW50Q3VzdG9taXphdGlvbic7CmNvbnN0IEZMRUVUX0FHRU5UX0NVU1RPTUlaQVRJT04gPSAnZmxlZXRBZ2VudERlcGxveW1lbnRDdXN0b21pemF0aW9uJzsKCmV4cG9ydCBkZWZhdWx0IHsKICBjb21wb25lbnRzOiB7CiAgICBBQ0UsCiAgICBBZHZhbmNlZFNlY3Rpb24sCiAgICBBZ2VudEVudiwKICAgIEFycmF5TGlzdCwKICAgIEFycmF5TGlzdEdyb3VwZWQsCiAgICBCYWRnZVN0YXRlLAogICAgQmFubmVyLAogICAgQ2hlY2tib3gsCiAgICBBZ2VudENvbmZpZ3VyYXRpb24sCiAgICBDcnVSZXNvdXJjZSwKICAgIERyYWluT3B0aW9ucywKICAgIExhYmVsZWRJbnB1dCwKICAgIExhYmVsZWRTZWxlY3QsCiAgICBMYWJlbHMsCiAgICBMb2FkaW5nLAogICAgTWFjaGluZVBvb2wsCiAgICBNYXRjaEV4cHJlc3Npb25zLAogICAgTmFtZU5zRGVzY3JpcHRpb24sCiAgICBRdWVzdGlvbnMsCiAgICBSYWRpb0dyb3VwLAogICAgUmVnaXN0cnlDb25maWdzLAogICAgUmVnaXN0cnlNaXJyb3JzLAogICAgUzNDb25maWcsCiAgICBTZWxlY3RDcmVkZW50aWFsLAogICAgU2VsZWN0T3JDcmVhdGVBdXRoU2VjcmV0LAogICAgVGFiLAogICAgVGFiYmVkLAogICAgVW5pdElucHV0LAogICAgWWFtbEVkaXRvciwKICAgIE1lbWJlclJvbGVzLAogICAgQmFzaWNzCiAgfSwKCiAgbWl4aW5zOiBbQ3JlYXRlRWRpdFZpZXcsIEZvcm1WYWxpZGF0aW9uXSwKCiAgcHJvcHM6IHsKICAgIG1vZGU6IHsKICAgICAgdHlwZTogICAgIFN0cmluZywKICAgICAgcmVxdWlyZWQ6IHRydWUsCiAgICB9LAoKICAgIHZhbHVlOiB7CiAgICAgIHR5cGU6ICAgICBPYmplY3QsCiAgICAgIHJlcXVpcmVkOiB0cnVlLAogICAgfSwKCiAgICBwcm92aWRlcjogewogICAgICB0eXBlOiAgICAgU3RyaW5nLAogICAgICByZXF1aXJlZDogdHJ1ZSwKICAgIH0sCiAgfSwKCiAgYXN5bmMgZmV0Y2goKSB7CiAgICB0aGlzLnBzcHMgPSBhd2FpdCB0aGlzLmdldFBzcHMoKTsKICAgIGF3YWl0IHRoaXMuZmV0Y2hSa2UyVmVyc2lvbnMoKTsKICAgIGF3YWl0IHRoaXMuaW5pdFNwZWNzKCk7CiAgICBhd2FpdCB0aGlzLmluaXRBZGRvbnMoKTsKICAgIGF3YWl0IHRoaXMuaW5pdFJlZ2lzdHJ5KCk7CgogICAgT2JqZWN0LmVudHJpZXModGhpcy5jaGFydFZhbHVlcykuZm9yRWFjaCgoW25hbWUsIHZhbHVlXSkgPT4gewogICAgICBjb25zdCBrZXkgPSB0aGlzLmNoYXJ0VmVyc2lvbktleShuYW1lKTsKCiAgICAgIHRoaXMudXNlckNoYXJ0VmFsdWVzW2tleV0gPSB2YWx1ZTsKICAgIH0pOwoKICAgIHRoaXMuc2V0QWdlbnRDb25maWd1cmF0aW9uKCk7CiAgfSwKCiAgZGF0YSgpIHsKICAgIGlmICggIXRoaXMudmFsdWUuc3BlYy5ya2VDb25maWcgKSB7CiAgICAgIHNldCh0aGlzLnZhbHVlLnNwZWMsICdya2VDb25maWcnLCB7fSk7CiAgICB9CgogICAgaWYgKCAhdGhpcy52YWx1ZS5zcGVjLnJrZUNvbmZpZy5jaGFydFZhbHVlcyApIHsKICAgICAgc2V0KHRoaXMudmFsdWUuc3BlYy5ya2VDb25maWcsICdjaGFydFZhbHVlcycsIHt9KTsKICAgIH0KCiAgICBpZiAoICF0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnLnVwZ3JhZGVTdHJhdGVneSApIHsKICAgICAgc2V0KHRoaXMudmFsdWUuc3BlYy5ya2VDb25maWcsICd1cGdyYWRlU3RyYXRlZ3knLCB7CiAgICAgICAgY29udHJvbFBsYW5lQ29uY3VycmVuY3k6ICAnMScsCiAgICAgICAgY29udHJvbFBsYW5lRHJhaW5PcHRpb25zOiB7fSwKICAgICAgICB3b3JrZXJDb25jdXJyZW5jeTogICAgICAgICcxJywKICAgICAgICB3b3JrZXJEcmFpbk9wdGlvbnM6ICAgICAgIHt9LAogICAgICB9KTsKICAgIH0KCiAgICBpZiAoICF0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnLm1hY2hpbmVHbG9iYWxDb25maWcgKSB7CiAgICAgIHNldCh0aGlzLnZhbHVlLnNwZWMsICdya2VDb25maWcubWFjaGluZUdsb2JhbENvbmZpZycsIHt9KTsKICAgIH0KCiAgICBpZiAoICF0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnLm1hY2hpbmVTZWxlY3RvckNvbmZpZz8ubGVuZ3RoICkgewogICAgICBzZXQodGhpcy52YWx1ZS5zcGVjLCAncmtlQ29uZmlnLm1hY2hpbmVTZWxlY3RvckNvbmZpZycsIFt7IGNvbmZpZzoge30gfV0pOwogICAgfQoKICAgIC8vIFN0b3JlIHRoZSBpbml0aWFsIFBTUCB0ZW1wbGF0ZSBuYW1lLCBzbyB3ZSBjYW4gc2V0IGl0IGJhY2sgaWYgbmVlZGVkCiAgICBjb25zdCBsYXN0RGVmYXVsdFBvZFNlY3VyaXR5UG9saWN5VGVtcGxhdGVOYW1lID0gdGhpcy52YWx1ZS5zcGVjLmRlZmF1bHRQb2RTZWN1cml0eVBvbGljeVRlbXBsYXRlTmFtZTsKICAgIGNvbnN0IHByZXZpb3VzS3ViZXJuZXRlc1ZlcnNpb24gPSB0aGlzLnZhbHVlLnNwZWMua3ViZXJuZXRlc1ZlcnNpb247CgogICAgY29uc3QgdHJ1bmNhdGVMaW1pdCA9IHRoaXMudmFsdWUuZGVmYXVsdEhvc3RuYW1lTGVuZ3RoTGltaXQ7CgogICAgcmV0dXJuIHsKICAgICAgbG9hZGVkT25jZTogICAgICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgIGxhc3RJZHg6ICAgICAgICAgICAgICAgICAgICAgICAgIDAsCiAgICAgIGFsbFBTUHM6ICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgIGFsbFBTQXM6ICAgICAgICAgICAgICAgICAgICAgICAgIFtdLAogICAgICBjcmVkZW50aWFsSWQ6ICAgICAgICAgICAgICAgICAgICAnJywKICAgICAgY3JlZGVudGlhbDogICAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgbWFjaGluZVBvb2xzOiAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgcmtlMlZlcnNpb25zOiAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgazNzVmVyc2lvbnM6ICAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgZGVmYXVsdFJrZTI6ICAgICAgICAgICAgICAgICAgICAgJycsCiAgICAgIGRlZmF1bHRLM3M6ICAgICAgICAgICAgICAgICAgICAgICcnLAogICAgICBzM0JhY2t1cDogICAgICAgICAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgLyoqCiAgICAgICAqIEFsbCBpbmZvIHJlbGF0ZWQgdG8gYSBzcGVjaWZpYyB2ZXJzaW9uIG9mIHRoZSBjaGFydAogICAgICAgKgogICAgICAgKiBUaGlzIGluY2x1ZGVzIGNoYXJ0IGl0c2VsZiwgUkVBRE1FIGFuZCB2YWx1ZXMKICAgICAgICoKICAgICAgICogeyBbY2hhcnROYW1lOnN0cmluZ106IHsgY2hhcnQ6IGpzb24sIHJlYWRtZTogc3RyaW5nLCB2YWx1ZXM6IGpzb24gfSB9CiAgICAgICAqLwogICAgICB2ZXJzaW9uSW5mbzogICAgICAgICAgICAgICAgICAgICB7fSwKICAgICAgbWVtYmVyc2hpcFVwZGF0ZTogICAgICAgICAgICAgICAge30sCiAgICAgIHNob3dEZXByZWNhdGVkUGF0Y2hWZXJzaW9uczogICAgIGZhbHNlLAogICAgICBzeXN0ZW1SZWdpc3RyeTogICAgICAgICAgICAgICAgICBudWxsLAogICAgICByZWdpc3RyeUhvc3Q6ICAgICAgICAgICAgICAgICAgICBudWxsLAogICAgICBzaG93Q3VzdG9tUmVnaXN0cnlJbnB1dDogICAgICAgICBmYWxzZSwKICAgICAgc2hvd0N1c3RvbVJlZ2lzdHJ5QWR2YW5jZWRJbnB1dDogZmFsc2UsCiAgICAgIHJlZ2lzdHJ5U2VjcmV0OiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgIHVzZXJDaGFydFZhbHVlczogICAgICAgICAgICAgICAgIHt9LAogICAgICB1c2VyQ2hhcnRWYWx1ZXNUZW1wOiAgICAgICAgICAgICB7fSwKICAgICAgYWRkb25zUmV2OiAgICAgICAgICAgICAgICAgICAgICAgMCwKICAgICAgY2x1c3RlcklzQWxyZWFkeUNyZWF0ZWQ6ICAgICAgICAgISF0aGlzLnZhbHVlLmlkLAogICAgICBmdkZvcm1SdWxlU2V0czogICAgICAgICAgICAgICAgICBbewogICAgICAgIHBhdGg6ICdtZXRhZGF0YS5uYW1lJywgcnVsZXM6IFsnc3ViRG9tYWluJ10sIHRyYW5zbGF0aW9uS2V5OiAnbmFtZU5zRGVzY3JpcHRpb24ubmFtZS5sYWJlbCcKICAgICAgfV0sCiAgICAgIGhhcnZlc3RlclZlcnNpb25SYW5nZToge30sCiAgICAgIGxhc3REZWZhdWx0UG9kU2VjdXJpdHlQb2xpY3lUZW1wbGF0ZU5hbWUsIC8vIFVzZWQgZm9yIHJlc2V0IG9uIGs4cyB2ZXJzaW9uIGNoYW5nZXMKICAgICAgcHJldmlvdXNLdWJlcm5ldGVzVmVyc2lvbiwKICAgICAgY2lzT3ZlcnJpZGU6ICAgICAgICAgICBmYWxzZSwKICAgICAgY2lzUHNhQ2hhbmdlQmFubmVyOiAgICBmYWxzZSwKICAgICAgcHNwczogICAgICAgICAgICAgICAgICBudWxsLCAvLyBMaXN0IG9mIHBvbGljaWVzIGlmIGFueQogICAgICB0cnVuY2F0ZUhvc3RuYW1lczogICAgIHRydW5jYXRlTGltaXQgPT09IE5FVEJJT1NfVFJVTkNBVElPTl9MRU5HVEgsCiAgICAgIHRydW5jYXRlTGltaXQsCiAgICAgIGJ1c3k6ICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgIG1hY2hpbmVQb29sVmFsaWRhdGlvbjoge30sIC8vIG1hcCBvZiB2YWxpZGF0aW9uIHN0YXRlcyBmb3IgZWFjaCBtYWNoaW5lIHBvb2wKICAgICAgbWFjaGluZVBvb2xFcnJvcnM6ICAgICB7fSwKICAgICAgYWxsTmFtZXNwYWNlczogICAgICAgICBbXSwKICAgICAgaW5pdGlhbENsb3VkUHJvdmlkZXI6ICB0aGlzLnZhbHVlPy5hZ2VudENvbmZpZz8uWydjbG91ZC1wcm92aWRlci1uYW1lJ10gfHwgJycsCiAgICAgIGV4dGVuc2lvblRhYnM6ICAgICAgICAgZ2V0QXBwbGljYWJsZUV4dGVuc2lvbkVuaGFuY2VtZW50cyh0aGlzLCBFeHRlbnNpb25Qb2ludC5UQUIsIFRhYkxvY2F0aW9uLkNMVVNURVJfQ1JFQVRFX1JLRTIsIHRoaXMuJHJvdXRlLCB0aGlzKSwKICAgIH07CiAgfSwKCiAgY29tcHV0ZWQ6IHsKCiAgICBya2VDb25maWcoKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnOwogICAgfSwKCiAgICBob3N0bmFtZVRydW5jYXRpb25NYW51YWxseVNldCgpIHsKICAgICAgcmV0dXJuIHRoaXMudHJ1bmNhdGVMaW1pdCAmJiB0aGlzLnRydW5jYXRlTGltaXQgIT09IE5FVEJJT1NfVFJVTkNBVElPTl9MRU5HVEg7CiAgICB9LAoKICAgIGlzRWxlbWVudGFsQ2x1c3RlcigpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZXIgPT09IEVMRU1FTlRBTF9DTFVTVEVSX1BST1ZJREVSIHx8IHRoaXMudmFsdWU/Lm1hY2hpbmVQcm92aWRlcj8udG9Mb3dlckNhc2UoKSA9PT0gS0lORC5NQUNISU5FX0lOVl9TRUxFQ1RPUl9URU1QTEFURVMudG9Mb3dlckNhc2UoKTsKICAgIH0sCgogICAgYWR2YW5jZWRUaXRsZUFsdCgpIHsKICAgICAgY29uc3QgbWFjaGluZVNlbGVjdG9yTGVuZ3RoID0gdGhpcy5ya2VDb25maWcubWFjaGluZVNlbGVjdG9yQ29uZmlnLmxlbmd0aDsKCiAgICAgIHJldHVybiB0aGlzLnQoJ2NsdXN0ZXIuYWR2YW5jZWQuYXJnSW5mby5tYWNoaW5lU2VsZWN0b3IudGl0bGVBbHQnLCB7IGNvdW50OiBtYWNoaW5lU2VsZWN0b3JMZW5ndGggfSk7CiAgICB9LAoKICAgIGNoYXJ0VmFsdWVzKCkgewogICAgICByZXR1cm4gdGhpcy52YWx1ZS5zcGVjLnJrZUNvbmZpZy5jaGFydFZhbHVlczsKICAgIH0sCgogICAgc2VydmVyQ29uZmlnKCkgewogICAgICByZXR1cm4gdGhpcy52YWx1ZS5zcGVjLnJrZUNvbmZpZy5tYWNoaW5lR2xvYmFsQ29uZmlnOwogICAgfSwKCiAgICBhZ2VudENvbmZpZygpIHsKICAgICAgcmV0dXJuIHRoaXMudmFsdWUuYWdlbnRDb25maWc7CiAgICB9LAoKICAgIC8qKgogICAgICogRGVmaW5lIFBTUCBkZXByZWNhdGlvbiBhbmQgcmVzdHJpY3QgdXNlIG9mIFBTUCBiYXNlZCBvbiBtaW4gazhzIHZlcnNpb24KICAgICAqLwogICAgbmVlZHNQU1AoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE5lZWRzUFNQKCk7CiAgICB9LAoKICAgIC8qKgogICAgICogRGVmaW5lIGludHJvZHVjdGlvbiBvZiBSYW5jaGVyIGRlZmluZWQgUFNBIHRlbXBsYXRlcwogICAgICovCiAgICBoYXNQc2FUZW1wbGF0ZXMoKSB7CiAgICAgIHJldHVybiAhdGhpcy5uZWVkc1BTUDsKICAgIH0sCgogICAgdW5zdXBwb3J0ZWRTZWxlY3RvckNvbmZpZygpIHsKICAgICAgbGV0IGdsb2JhbCA9IDA7CiAgICAgIGxldCBrdWJlbGV0T25seSA9IDA7CiAgICAgIGxldCBvdGhlciA9IDA7CgogICAgICAvLyBUaGUgZm9ybSBzdXBwb3J0cyBvbmUgY29uZmlnIHRoYXQgaGFzIG5vIHNlbGVjdG9yIGZvciBhbGwgdGhlIG1haW4gcGFydHMKICAgICAgLy8gQW5kIG9uZSBvciBtb3JlIGNvbmZpZ3MgdGhhdCBoYXZlIGEgc2VsZWN0b3IgYW5kIGV4YWN0bHkgb25seSBrdWJlbGV0LWFyZ3MuCiAgICAgIC8vIElmIHRoZXJlIGFyZSBhbnkgb3RoZXIgcHJvcGVydGllcyBzZXQsIG9yIG11bHRpcGxlIGNvbmZpZ3Mgd2l0aCBubyBzZWxlY3RvcgogICAgICAvLyBzaG93IGEgd2FybmluZyB0aGF0IHlvdSdyZSBlZGl0aW5nIG9ubHkgcGFydCBvZiB0aGUgY29uZmlnIGluIHRoZSBVSS4KCiAgICAgIGZvciAoIGNvbnN0IGNvbmYgb2YgdGhpcy52YWx1ZS5zcGVjPy5ya2VDb25maWc/Lm1hY2hpbmVTZWxlY3RvckNvbmZpZyApIHsKICAgICAgICBpZiAoIGNvbmYubWFjaGluZUxhYmVsU2VsZWN0b3IgKSB7CiAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoY29uZi5jb25maWcgfHwge30pOwoKICAgICAgICAgIGlmICgga2V5cy5sZW5ndGggPT09IDAgfHwgKGtleXMubGVuZ3RoID09PSAxICYmIGtleXNbMF0gPT09ICdrdWJlbGV0LWFyZycpICkgewogICAgICAgICAgICBrdWJlbGV0T25seSsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3RoZXIrKzsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2xvYmFsKys7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZQogICAgICBjb25zb2xlLmxvZyhgR2xvYmFsOiAkeyBnbG9iYWwgfSwgS3ViZWxldCBPbmx5OiAkeyBrdWJlbGV0T25seSB9LCBPdGhlcjogJHsgb3RoZXIgfWApOwoKICAgICAgcmV0dXJuICggZ2xvYmFsID4gMSB8fCBvdGhlciA+IDAgKTsKICAgIH0sCgogICAgdmVyc2lvbk9wdGlvbnMoKSB7CiAgICAgIGNvbnN0IGN1ciA9IHRoaXMubGl2ZVZhbHVlPy5zcGVjPy5rdWJlcm5ldGVzVmVyc2lvbiB8fCAnJzsKICAgICAgY29uc3QgZXhpc3RpbmdSa2UyID0gdGhpcy5tb2RlID09PSBfRURJVCAmJiBjdXIuaW5jbHVkZXMoJ3JrZTInKTsKICAgICAgY29uc3QgZXhpc3RpbmdLM3MgPSB0aGlzLm1vZGUgPT09IF9FRElUICYmIGN1ci5pbmNsdWRlcygnazNzJyk7CgogICAgICBsZXQgYWxsVmFsaWRSa2UyVmVyc2lvbnMgPSB0aGlzLmdldEFsbE9wdGlvbnNBZnRlckN1cnJlbnRWZXJzaW9uKHRoaXMucmtlMlZlcnNpb25zLCAoZXhpc3RpbmdSa2UyID8gY3VyIDogbnVsbCksIHRoaXMuZGVmYXVsdFJrZTIpOwogICAgICBsZXQgYWxsVmFsaWRLM3NWZXJzaW9ucyA9IHRoaXMuZ2V0QWxsT3B0aW9uc0FmdGVyQ3VycmVudFZlcnNpb24odGhpcy5rM3NWZXJzaW9ucywgKGV4aXN0aW5nSzNzID8gY3VyIDogbnVsbCksIHRoaXMuZGVmYXVsdEszcyk7CgogICAgICBpZiAoIXRoaXMuc2hvd0RlcHJlY2F0ZWRQYXRjaFZlcnNpb25zKSB7CiAgICAgICAgLy8gTm9ybWFsbHksIHdlIG9ubHkgd2FudCB0byBzaG93IHRoZSBtb3N0IHJlY2VudCBwYXRjaCB2ZXJzaW9uCiAgICAgICAgLy8gZm9yIGVhY2ggS3ViZXJuZXRlcyBtaW5vciB2ZXJzaW9uLiBIb3dldmVyLCBpZiB0aGUgdXNlcgogICAgICAgIC8vIG9wdHMgaW4gdG8gc2hvd2luZyBkZXByZWNhdGVkIHZlcnNpb25zLCB3ZSBkb24ndCBmaWx0ZXIgdGhlbS4KICAgICAgICBhbGxWYWxpZFJrZTJWZXJzaW9ucyA9IHRoaXMuZmlsdGVyT3V0RGVwcmVjYXRlZFBhdGNoVmVyc2lvbnMoYWxsVmFsaWRSa2UyVmVyc2lvbnMsIGN1cik7CiAgICAgICAgYWxsVmFsaWRLM3NWZXJzaW9ucyA9IHRoaXMuZmlsdGVyT3V0RGVwcmVjYXRlZFBhdGNoVmVyc2lvbnMoYWxsVmFsaWRLM3NWZXJzaW9ucywgY3VyKTsKICAgICAgfQoKICAgICAgY29uc3Qgc2hvd1JrZTIgPSBhbGxWYWxpZFJrZTJWZXJzaW9ucy5sZW5ndGggJiYgIWV4aXN0aW5nSzNzOwogICAgICBjb25zdCBzaG93SzNzID0gYWxsVmFsaWRLM3NWZXJzaW9ucy5sZW5ndGggJiYgIWV4aXN0aW5nUmtlMjsKICAgICAgY29uc3Qgb3V0ID0gW107CgogICAgICBpZiAoIHNob3dSa2UyICkgewogICAgICAgIGlmICggc2hvd0szcyApIHsKICAgICAgICAgIG91dC5wdXNoKHsga2luZDogJ2dyb3VwJywgbGFiZWw6IHRoaXMudCgnY2x1c3Rlci5wcm92aWRlci5ya2UyJykgfSk7CiAgICAgICAgfQoKICAgICAgICBvdXQucHVzaCguLi5hbGxWYWxpZFJrZTJWZXJzaW9ucyk7CiAgICAgIH0KCiAgICAgIGlmICggc2hvd0szcyApIHsKICAgICAgICBpZiAoIHNob3dSa2UyICkgewogICAgICAgICAgb3V0LnB1c2goeyBraW5kOiAnZ3JvdXAnLCBsYWJlbDogdGhpcy50KCdjbHVzdGVyLnByb3ZpZGVyLmszcycpIH0pOwogICAgICAgIH0KCiAgICAgICAgb3V0LnB1c2goLi4uYWxsVmFsaWRLM3NWZXJzaW9ucyk7CiAgICAgIH0KCiAgICAgIGlmICggY3VyICkgewogICAgICAgIGNvbnN0IGV4aXN0aW5nID0gb3V0LmZpbmQoKHgpID0+IHgudmFsdWUgPT09IGN1cik7CgogICAgICAgIGlmICggZXhpc3RpbmcgKSB7CiAgICAgICAgICBleGlzdGluZy5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG91dDsKICAgIH0sCgogICAgaXNLM3MoKSB7CiAgICAgIHJldHVybiAodGhpcy52YWx1ZT8uc3BlYz8ua3ViZXJuZXRlc1ZlcnNpb24gfHwgJycpLmluY2x1ZGVzKCdrM3MnKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBLdWJlIFZlcnNpb24KICAgICAqLwogICAgc2VsZWN0ZWRWZXJzaW9uKCkgewogICAgICBjb25zdCBzdHIgPSB0aGlzLnZhbHVlLnNwZWMua3ViZXJuZXRlc1ZlcnNpb247CgogICAgICBpZiAoICFzdHIgKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBvdXQgPSBmaW5kQnkodGhpcy52ZXJzaW9uT3B0aW9ucywgJ3ZhbHVlJywgc3RyKTsKCiAgICAgIHJldHVybiBvdXQ7CiAgICB9LAoKICAgIGhhdmVBcmdJbmZvKCkgewogICAgICByZXR1cm4gQm9vbGVhbih0aGlzLnNlbGVjdGVkVmVyc2lvbj8uc2VydmVyQXJncyAmJiB0aGlzLnNlbGVjdGVkVmVyc2lvbj8uYWdlbnRBcmdzKTsKICAgIH0sCgogICAgc2VydmVyQXJncygpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0ZWRWZXJzaW9uPy5zZXJ2ZXJBcmdzIHx8IHt9OwogICAgfSwKCiAgICBhZ2VudEFyZ3MoKSB7CiAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkVmVyc2lvbj8uYWdlbnRBcmdzIHx8IHt9OwogICAgfSwKCiAgICAvKioKICAgICAqIFRoZSBhZGRvbnMgKGt1YmUgY2hhcnRzKSBhcHBsaWNhYmxlIGZvciB0aGUgc2VsZWN0ZWQga3ViZSB2ZXJzaW9uCiAgICAgKgogICAgICogeyBbY2hhcnROYW1lOnN0cmluZ106IHsgcmVwbzogc3RyaW5nLCB2ZXJzaW9uOiBzdHJpbmcgfSB9CiAgICAgKi8KICAgIGNoYXJ0VmVyc2lvbnMoKSB7CiAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkVmVyc2lvbj8uY2hhcnRzIHx8IHt9OwogICAgfSwKCiAgICBuZWVkQ3JlZGVudGlhbCgpIHsKICAgICAgaWYgKCB0aGlzLnByb3ZpZGVyID09PSAnY3VzdG9tJyB8fCB0aGlzLnByb3ZpZGVyID09PSAnaW1wb3J0JyB8fCB0aGlzLmlzRWxlbWVudGFsQ2x1c3RlciB8fCB0aGlzLm1vZGUgPT09IF9WSUVXICkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuY3VzdG9tQ3JlZGVudGlhbENvbXBvbmVudFJlcXVpcmVkID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIC8qKgogICAgICogT25seSBmb3IgZXh0ZW5zaW9ucyAtIGV4dGVuc2lvbiBjYW4gcmVnaXN0ZXIgYSAnZmFsc2UnIGNsb3VkIGNyZWRlbnRpYWwgdG8gaW5kaWNhdGUgdGhhdCBhIGNsb3VkIGNyZWRlbnRpYWwgaXMgbm90IG5lZWRlZAogICAgICovCiAgICBjdXN0b21DcmVkZW50aWFsQ29tcG9uZW50UmVxdWlyZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLiRwbHVnaW4uZ2V0RHluYW1pYygnY2xvdWQtY3JlZGVudGlhbCcsIHRoaXMucHJvdmlkZXIpOwogICAgfSwKCiAgICBoYXNNYWNoaW5lUG9vbHMoKSB7CiAgICAgIGlmICggdGhpcy5wcm92aWRlciA9PT0gJ2N1c3RvbScgfHwgdGhpcy5wcm92aWRlciA9PT0gJ2ltcG9ydCcgKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgdW5yZW1vdmVkTWFjaGluZVBvb2xzKCkgewogICAgICByZXR1cm4gKHRoaXMubWFjaGluZVBvb2xzIHx8IFtdKS5maWx0ZXIoKHgpID0+ICF4LnJlbW92ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogRXh0ZW5zaW9uIHByb3ZpZGVyIHdoZXJlIGJlaW5nIHByb3Zpc2lvbmVkIGJ5IGFuIGV4dGVuc2lvbgogICAgICovCiAgICBleHRlbnNpb25Qcm92aWRlcigpIHsKICAgICAgY29uc3QgZXh0Q2xhc3MgPSB0aGlzLiRwbHVnaW4uZ2V0RHluYW1pYygncHJvdmlzaW9uZXInLCB0aGlzLnByb3ZpZGVyKTsKCiAgICAgIGlmIChleHRDbGFzcykgewogICAgICAgIHJldHVybiBuZXcgZXh0Q2xhc3MoewogICAgICAgICAgZGlzcGF0Y2g6IHRoaXMuJHN0b3JlLmRpc3BhdGNoLAogICAgICAgICAgZ2V0dGVyczogIHRoaXMuJHN0b3JlLmdldHRlcnMsCiAgICAgICAgICBheGlvczogICAgdGhpcy4kc3RvcmUuJGF4aW9zLAogICAgICAgICAgJHBsdWdpbjogIHRoaXMuJHN0b3JlLmFwcC4kcGx1Z2luLAogICAgICAgICAgJHQ6ICAgICAgIHRoaXMudCwKICAgICAgICAgIGlzQ3JlYXRlOiB0aGlzLmlzQ3JlYXRlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9LAoKICAgIC8qKgogICAgICogSXMgYSBuYW1lc3BhY2UgbmVlZGVkPyBPbmx5IHN1cHBvcnRlZCBmb3IgcHJvdmlkZXJzIGZyb20gZXh0ZW5zaW9ucywgb3RoZXJ3aXNlIGRlZmF1bHQgaXMgbm8KICAgICAqLwogICAgbmVlZHNOYW1lc3BhY2UoKSB7CiAgICAgIHJldHVybiB0aGlzLmV4dGVuc2lvblByb3ZpZGVyID8gISF0aGlzLmV4dGVuc2lvblByb3ZpZGVyLm5hbWVzcGFjZWQgOiBmYWxzZTsKICAgIH0sCgogICAgbWFjaGluZUNvbmZpZ1NjaGVtYSgpIHsKICAgICAgbGV0IHNjaGVtYTsKCiAgICAgIGlmICggIXRoaXMuaGFzTWFjaGluZVBvb2xzICkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNFbGVtZW50YWxDbHVzdGVyKSB7CiAgICAgICAgc2NoZW1hID0gRUxFTUVOVEFMX1NDSEVNQV9JRFMuTUFDSElORV9JTlZfU0VMRUNUT1JfVEVNUExBVEVTOwogICAgICB9IGVsc2UgewogICAgICAgIHNjaGVtYSA9IGAkeyBDQVBJLk1BQ0hJTkVfQ09ORklHX0dST1VQIH0uJHsgdGhpcy5wcm92aWRlciB9Y29uZmlnYDsKICAgICAgfQoKICAgICAgLy8gSWYgdGhpcyBpcyBhbiBleHRlbnNpb24gcHJvdmlkZXIgdGhlbiB0aGUgZXh0ZW5zaW9uIGNhbiBwcm92aWRlIHRoZSBzY2hlbWEKICAgICAgY29uc3QgZXh0ZW5zaW9uU2NoZW1hID0gdGhpcy5leHRlbnNpb25Qcm92aWRlcj8ubWFjaGluZUNvbmZpZ1NjaGVtYTsKCiAgICAgIGlmIChleHRlbnNpb25TY2hlbWEpIHsKICAgICAgICAvLyBtYWNoaW5lQ29uZmlnU2NoZW1hIGNhbiBlaXRoZXIgYmUgdGhlIHNjaGVtYSBuYW1lIChzdHJpbmcpIG9yIHRoZSBzY2hlbWEgaXRzZWxmIChvYmplY3QpCiAgICAgICAgaWYgKHR5cGVvZiBleHRlbnNpb25TY2hlbWEgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICByZXR1cm4gZXh0ZW5zaW9uU2NoZW1hOwogICAgICAgIH0KCiAgICAgICAgLy8gTmFtZSBvZiBzY2hlbWEgdG8gdXNlCiAgICAgICAgc2NoZW1hID0gZXh0ZW5zaW9uU2NoZW1hOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy4kc3RvcmUuZ2V0dGVyc1snbWFuYWdlbWVudC9zY2hlbWFGb3InXShzY2hlbWEpOwogICAgfSwKCiAgICBub2RlVG90YWxzKCkgewogICAgICBjb25zdCByb2xlcyA9IFsnZXRjZCcsICdjb250cm9sUGxhbmUnLCAnd29ya2VyJ107CiAgICAgIGNvbnN0IGNvdW50cyA9IHt9OwogICAgICBjb25zdCBvdXQgPSB7CiAgICAgICAgY29sb3I6ICAge30sCiAgICAgICAgbGFiZWw6ICAge30sCiAgICAgICAgaWNvbjogICAge30sCiAgICAgICAgdG9vbHRpcDoge30sCiAgICAgIH07CgogICAgICBmb3IgKCBjb25zdCByb2xlIG9mIHJvbGVzICkgewogICAgICAgIGNvdW50c1tyb2xlXSA9IDA7CiAgICAgICAgb3V0LmNvbG9yW3JvbGVdID0gTk9ERV9UT1RBTC5zdWNjZXNzLmNvbG9yOwogICAgICAgIG91dC5pY29uW3JvbGVdID0gTk9ERV9UT1RBTC5zdWNjZXNzLmljb247CiAgICAgIH0KCiAgICAgIGZvciAoIGNvbnN0IHJvdyBvZiB0aGlzLm1hY2hpbmVQb29scyB8fCBbXSApIHsKICAgICAgICBpZiAoIHJvdy5yZW1vdmUgKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHF0eSA9IHBhcnNlSW50KHJvdy5wb29sLnF1YW50aXR5LCAxMCk7CgogICAgICAgIGlmICggaXNOYU4ocXR5KSApIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgZm9yICggY29uc3Qgcm9sZSBvZiByb2xlcyApIHsKICAgICAgICAgIGNvdW50c1tyb2xlXSA9IGNvdW50c1tyb2xlXSArIChyb3cucG9vbFtgJHsgcm9sZSB9Um9sZWBdID8gcXR5IDogMCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKCBjb25zdCByb2xlIG9mIHJvbGVzICkgewogICAgICAgIG91dC5sYWJlbFtyb2xlXSA9IHRoaXMudChgY2x1c3Rlci5tYWNoaW5lUG9vbC5ub2RlVG90YWxzLmxhYmVsLiR7IHJvbGUgfWAsIHsgY291bnQ6IGNvdW50c1tyb2xlXSB9KTsKICAgICAgICBvdXQudG9vbHRpcFtyb2xlXSA9IHRoaXMudChgY2x1c3Rlci5tYWNoaW5lUG9vbC5ub2RlVG90YWxzLnRvb2x0aXAuJHsgcm9sZSB9YCwgeyBjb3VudDogY291bnRzW3JvbGVdIH0pOwogICAgICB9CgogICAgICBpZiAoIGNvdW50cy5ldGNkID09PSAwICkgewogICAgICAgIG91dC5jb2xvci5ldGNkID0gTk9ERV9UT1RBTC5lcnJvci5jb2xvcjsKICAgICAgICBvdXQuaWNvbi5ldGNkID0gTk9ERV9UT1RBTC5lcnJvci5pY29uOwogICAgICB9IGVsc2UgaWYgKCBjb3VudHMuZXRjZCA9PT0gMSB8fCBjb3VudHMuZXRjZCAlIDIgPT09IDAgfHwgY291bnRzLmV0Y2QgPiA3ICkgewogICAgICAgIG91dC5jb2xvci5ldGNkID0gTk9ERV9UT1RBTC53YXJuaW5nLmNvbG9yOwogICAgICAgIG91dC5pY29uLmV0Y2QgPSBOT0RFX1RPVEFMLndhcm5pbmcuaWNvbjsKICAgICAgfQoKICAgICAgaWYgKCBjb3VudHMuY29udHJvbFBsYW5lID09PSAwICkgewogICAgICAgIG91dC5jb2xvci5jb250cm9sUGxhbmUgPSBOT0RFX1RPVEFMLmVycm9yLmNvbG9yOwogICAgICAgIG91dC5pY29uLmNvbnRyb2xQbGFuZSA9IE5PREVfVE9UQUwuZXJyb3IuaWNvbjsKICAgICAgfSBlbHNlIGlmICggY291bnRzLmNvbnRyb2xQbGFuZSA9PT0gMSApIHsKICAgICAgICBvdXQuY29sb3IuY29udHJvbFBsYW5lID0gTk9ERV9UT1RBTC53YXJuaW5nLmNvbG9yOwogICAgICAgIG91dC5pY29uLmNvbnRyb2xQbGFuZSA9IE5PREVfVE9UQUwud2FybmluZy5pY29uOwogICAgICB9CgogICAgICBpZiAoIGNvdW50cy53b3JrZXIgPT09IDAgKSB7CiAgICAgICAgb3V0LmNvbG9yLndvcmtlciA9IE5PREVfVE9UQUwuZXJyb3IuY29sb3I7CiAgICAgICAgb3V0Lmljb24ud29ya2VyID0gTk9ERV9UT1RBTC5lcnJvci5pY29uOwogICAgICB9IGVsc2UgaWYgKCBjb3VudHMud29ya2VyID09PSAxICkgewogICAgICAgIG91dC5jb2xvci53b3JrZXIgPSBOT0RFX1RPVEFMLndhcm5pbmcuY29sb3I7CiAgICAgICAgb3V0Lmljb24ud29ya2VyID0gTk9ERV9UT1RBTC53YXJuaW5nLmljb247CiAgICAgIH0KCiAgICAgIHJldHVybiBvdXQ7CiAgICB9LAoKICAgIHNob3dDbmkoKSB7CiAgICAgIHJldHVybiAhIXRoaXMuc2VydmVyQXJncy5jbmk7CiAgICB9LAoKICAgIHNob3dDbG91ZFByb3ZpZGVyKCkgewogICAgICByZXR1cm4gISF0aGlzLmFnZW50QXJnc1snY2xvdWQtcHJvdmlkZXItbmFtZSddOwogICAgfSwKCiAgICAvKioKICAgICAqIFRoZSBjaGFydCBuYW1lcyBvZiB0aGUgYWRkb25zIGFwcGxpY2FibGUgdG8gdGhlIGN1cnJlbnQga3ViZSB2ZXJzaW9uIGFuZCBzZWxlY3RlZCBjbG91ZCBwcm92aWRlcgogICAgICovCiAgICBhZGRvbk5hbWVzKCkgewogICAgICBjb25zdCBuYW1lcyA9IFtdOwogICAgICBjb25zdCBjbmkgPSB0aGlzLnNlcnZlckNvbmZpZy5jbmk7CgogICAgICBpZiAodHlwZW9mIGNuaSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBuYW1lcy5wdXNoKC4uLmNuaS5zcGxpdCgnLCcpLm1hcCgoeCkgPT4gYHJrZTItJHsgeCB9YCkpOwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoY25pKSkgewogICAgICAgIG5hbWVzLnB1c2goLi4uY25pLm1hcCgoeCkgPT4gYHJrZTItJHsgeCB9YCkpOwogICAgICB9CgogICAgICBpZiAodGhpcy5zaG93Q2xvdWRQcm92aWRlcikgeyAvLyBTaG91bGRuJ3QgYmUgcmVtb3ZlZCBzdWNoIHRoYXQgY2hhbmdlcyB0byBpdCB3aWxsIHJlLXRyaWdnZXIgdGhpcyB3YXRjaAogICAgICAgIGlmICggdGhpcy5hZ2VudENvbmZpZ1snY2xvdWQtcHJvdmlkZXItbmFtZSddID09PSAncmFuY2hlci12c3BoZXJlJyApIHsKICAgICAgICAgIG5hbWVzLnB1c2goJ3JhbmNoZXItdnNwaGVyZS1jcGknLCAncmFuY2hlci12c3BoZXJlLWNzaScpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCB0aGlzLmFnZW50Q29uZmlnWydjbG91ZC1wcm92aWRlci1uYW1lJ10gPT09IEhBUlZFU1RFUiApIHsKICAgICAgICAgIG5hbWVzLnB1c2goSEFSVkVTVEVSX0NMT1VEX1BST1ZJREVSKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBuYW1lczsKICAgIH0sCgogICAgLyoqCiAgICAgKiBUaGUgY2hhcnRzIG9mIHRoZSBhZGRvbnMgYXBwbGljYWJsZSB0byB0aGUgY3VycmVudCBrdWJlIHZlcnNpb24gYW5kIHNlbGVjdGVkIGNsb3VkIHByb3ZpZGVyCiAgICAgKgogICAgICogVGhlc2UgYXJlIHRoZSBjaGFydHMgdGhlbXNlbHZlcyBhbmQgZG8gbm90IGluY2x1ZGUgY2hhcnQgcmVhZG1lIG9yIHZhbHVlcwogICAgICovCiAgICBhZGRvblZlcnNpb25zKCkgewogICAgICBjb25zdCB2ZXJzaW9ucyA9IHRoaXMuYWRkb25OYW1lcy5tYXAoKG5hbWUpID0+IHRoaXMudmVyc2lvbkluZm9bbmFtZV0/LmNoYXJ0KTsKCiAgICAgIHJldHVybiB2ZXJzaW9ucy5maWx0ZXIoKHgpID0+ICEheCk7CiAgICB9LAoKICAgIGNsb3VkUHJvdmlkZXJPcHRpb25zKCkgewogICAgICBjb25zdCBvdXQgPSBbewogICAgICAgIGxhYmVsOiB0aGlzLiRzdG9yZS5nZXR0ZXJzWydpMThuL3QnXSgnY2x1c3Rlci5ya2UyLmNsb3VkUHJvdmlkZXIuZGVmYXVsdFZhbHVlLmxhYmVsJyksCiAgICAgICAgdmFsdWU6ICcnLAogICAgICB9XTsKCiAgICAgIGlmICggISF0aGlzLmFnZW50QXJnc1snY2xvdWQtcHJvdmlkZXItbmFtZSddPy5vcHRpb25zICkgewogICAgICAgIGNvbnN0IHByZWZlcnJlZCA9IHRoaXMuJHN0b3JlLmdldHRlcnNbJ3BsdWdpbnMvY2xvdWRQcm92aWRlckZvckRyaXZlciddKHRoaXMucHJvdmlkZXIpOwoKICAgICAgICBmb3IgKCBjb25zdCBvcHQgb2YgdGhpcy5hZ2VudEFyZ3NbJ2Nsb3VkLXByb3ZpZGVyLW5hbWUnXT8ub3B0aW9ucyApIHsKICAgICAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIGEgcHJlZmVycmVkIHByb3ZpZGVyLi4uIHNob3cgYWxsIG9wdGlvbnMKICAgICAgICAgIGNvbnN0IHNob3dBbGxPcHRpb25zID0gcHJlZmVycmVkID09PSB1bmRlZmluZWQ7CiAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGEgcHJlZmVycmVkIHByb3ZpZGVyLi4uIG9ubHkgc2hvdyBkZWZhdWx0LCBwcmVmZXJyZWQgYW5kIGV4dGVybmFsCiAgICAgICAgICBjb25zdCBpc1ByZWZlcnJlZCA9IG9wdCA9PT0gcHJlZmVycmVkOwogICAgICAgICAgY29uc3QgaXNFeHRlcm5hbCA9IG9wdCA9PT0gJ2V4dGVybmFsJzsKICAgICAgICAgIGxldCBkaXNhYmxlZCA9IGZhbHNlOwoKICAgICAgICAgIGlmICgodGhpcy5pc0hhcnZlc3RlckV4dGVybmFsQ3JlZGVudGlhbCB8fCB0aGlzLmlzSGFydmVzdGVySW5jb21wYXRpYmxlKSAmJiBpc1ByZWZlcnJlZCkgewogICAgICAgICAgICBkaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHNob3dBbGxPcHRpb25zIHx8IGlzUHJlZmVycmVkIHx8IGlzRXh0ZXJuYWwpIHsKICAgICAgICAgICAgb3V0LnB1c2goewogICAgICAgICAgICAgIGxhYmVsOiB0aGlzLiRzdG9yZS5nZXR0ZXJzWydpMThuL3dpdGhGYWxsYmFjayddKGBjbHVzdGVyLmNsb3VkUHJvdmlkZXIuIiR7IG9wdCB9Ii5sYWJlbGAsIG51bGwsIG9wdCksCiAgICAgICAgICAgICAgdmFsdWU6IG9wdCwKICAgICAgICAgICAgICBkaXNhYmxlZCwKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBjdXIgPSB0aGlzLmFnZW50Q29uZmlnWydjbG91ZC1wcm92aWRlci1uYW1lJ107CgogICAgICBpZiAoY3VyICYmICFvdXQuZmluZCgoeCkgPT4geC52YWx1ZSA9PT0gY3VyKSkgewogICAgICAgIC8vIExvY2FsaXphdGlvbiBtaXNzaW5nCiAgICAgICAgLy8gTG9vayB1cCBjdXIgaW4gdGhlIGxvY2FsaXphdGlvbiBmaWxlCiAgICAgICAgY29uc3QgbGFiZWwgPSB0aGlzLiRzdG9yZS5nZXR0ZXJzWydpMThuL3dpdGhGYWxsYmFjayddKGBjbHVzdGVyLmNsb3VkUHJvdmlkZXIuIiR7IGN1ciB9Ii5sYWJlbGAsIG51bGwsIGN1cik7CgogICAgICAgIG91dC51bnNoaWZ0KHsKICAgICAgICAgIGxhYmVsOiAgICAgICBgJHsgbGFiZWwgfSAoQ3VycmVudClgLAogICAgICAgICAgdmFsdWU6ICAgICAgIGN1ciwKICAgICAgICAgIHVuc3VwcG9ydGVkOiB0cnVlLAogICAgICAgICAgZGlzYWJsZWQ6ICAgIHRydWUKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgY29uc3QgaW5pdGlhbCA9IHRoaXMuaW5pdGlhbENsb3VkUHJvdmlkZXI7CgogICAgICBpZiAoY3VyICE9PSBpbml0aWFsICYmIGluaXRpYWwgJiYgIW91dC5maW5kKCh4KSA9PiB4LnZhbHVlID09PSBpbml0aWFsKSkgewogICAgICAgIGNvbnN0IGxhYmVsID0gdGhpcy4kc3RvcmUuZ2V0dGVyc1snaTE4bi93aXRoRmFsbGJhY2snXShgY2x1c3Rlci5jbG91ZFByb3ZpZGVyLiIkeyBpbml0aWFsIH0iLmxhYmVsYCwgbnVsbCwgaW5pdGlhbCk7CgogICAgICAgIG91dC51bnNoaWZ0KHsKICAgICAgICAgIGxhYmVsOiAgICAgICBgJHsgbGFiZWwgfSAoQ3VycmVudClgLAogICAgICAgICAgdmFsdWU6ICAgICAgIGluaXRpYWwsCiAgICAgICAgICB1bnN1cHBvcnRlZDogdHJ1ZSwKICAgICAgICAgIGRpc2FibGVkOiAgICB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBvdXQ7CiAgICB9LAoKICAgIGNhbk1hbmFnZU1lbWJlcnMoKSB7CiAgICAgIHJldHVybiBjYW5WaWV3Q2x1c3Rlck1lbWJlcnNoaXBFZGl0b3IodGhpcy4kc3RvcmUpOwogICAgfSwKCiAgICBpc0hhcnZlc3RlckRyaXZlcigpIHsKICAgICAgcmV0dXJuIHRoaXMuJHJvdXRlLnF1ZXJ5LnR5cGUgPT09IEhBUlZFU1RFUjsKICAgIH0sCgogICAgZGVmYXVsdFZlcnNpb24oKSB7CiAgICAgIGNvbnN0IGFsbCA9IHRoaXMudmVyc2lvbk9wdGlvbnMuZmlsdGVyKCh4KSA9PiAhIXgudmFsdWUpOwogICAgICBjb25zdCBmaXJzdCA9IGFsbFswXT8udmFsdWU7CiAgICAgIGNvbnN0IHByZWZlcnJlZCA9IGFsbC5maW5kKCh4KSA9PiB4LnZhbHVlID09PSB0aGlzLmRlZmF1bHRSa2UyKT8udmFsdWU7CgogICAgICBjb25zdCBya2UyID0gdGhpcy5nZXRBbGxPcHRpb25zQWZ0ZXJDdXJyZW50VmVyc2lvbih0aGlzLnJrZTJWZXJzaW9ucywgbnVsbCk7CiAgICAgIGNvbnN0IHNob3dSa2UyID0gcmtlMi5sZW5ndGg7CiAgICAgIGxldCBvdXQ7CgogICAgICBpZiAodGhpcy5pc0hhcnZlc3RlckRyaXZlciAmJiBzaG93UmtlMikgewogICAgICAgIGNvbnN0IHNhdGlzZmllc1ZlcnNpb24gPSBya2UyLmZpbHRlcigodikgPT4gewogICAgICAgICAgcmV0dXJuIGlzSGFydmVzdGVyU2F0aXNmaWVzVmVyc2lvbih2LnZhbHVlKTsKICAgICAgICB9KSB8fCBbXTsKCiAgICAgICAgaWYgKHNhdGlzZmllc1ZlcnNpb24ubGVuZ3RoID4gMCkgewogICAgICAgICAgb3V0ID0gc2F0aXNmaWVzVmVyc2lvblswXT8udmFsdWU7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoICFvdXQgKSB7CiAgICAgICAgb3V0ID0gcHJlZmVycmVkIHx8IGZpcnN0OwogICAgICB9CgogICAgICByZXR1cm4gb3V0OwogICAgfSwKCiAgICBzaG93SXB2Nldhcm5pbmcoKSB7CiAgICAgIGNvbnN0IGNsdXN0ZXJDSURSID0gdGhpcy5zZXJ2ZXJDb25maWdbJ2NsdXN0ZXItY2lkciddIHx8ICcnOwogICAgICBjb25zdCBzZXJ2aWNlQ0lEUiA9IHRoaXMuc2VydmVyQ29uZmlnWydzZXJ2aWNlLWNpZHInXSB8fCAnJzsKCiAgICAgIHJldHVybiBjbHVzdGVyQ0lEUi5pbmNsdWRlcygnOicpIHx8IHNlcnZpY2VDSURSLmluY2x1ZGVzKCc6Jyk7CiAgICB9LAoKICAgIGFwcHNPU1dhcm5pbmcoKSB7CiAgICAgIGlmICh0aGlzLm1vZGUgIT09IF9FRElUICkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGNvbnN0IHsgbGludXhXb3JrZXJDb3VudCwgd2luZG93c1dvcmtlckNvdW50IH0gPSB0aGlzLnZhbHVlPy5tZ210Py5zdGF0dXMgfHwge307CgogICAgICBpZiAoIXdpbmRvd3NXb3JrZXJDb3VudCkgewogICAgICAgIGlmICghIXRoaXMubWFjaGluZVBvb2xzLmZpbmQoKHBvb2wpID0+IHsKICAgICAgICAgIHJldHVybiBwb29sPy5jb25maWc/Lm9zID09PSAnd2luZG93cyc7CiAgICAgICAgfSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnQoJ2NsdXN0ZXIuYmFubmVyLm9zJywgeyBuZXdPUzogJ1dpbmRvd3MnLCBleGlzdGluZ09TOiAnTGludXgnIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghbGludXhXb3JrZXJDb3VudCkgewogICAgICAgIGlmICh0aGlzLm1hY2hpbmVQb29scy5maW5kKChwb29sKSA9PiB7CiAgICAgICAgICByZXR1cm4gcG9vbD8uY29uZmlnPy5vcyA9PT0gJ2xpbnV4JzsKICAgICAgICB9KSkgewogICAgICAgICAgcmV0dXJuIHRoaXMudCgnY2x1c3Rlci5iYW5uZXIub3MnLCB7IG5ld09TOiAnTGludXgnLCBleGlzdGluZ09TOiAnV2luZG93cycgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgc2hvd0Zvcm0oKSB7CiAgICAgIHJldHVybiAhIXRoaXMuY3JlZGVudGlhbElkIHx8ICF0aGlzLm5lZWRDcmVkZW50aWFsOwogICAgfSwKCiAgICBpc0hhcnZlc3RlckV4dGVybmFsQ3JlZGVudGlhbCgpIHsKICAgICAgcmV0dXJuIHRoaXMuY3JlZGVudGlhbD8uaGFydmVzdGVyY3JlZGVudGlhbENvbmZpZz8uY2x1c3RlclR5cGUgPT09ICdleHRlcm5hbCc7CiAgICB9LAoKICAgIGlzSGFydmVzdGVySW5jb21wYXRpYmxlKCkgewogICAgICBsZXQgY2NtUmtlMlZlcnNpb24gPSAodGhpcy5jaGFydFZlcnNpb25zWydoYXJ2ZXN0ZXItY2xvdWQtcHJvdmlkZXInXSB8fCB7fSlbJ3ZlcnNpb24nXTsKICAgICAgbGV0IGNzaVJrZTJWZXJzaW9uID0gKHRoaXMuY2hhcnRWZXJzaW9uc1snaGFydmVzdGVyLWNzaS1kcml2ZXInXSB8fCB7fSlbJ3ZlcnNpb24nXTsKCiAgICAgIGNvbnN0IGNjbVZlcnNpb24gPSB0aGlzLmhhcnZlc3RlclZlcnNpb25SYW5nZT8uWydoYXJ2ZXN0ZXItY2xvdWQtcHJvdmlkZXInXTsKICAgICAgY29uc3QgY3NpVmVyc2lvbiA9IHRoaXMuaGFydmVzdGVyVmVyc2lvblJhbmdlPy5bJ2hhcnZlc3Rlci1jc2ktcHJvdmlkZXInXTsKCiAgICAgIGlmICgoY2NtUmtlMlZlcnNpb24gfHwgJycpLmVuZHNXaXRoKCcwMCcpKSB7CiAgICAgICAgY2NtUmtlMlZlcnNpb24gPSBjY21Sa2UyVmVyc2lvbi5zbGljZSgwLCAtMik7CiAgICAgIH0KCiAgICAgIGlmICgoY3NpUmtlMlZlcnNpb24gfHwgJycpLmVuZHNXaXRoKCcwMCcpKSB7CiAgICAgICAgY3NpUmtlMlZlcnNpb24gPSBjc2lSa2UyVmVyc2lvbi5zbGljZSgwLCAtMik7CiAgICAgIH0KCiAgICAgIGlmIChjY21WZXJzaW9uICYmIGNzaVZlcnNpb24pIHsKICAgICAgICBpZiAoc2VtdmVyLnNhdGlzZmllcyhjY21Sa2UyVmVyc2lvbiwgY2NtVmVyc2lvbikgJiYKICAgICAgICAgIHNlbXZlci5zYXRpc2ZpZXMoY3NpUmtlMlZlcnNpb24sIGNzaVZlcnNpb24pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCgogICAgdmFsaWRhdGlvblBhc3NlZCgpIHsKICAgICAgY29uc3QgdmFsaWRSZXF1aXJlZFBvb2xzID0gdGhpcy5oYXNNYWNoaW5lUG9vbHMgPyB0aGlzLmhhc1JlcXVpcmVkTm9kZXMoKSA6IHRydWU7CgogICAgICBsZXQgYmFzZSA9ICh0aGlzLnByb3ZpZGVyID09PSAnY3VzdG9tJyB8fCB0aGlzLmlzRWxlbWVudGFsQ2x1c3RlciB8fCAhIXRoaXMuY3JlZGVudGlhbElkIHx8ICF0aGlzLm5lZWRDcmVkZW50aWFsKTsKCiAgICAgIC8vIGFuZCBpbiBhbGwgb2YgdGhlIHZhbGlkYXRpb24gc3RhdHVzZXMgZm9yIGVhY2ggbWFjaGluZSBwb29sCiAgICAgIE9iamVjdC52YWx1ZXModGhpcy5tYWNoaW5lUG9vbFZhbGlkYXRpb24pLmZvckVhY2goKHYpID0+IChiYXNlID0gYmFzZSAmJiB2KSk7CgogICAgICByZXR1cm4gdmFsaWRSZXF1aXJlZFBvb2xzICYmIGJhc2U7CiAgICB9LAogICAgdW5zdXBwb3J0ZWRDbG91ZFByb3ZpZGVyKCkgewogICAgICAvLyBUaGUgY3VycmVudCBjbG91ZCBwcm92aWRlcgogICAgICBjb25zdCBjdXIgPSB0aGlzLmluaXRpYWxDbG91ZFByb3ZpZGVyOwoKICAgICAgY29uc3QgcHJvdmlkZXIgPSBjdXIgJiYgdGhpcy5jbG91ZFByb3ZpZGVyT3B0aW9ucy5maW5kKCh4KSA9PiB4LnZhbHVlID09PSBjdXIpOwoKICAgICAgcmV0dXJuICEhcHJvdmlkZXI/LnVuc3VwcG9ydGVkOwogICAgfSwKICB9LAoKICB3YXRjaDogewogICAgczNCYWNrdXAobmV1KSB7CiAgICAgIGlmICggbmV1ICkgewogICAgICAgIC8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgczMgZG9lc24ndCBhbHJlYWR5IGhhdmUgYW4gZXhpc3RpbmcgdmFsdWUgb3RoZXJ3aXNlIHdoZW4gZWRpdGluZyBhIGNsdXN0ZXIgd2l0aCBzMyBkZWZpbmVkIHRoaXMgd2lsbCBjbGVhciBzMy4KICAgICAgICBpZiAoaXNFbXB0eSh0aGlzLnJrZUNvbmZpZy5ldGNkPy5zMykpIHsKICAgICAgICAgIHNldCh0aGlzLnJrZUNvbmZpZy5ldGNkLCAnczMnLCB7fSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNldCh0aGlzLnJrZUNvbmZpZy5ldGNkLCAnczMnLCBudWxsKTsKICAgICAgfQogICAgfSwKCiAgICBjcmVkZW50aWFsSWQodmFsKSB7CiAgICAgIGlmICggdmFsICkgewogICAgICAgIHRoaXMuY3JlZGVudGlhbCA9IHRoaXMuJHN0b3JlLmdldHRlcnNbJ3JhbmNoZXIvYnlJZCddKE5PUk1BTi5DTE9VRF9DUkVERU5USUFMLCB0aGlzLmNyZWRlbnRpYWxJZCk7CgogICAgICAgIGlmICh0aGlzLmlzSGFydmVzdGVyRHJpdmVyKSB7CiAgICAgICAgICB0aGlzLnNldEhhcnZlc3RlclZlcnNpb25SYW5nZSgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNyZWRlbnRpYWwgPSBudWxsOwogICAgICB9CgogICAgICB0aGlzLnZhbHVlLnNwZWMuY2xvdWRDcmVkZW50aWFsU2VjcmV0TmFtZSA9IHZhbDsKICAgIH0sCgogICAgYWRkb25OYW1lcyhuZXUsIG9sZCkgewogICAgICAvLyBUbyBjYXRjaCB0aGUgJ3NvbWUgYWRkb25zJyAtLT4gJ25vIGFkZG9ucycgY2FzZSBhbHNvIGNoZWNrIGFycmF5IGxlbmd0aCAoYGRpZmZlcmVuY2UoW10sIFsxLDIsM10pID09PSBbXWApCiAgICAgIGNvbnN0IGRpZmYgPSBvbGQubGVuZ3RoICE9PSBuZXUubGVuZ3RoIHx8IGRpZmZlcmVuY2UobmV1LCBvbGQpLmxlbmd0aCA7CgogICAgICBpZiAoZGlmZikgewogICAgICAgIC8vIEFsbG93IHRpbWUgZm9yIGFkZG9uTmFtZXMgdG8gdXBkYXRlLi4uIHRoZW4gZmV0Y2ggYW55IG1pc3NpbmcgYWRkb25zCiAgICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gdGhpcy5pbml0QWRkb25zKCkpOwogICAgICB9CiAgICB9LAoKICAgIHNlbGVjdGVkVmVyc2lvbigpIHsKICAgICAgdGhpcy52ZXJzaW9uSW5mbyA9IHt9OyAvLyBJbnZhbGlkYXRlIGNhY2hlIHN1Y2ggdGhhdCB2ZXJzaW9uIGluZm8gcmVsZXZlbnQgdG8gc2VsZWN0ZWQga3ViZSB2ZXJzaW9uIGlzIHVwZGF0ZWQKCiAgICAgIC8vIEFsbG93IHRpbWUgZm9yIGFkZG9uTmFtZXMgdG8gdXBkYXRlLi4uIHRoZW4gZmV0Y2ggYW55IG1pc3NpbmcgYWRkb25zCiAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHRoaXMuaW5pdEFkZG9ucygpKTsKICAgICAgaWYgKHRoaXMubW9kZSA9PT0gX0NSRUFURSkgewogICAgICAgIHRoaXMuaW5pdFNlcnZlckFnZW50QXJncygpOwogICAgICB9CiAgICB9LAoKICAgIHNob3dDbmkobmV1KSB7CiAgICAgIC8vIFVwZGF0ZSBgc2VydmVyQ29uZmlnLmNuaSB0byByZWNhbGN1bGF0ZSBhZGRvbk5hbWVzLi4uCiAgICAgIC8vIC4uLiB3aGljaCB3aWxsIGV2ZW50dWFsbHkgdXBkYXRlIGB2YWx1ZS5zcGVjLnJrZUNvbmZpZy5jaGFydFZhbHVlc2AKICAgICAgaWYgKG5ldSkgewogICAgICAgIC8vIFR5cGUgc3VwcG9ydHMgQ05JLCBhc3NpZ24gZGVmYXVsdCBpZiB3ZSBjYW4KICAgICAgICBpZiAoIXRoaXMuc2VydmVyQ29uZmlnLmNuaSkgewogICAgICAgICAgY29uc3QgZGVmID0gdGhpcy5zZXJ2ZXJBcmdzLmNuaS5kZWZhdWx0OwoKICAgICAgICAgIHNldCh0aGlzLnNlcnZlckNvbmZpZywgJ2NuaScsIGRlZik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFR5cGUgZG9lc24ndCBzdXBwb3J0IGNuaSwgY2xlYXIgYGNuaWAKICAgICAgICBzZXQodGhpcy5zZXJ2ZXJDb25maWcsICdjbmknLCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9LAoKICAgIHNob3dDbG91ZFByb3ZpZGVyKG5ldSkgewogICAgICBpZiAoIW5ldSkgewogICAgICAgIC8vIE5vIGNsb3VkIHByb3ZpZGVyIGF2YWlsYWJsZT8gVGhlbiBjbGVhciBjbG91ZCBwcm92aWRlciBzZXR0aW5nLiBUaGlzIHdpbGwgcmVjYWxjdWxhdGUgYWRkb25OYW1lcy4uLgogICAgICAgIC8vIC4uLiB3aGljaCB3aWxsIGV2ZW50dWFsbHkgdXBkYXRlIGB2YWx1ZS5zcGVjLnJrZUNvbmZpZy5jaGFydFZhbHVlc2AKICAgICAgICBzZXQodGhpcy5hZ2VudENvbmZpZywgJ2Nsb3VkLXByb3ZpZGVyLW5hbWUnLCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9LAogIH0sCgogIGNyZWF0ZWQoKSB7CiAgICB0aGlzLnJlZ2lzdGVyQmVmb3JlSG9vayh0aGlzLnNhdmVNYWNoaW5lUG9vbHMsICdzYXZlLW1hY2hpbmUtcG9vbHMnLCAxKTsKICAgIHRoaXMucmVnaXN0ZXJCZWZvcmVIb29rKHRoaXMuc2V0UmVnaXN0cnlDb25maWcsICdzZXQtcmVnaXN0cnktY29uZmlnJyk7CiAgICB0aGlzLnJlZ2lzdGVyQWZ0ZXJIb29rKHRoaXMuY2xlYW51cE1hY2hpbmVQb29scywgJ2NsZWFudXAtbWFjaGluZS1wb29scycpOwogICAgdGhpcy5yZWdpc3RlckFmdGVySG9vayh0aGlzLnNhdmVSb2xlQmluZGluZ3MsICdzYXZlLXJvbGUtYmluZGluZ3MnKTsKCiAgICAvLyBSZWdpc3RlciBhbnkgaG9va3MgZm9yIHRoaXMgZXh0ZW5zaW9uIHByb3ZpZGVyCiAgICBpZiAodGhpcy5leHRlbnNpb25Qcm92aWRlcj8ucmVnaXN0ZXJTYXZlSG9va3MpIHsKICAgICAgdGhpcy5leHRlbnNpb25Qcm92aWRlci5yZWdpc3RlclNhdmVIb29rcyh0aGlzLnJlZ2lzdGVyQmVmb3JlSG9vaywgdGhpcy5yZWdpc3RlckFmdGVySG9vaywgdGhpcy52YWx1ZSk7CiAgICB9CiAgfSwKCiAgbWV0aG9kczogewogICAgc2V0LAoKICAgIC8qKgogICAgICogSW5pdGlhbGl6ZSBhbGwgdGhlIGNsdXN0ZXIgc3BlY3MKICAgICAqLwogICAgYXN5bmMgaW5pdFNwZWNzKCkgewogICAgICBpZiAoICF0aGlzLnZhbHVlLnNwZWMgKSB7CiAgICAgICAgc2V0KHRoaXMudmFsdWUsICdzcGVjJywge30pOwogICAgICB9CgogICAgICBpZiAoICF0aGlzLnZhbHVlLnNwZWMubWFjaGluZVNlbGVjdG9yQ29uZmlnICkgewogICAgICAgIHNldCh0aGlzLnZhbHVlLnNwZWMsICdtYWNoaW5lU2VsZWN0b3JDb25maWcnLCBbXSk7CiAgICAgIH0KCiAgICAgIGlmICggIXRoaXMudmFsdWUuc3BlYy5tYWNoaW5lU2VsZWN0b3JDb25maWcuZmluZCgoeCkgPT4gIXgubWFjaGluZUxhYmVsU2VsZWN0b3IpICkgewogICAgICAgIHRoaXMudmFsdWUuc3BlYy5tYWNoaW5lU2VsZWN0b3JDb25maWcudW5zaGlmdCh7IGNvbmZpZzoge30gfSk7CiAgICAgIH0KCiAgICAgIGlmICggdGhpcy52YWx1ZS5zcGVjLmNsb3VkQ3JlZGVudGlhbFNlY3JldE5hbWUgKSB7CiAgICAgICAgYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ3JhbmNoZXIvZmluZEFsbCcsIHsgdHlwZTogTk9STUFOLkNMT1VEX0NSRURFTlRJQUwgfSk7CiAgICAgICAgdGhpcy5jcmVkZW50aWFsSWQgPSBgJHsgdGhpcy52YWx1ZS5zcGVjLmNsb3VkQ3JlZGVudGlhbFNlY3JldE5hbWUgfWA7CiAgICAgIH0KCiAgICAgIGlmICggIXRoaXMudmFsdWUuc3BlYy5rdWJlcm5ldGVzVmVyc2lvbiApIHsKICAgICAgICBzZXQodGhpcy52YWx1ZS5zcGVjLCAna3ViZXJuZXRlc1ZlcnNpb24nLCB0aGlzLmRlZmF1bHRWZXJzaW9uKTsKICAgICAgfQoKICAgICAgaWYgKCB0aGlzLnJrZUNvbmZpZy5ldGNkPy5zMz8uYnVja2V0ICkgewogICAgICAgIHRoaXMuczNCYWNrdXAgPSB0cnVlOwogICAgICB9CgogICAgICBpZiAoICF0aGlzLnJrZUNvbmZpZy5ldGNkICkgewogICAgICAgIHNldCh0aGlzLnJrZUNvbmZpZywgJ2V0Y2QnLCB7CiAgICAgICAgICBkaXNhYmxlU25hcHNob3RzOiAgICAgZmFsc2UsCiAgICAgICAgICBzMzogICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgIHNuYXBzaG90UmV0ZW50aW9uOiAgICA1LAogICAgICAgICAgc25hcHNob3RTY2hlZHVsZUNyb246ICcwICovNSAqICogKicsCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoaXMucmtlQ29uZmlnLmV0Y2QuZGlzYWJsZVNuYXBzaG90cyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBjb25zdCBkaXNhYmxlU25hcHNob3RzID0gIXRoaXMucmtlQ29uZmlnLmV0Y2Quc25hcHNob3RSZXRlbnRpb24gJiYgIXRoaXMucmtlQ29uZmlnLmV0Y2Quc25hcHNob3RTY2hlZHVsZUNyb247CgogICAgICAgIHNldCh0aGlzLnJrZUNvbmZpZy5ldGNkLCAnZGlzYWJsZVNuYXBzaG90cycsIGRpc2FibGVTbmFwc2hvdHMpOwogICAgICB9CgogICAgICAvLyBOYW1lc3BhY2VzIGlmIHJlcXVpcmVkIC0gdGhpcyBpcyBtYWlubHkgZm9yIGN1c3RvbSBwcm92aXNpb25lcnMgdmlhIGV4dGVuc2lvbnMgdGhhdCB3YW50CiAgICAgIC8vIHRvIGFsbG93IGNyZWF0aW5nIHRoZWlyIHJlc291cmNlcyBpbiBhIGRpZmZlcmVudCBuYW1lc3BhY2UKICAgICAgaWYgKHRoaXMubmVlZHNOYW1lc3BhY2UpIHsKICAgICAgICB0aGlzLmFsbE5hbWVzcGFjZXMgPSBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnbWFuYWdlbWVudC9maW5kQWxsJywgeyB0eXBlOiBOQU1FU1BBQ0UgfSk7CiAgICAgIH0KCiAgICAgIGlmICggIXRoaXMubWFjaGluZVBvb2xzICkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdE1hY2hpbmVQb29scyh0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnLm1hY2hpbmVQb29scyk7CiAgICAgICAgaWYgKCB0aGlzLm1vZGUgPT09IF9DUkVBVEUgJiYgIXRoaXMubWFjaGluZVBvb2xzLmxlbmd0aCApIHsKICAgICAgICAgIGF3YWl0IHRoaXMuYWRkTWFjaGluZVBvb2woKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICggdGhpcy52YWx1ZS5zcGVjLmRlZmF1bHRQb2RTZWN1cml0eVBvbGljeVRlbXBsYXRlTmFtZSA9PT0gdW5kZWZpbmVkICkgewogICAgICAgIHNldCh0aGlzLnZhbHVlLnNwZWMsICdkZWZhdWx0UG9kU2VjdXJpdHlQb2xpY3lUZW1wbGF0ZU5hbWUnLCAnJyk7CiAgICAgIH0KCiAgICAgIGlmICggdGhpcy52YWx1ZS5zcGVjLmRlZmF1bHRQb2RTZWN1cml0eUFkbWlzc2lvbkNvbmZpZ3VyYXRpb25UZW1wbGF0ZU5hbWUgPT09IHVuZGVmaW5lZCApIHsKICAgICAgICBzZXQodGhpcy52YWx1ZS5zcGVjLCAnZGVmYXVsdFBvZFNlY3VyaXR5QWRtaXNzaW9uQ29uZmlndXJhdGlvblRlbXBsYXRlTmFtZScsICcnKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEZldGNoIFJLRSB2ZXJzaW9ucyBhbmQgdGhlaXIgY29uZmlndXJhdGlvbnMgdG8gYmUgbWFwcGVkIHRvIHRoZSBmb3JtCiAgICAgKi8KICAgIGFzeW5jIGZldGNoUmtlMlZlcnNpb25zKCkgewogICAgICBpZiAoICF0aGlzLnJrZTJWZXJzaW9ucyApIHsKICAgICAgICBjb25zdCBoYXNoID0gewogICAgICAgICAgcmtlMlZlcnNpb25zOiB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnbWFuYWdlbWVudC9yZXF1ZXN0JywgeyB1cmw6ICcvdjEtcmtlMi1yZWxlYXNlL3JlbGVhc2VzJyB9KSwKICAgICAgICAgIGszc1ZlcnNpb25zOiAgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ21hbmFnZW1lbnQvcmVxdWVzdCcsIHsgdXJsOiAnL3YxLWszcy1yZWxlYXNlL3JlbGVhc2VzJyB9KSwKICAgICAgICB9OwoKICAgICAgICBpZiAoIHRoaXMuJHN0b3JlLmdldHRlcnNbJ21hbmFnZW1lbnQvY2FuTGlzdCddKE1BTkFHRU1FTlQuUE9EX1NFQ1VSSVRZX1BPTElDWV9URU1QTEFURSkgKSB7CiAgICAgICAgICBoYXNoLmFsbFBTUHMgPSBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnbWFuYWdlbWVudC9maW5kQWxsJywgeyB0eXBlOiBNQU5BR0VNRU5ULlBPRF9TRUNVUklUWV9QT0xJQ1lfVEVNUExBVEUgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy4kc3RvcmUuZ2V0dGVyc1snbWFuYWdlbWVudC9jYW5MaXN0J10oTUFOQUdFTUVOVC5QU0EpKSB7CiAgICAgICAgICBoYXNoLmFsbFBTQXMgPSBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnbWFuYWdlbWVudC9maW5kQWxsJywgeyB0eXBlOiBNQU5BR0VNRU5ULlBTQSB9KTsKICAgICAgICB9CgogICAgICAgIC8vIEdldCB0aGUgbGF0ZXN0IHZlcnNpb25zIGZyb20gdGhlIGdsb2JhbCBzZXR0aW5ncyBpZiBwb3NzaWJsZQogICAgICAgIGNvbnN0IGdsb2JhbFNldHRpbmdzID0gYXdhaXQgdGhpcy4kc3RvcmUuZ2V0dGVyc1snbWFuYWdlbWVudC9hbGwnXShNQU5BR0VNRU5ULlNFVFRJTkcpIHx8IFtdOwogICAgICAgIGNvbnN0IGRlZmF1bHRSa2UyU2V0dGluZyA9IGdsb2JhbFNldHRpbmdzLmZpbmQoKHNldHRpbmcpID0+IHNldHRpbmcuaWQgPT09ICdya2UyLWRlZmF1bHQtdmVyc2lvbicpIHx8IHt9OwogICAgICAgIGNvbnN0IGRlZmF1bHRLM3NTZXR0aW5nID0gZ2xvYmFsU2V0dGluZ3MuZmluZCgoc2V0dGluZykgPT4gc2V0dGluZy5pZCA9PT0gJ2szcy1kZWZhdWx0LXZlcnNpb24nKSB8fCB7fTsKCiAgICAgICAgbGV0IGRlZmF1bHRSa2UyID0gZGVmYXVsdFJrZTJTZXR0aW5nPy52YWx1ZSB8fCBkZWZhdWx0UmtlMlNldHRpbmc/LmRlZmF1bHQ7CiAgICAgICAgbGV0IGRlZmF1bHRLM3MgPSBkZWZhdWx0SzNzU2V0dGluZz8udmFsdWUgfHwgZGVmYXVsdEszc1NldHRpbmc/LmRlZmF1bHQ7CgogICAgICAgIC8vIFJLRTI6IFVzZSB0aGUgY2hhbm5lbCBpZiB3ZSBjYW4gbm90IGdldCB0aGUgdmVyc2lvbiBmcm9tIHRoZSBzZXR0aW5ncwogICAgICAgIGlmICghZGVmYXVsdFJrZTIpIHsKICAgICAgICAgIGhhc2gucmtlMkNoYW5uZWxzID0gdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ21hbmFnZW1lbnQvcmVxdWVzdCcsIHsgdXJsOiAnL3YxLXJrZTItcmVsZWFzZS9jaGFubmVscycgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBLM1M6IFVzZSB0aGUgY2hhbm5lbCBpZiB3ZSBjYW4gbm90IGdldCB0aGUgdmVyc2lvbiBmcm9tIHRoZSBzZXR0aW5ncwogICAgICAgIGlmICghZGVmYXVsdEszcykgewogICAgICAgICAgaGFzaC5rM3NDaGFubmVscyA9IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdtYW5hZ2VtZW50L3JlcXVlc3QnLCB7IHVybDogJy92MS1rM3MtcmVsZWFzZS9jaGFubmVscycgfSk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBhbGxIYXNoKGhhc2gpOwoKICAgICAgICB0aGlzLmFsbFBTUHMgPSByZXMuYWxsUFNQcyB8fCBbXTsKICAgICAgICB0aGlzLmFsbFBTQXMgPSByZXMuYWxsUFNBcyB8fCBbXTsKICAgICAgICB0aGlzLnJrZTJWZXJzaW9ucyA9IHJlcy5ya2UyVmVyc2lvbnMuZGF0YSB8fCBbXTsKICAgICAgICB0aGlzLmszc1ZlcnNpb25zID0gcmVzLmszc1ZlcnNpb25zLmRhdGEgfHwgW107CgogICAgICAgIGlmICghZGVmYXVsdFJrZTIpIHsKICAgICAgICAgIGNvbnN0IHJrZTJDaGFubmVscyA9IHJlcy5ya2UyQ2hhbm5lbHMuZGF0YSB8fCBbXTsKCiAgICAgICAgICBkZWZhdWx0UmtlMiA9IHJrZTJDaGFubmVscy5maW5kKCh4KSA9PiB4LmlkID09PSAnZGVmYXVsdCcpPy5sYXRlc3Q7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWRlZmF1bHRLM3MpIHsKICAgICAgICAgIGNvbnN0IGszc0NoYW5uZWxzID0gcmVzLmszc0NoYW5uZWxzLmRhdGEgfHwgW107CgogICAgICAgICAgZGVmYXVsdEszcyA9IGszc0NoYW5uZWxzLmZpbmQoKHgpID0+IHguaWQgPT09ICdkZWZhdWx0Jyk/LmxhdGVzdDsKICAgICAgICB9CgogICAgICAgIGlmICggIXRoaXMucmtlMlZlcnNpb25zLmxlbmd0aCAmJiAhdGhpcy5rM3NWZXJzaW9ucy5sZW5ndGggKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZlcnNpb24gaW5mbyBmb3VuZCBpbiBLRE0nKTsKICAgICAgICB9CgogICAgICAgIC8vIFN0b3JlIGRlZmF1bHQgdmVyc2lvbnMKICAgICAgICB0aGlzLmRlZmF1bHRSa2UyID0gZGVmYXVsdFJrZTI7CiAgICAgICAgdGhpcy5kZWZhdWx0SzNzID0gZGVmYXVsdEszczsKICAgICAgfQogICAgfSwKCiAgICBjbGVhbkFnZW50Q29uZmlndXJhdGlvbihtb2RlbCwga2V5KSB7CiAgICAgIGlmICghbW9kZWwgfHwgIW1vZGVsW2tleV0pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHYgPSBtb2RlbFtrZXldOwoKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodikgJiYgdi5sZW5ndGggPT09IDApIHsKICAgICAgICBkZWxldGUgbW9kZWxba2V5XTsKICAgICAgfSBlbHNlIGlmICh2ICYmIHR5cGVvZiB2ID09PSAnb2JqZWN0JykgewogICAgICAgIE9iamVjdC5rZXlzKHYpLmZvckVhY2goKGspID0+IHsKICAgICAgICAgIC8vIGRlbGV0ZSB0aGVzZSBhdXhpbGlhcnkgcHJvcHMgdXNlZCBpbiBwb2RBZmZpbml0eSBhbmQgbm9kZUFmZmluaXR5IHRoYXQgc2hvdWxkbid0IGJlIHNlbnQgdG8gdGhlIHNlcnZlcgogICAgICAgICAgaWYgKGsgPT09ICdfbmFtZXNwYWNlT3B0aW9uJyB8fCBrID09PSAnX25hbWVzcGFjZXMnIHx8IGsgPT09ICdfYW50aScgfHwgayA9PT0gJ19pZCcpIHsKICAgICAgICAgICAgZGVsZXRlIHZba107CiAgICAgICAgICB9CgogICAgICAgICAgLy8gcHJldmVudCBjbGVhbnVwIG9mICJuYW1lc3BhY2VTZWxlY3RvciIgd2hlbiBhbiBlbXB0eSBvYmplY3QgYmVjYXVzZSBpdCByZXByZXNlbnRzIGFsbCBuYW1lc3BhY2VzIGluIHBvZC9ub2RlIGFmZmluaXR5CiAgICAgICAgICAvLyBodHRwczovL2t1YmVybmV0ZXMuaW8vZG9jcy9yZWZlcmVuY2UvZ2VuZXJhdGVkL2t1YmVybmV0ZXMtYXBpL3YxLjI1LyNwb2RhZmZpbml0eXRlcm0tdjEtY29yZQogICAgICAgICAgaWYgKGsgIT09ICduYW1lc3BhY2VTZWxlY3RvcicpIHsKICAgICAgICAgICAgdGhpcy5jbGVhbkFnZW50Q29uZmlndXJhdGlvbih2LCBrKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKE9iamVjdC5rZXlzKHYpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgZGVsZXRlIG1vZGVsW2tleV07CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogQ2xlYW4gYWdlbnQgY29uZmlndXJhdGlvbiBvYmplY3RzLCBzbyB3ZSBvbmx5IHNlbmQgdmFsdWVzIHdoZW4gdGhlIHVzZXIgaGFzIGNvbmZpZ3VyZWQgc29tZXRoaW5nCiAgICAgKi8KICAgIGFnZW50Q29uZmlndXJhdGlvbkNsZWFudXAoKSB7CiAgICAgIHRoaXMuY2xlYW5BZ2VudENvbmZpZ3VyYXRpb24odGhpcy52YWx1ZS5zcGVjLCBDTFVTVEVSX0FHRU5UX0NVU1RPTUlaQVRJT04pOwogICAgICB0aGlzLmNsZWFuQWdlbnRDb25maWd1cmF0aW9uKHRoaXMudmFsdWUuc3BlYywgRkxFRVRfQUdFTlRfQ1VTVE9NSVpBVElPTik7CiAgICB9LAoKICAgIC8qKgogICAgICogRW5zdXJlIHdlIGhhdmUgZW1wdHkgbW9kZWxzIGZvciB0aGUgdHdvIGFnZW50IGNvbmZpZ3VyYXRpb25zCiAgICAgKi8KICAgIHNldEFnZW50Q29uZmlndXJhdGlvbigpIHsKICAgICAgLy8gQ2x1c3RlciBBZ2VudCBDb25maWd1cmF0aW9uCiAgICAgIGlmICggIXRoaXMudmFsdWUuc3BlY1tDTFVTVEVSX0FHRU5UX0NVU1RPTUlaQVRJT05dKSB7CiAgICAgICAgc2V0KHRoaXMudmFsdWUuc3BlYywgQ0xVU1RFUl9BR0VOVF9DVVNUT01JWkFUSU9OLCB7fSk7CiAgICAgIH0KCiAgICAgIC8vIEZsZWV0IEFnZW50IENvbmZpZ3VyYXRpb24KICAgICAgaWYgKCAhdGhpcy52YWx1ZS5zcGVjW0ZMRUVUX0FHRU5UX0NVU1RPTUlaQVRJT05dICkgewogICAgICAgIHNldCh0aGlzLnZhbHVlLnNwZWMsIEZMRUVUX0FHRU5UX0NVU1RPTUlaQVRJT04sIHt9KTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIHNldCBpbnN0YW5jZU5hbWVMaW1pdCB0byAxNSB0byBhbGwgcG9vbCBtYWNoaW5lIGlmIHRydW5jYXRlSG9zdG5hbWVzIGNoZWNrYm94IGlzIGNsaWNrZWQKICAgICAqLwogICAgdHJ1bmNhdGVOYW1lKCkgewogICAgICBpZiAodGhpcy50cnVuY2F0ZUhvc3RuYW1lcykgewogICAgICAgIHRoaXMudmFsdWUuZGVmYXVsdEhvc3RuYW1lTGVuZ3RoTGltaXQgPSBORVRCSU9TX1RSVU5DQVRJT05fTEVOR1RIOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudmFsdWUucmVtb3ZlRGVmYXVsdEhvc3RuYW1lTGVuZ3RoTGltaXQoKTsKICAgICAgfQogICAgfSwKICAgIC8qKgogICAgICogRGVmaW5lIFBTUCBkZXByZWNhdGlvbiBhbmQgcmVzdHJpY3QgdXNlIG9mIFBTUCBiYXNlZCBvbiBtaW4gazhzIHZlcnNpb24gYW5kIGN1cnJlbnQvZWRpdGVkIG1vZGUKICAgICAqLwogICAgZ2V0TmVlZHNQU1AodmFsdWUgPSB0aGlzLnZhbHVlKSB7CiAgICAgIGNvbnN0IHJlbGVhc2UgPSB2YWx1ZT8uc3BlYz8ua3ViZXJuZXRlc1ZlcnNpb24gfHwgJyc7CiAgICAgIGNvbnN0IHZlcnNpb24gPSByZWxlYXNlLm1hdGNoKC9cZCsvZyk7CiAgICAgIGNvbnN0IGlzUmVxdWlyZWRWZXJzaW9uID0gdmVyc2lvbj8ubGVuZ3RoID8gK3ZlcnNpb25bMF0gPT09IDEgJiYgK3ZlcnNpb25bMV0gPCAyNSA6IGZhbHNlOwoKICAgICAgcmV0dXJuIGlzUmVxdWlyZWRWZXJzaW9uOwogICAgfSwKCiAgICAvKioKICAgICAqIEdldCBtYWNoaW5lIHBvb2xzIGZyb20gdGhlIGNsdXN0ZXIgY29uZmlndXJhdGlvbgogICAgICogdGhpcy52YWx1ZS5zcGVjLnJrZUNvbmZpZy5tYWNoaW5lUG9vbHMKICAgICAqLwogICAgYXN5bmMgaW5pdE1hY2hpbmVQb29scyhleGlzdGluZykgewogICAgICBjb25zdCBvdXQgPSBbXTsKCiAgICAgIGlmICggZXhpc3Rpbmc/Lmxlbmd0aCApIHsKICAgICAgICBmb3IgKCBjb25zdCBwb29sIG9mIGV4aXN0aW5nICkgewogICAgICAgICAgbGV0IHR5cGU7CgogICAgICAgICAgaWYgKHRoaXMuaXNFbGVtZW50YWxDbHVzdGVyKSB7CiAgICAgICAgICAgIHR5cGUgPSBFTEVNRU5UQUxfU0NIRU1BX0lEUy5NQUNISU5FX0lOVl9TRUxFQ1RPUl9URU1QTEFURVM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0eXBlID0gYCR7IENBUEkuTUFDSElORV9DT05GSUdfR1JPVVAgfS4keyBwb29sLm1hY2hpbmVDb25maWdSZWYua2luZC50b0xvd2VyQ2FzZSgpIH1gOwogICAgICAgICAgfQoKICAgICAgICAgIGxldCBjb25maWc7CiAgICAgICAgICBsZXQgY29uZmlnTWlzc2luZyA9IGZhbHNlOwoKICAgICAgICAgIGlmICggdGhpcy4kc3RvcmUuZ2V0dGVyc1snbWFuYWdlbWVudC9jYW5MaXN0J10odHlwZSkgKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29uZmlnID0gYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ21hbmFnZW1lbnQvZmluZCcsIHsKICAgICAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgICAgICBpZDogYCR7IHRoaXMudmFsdWUubWV0YWRhdGEubmFtZXNwYWNlIH0vJHsgcG9vbC5tYWNoaW5lQ29uZmlnUmVmLm5hbWUgfWAsCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAvLyBTb21lIHVzZXJzIGNhbid0IHNlZSB0aGUgY29uZmlnLCB0aGF0J3Mgb2suCiAgICAgICAgICAgICAgLy8gd2Ugd2lsbCBkaXNwbGF5IGEgYmFubmVyIGZvciBhIDQwNCBvbmx5IGZvciBlbGVtZW50YWwKICAgICAgICAgICAgICBpZiAoZT8uc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRWxlbWVudGFsQ2x1c3RlcikgewogICAgICAgICAgICAgICAgICBjb25maWdNaXNzaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBAVE9ETyB3aGF0IGlmIHRoZSBwb29sIGlzIG1pc3Npbmc/CiAgICAgICAgICBjb25zdCBpZCA9IGBwb29sJHsgKyt0aGlzLmxhc3RJZHggfWA7CgogICAgICAgICAgb3V0LnB1c2goewogICAgICAgICAgICBpZCwKICAgICAgICAgICAgcmVtb3ZlOiBmYWxzZSwKICAgICAgICAgICAgY3JlYXRlOiBmYWxzZSwKICAgICAgICAgICAgdXBkYXRlOiB0cnVlLAogICAgICAgICAgICBwb29sOiAgIGNsb25lKHBvb2wpLAogICAgICAgICAgICBjb25maWc6IGNvbmZpZyA/IGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdtYW5hZ2VtZW50L2Nsb25lJywgeyByZXNvdXJjZTogY29uZmlnIH0pIDogbnVsbCwKICAgICAgICAgICAgY29uZmlnTWlzc2luZwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLm1hY2hpbmVQb29scyA9IG91dDsKICAgIH0sCgogICAgYXN5bmMgYWRkTWFjaGluZVBvb2woaWR4KSB7CiAgICAgIC8vIHRoaXMubWFjaGluZUNvbmZpZ1NjaGVtYSBpcyB0aGUgc2NoZW1hIGZvciB0aGUgTWFjaGluZSBQb29sJ3MgbWFjaGluZSBjb25maWd1cmF0aW9uIGZvciB0aGUgZ2l2ZW4gcHJvdmlkZXIKICAgICAgaWYgKCAhdGhpcy5tYWNoaW5lQ29uZmlnU2NoZW1hICkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgbnVtQ3VycmVudFBvb2xzID0gdGhpcy5tYWNoaW5lUG9vbHMubGVuZ3RoIHx8IDA7CgogICAgICBsZXQgY29uZmlnOwoKICAgICAgaWYgKHRoaXMuZXh0ZW5zaW9uUHJvdmlkZXI/LmNyZWF0ZU1hY2hpbmVQb29sTWFjaGluZUNvbmZpZykgewogICAgICAgIGNvbmZpZyA9IGF3YWl0IHRoaXMuZXh0ZW5zaW9uUHJvdmlkZXIuY3JlYXRlTWFjaGluZVBvb2xNYWNoaW5lQ29uZmlnKGlkeCwgdGhpcy5tYWNoaW5lUG9vbHMsIHRoaXMudmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIERlZmF1bHQgLSB1c2UgdGhlIHNjaGVtYQogICAgICAgIGNvbmZpZyA9IGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdtYW5hZ2VtZW50L2NyZWF0ZVBvcHVsYXRlZCcsIHsKICAgICAgICAgIHR5cGU6ICAgICB0aGlzLm1hY2hpbmVDb25maWdTY2hlbWEuaWQsCiAgICAgICAgICBtZXRhZGF0YTogeyBuYW1lc3BhY2U6IERFRkFVTFRfV09SS1NQQUNFIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gc3BlY2lmaWMgbW9kZWwsIHRoZSBhcHBseURlZmF1bHRzIGRvZXMgbm90aGluZyBieSBkZWZhdWx0CiAgICAgICAgY29uZmlnLmFwcGx5RGVmYXVsdHMoaWR4LCB0aGlzLm1hY2hpbmVQb29scyk7CiAgICAgIH0KCiAgICAgIGNvbnN0IG5hbWUgPSBgcG9vbCR7ICsrdGhpcy5sYXN0SWR4IH1gOwoKICAgICAgY29uc3QgcG9vbCA9IHsKICAgICAgICBpZDogICAgIG5hbWUsCiAgICAgICAgY29uZmlnLAogICAgICAgIHJlbW92ZTogZmFsc2UsCiAgICAgICAgY3JlYXRlOiB0cnVlLAogICAgICAgIHVwZGF0ZTogZmFsc2UsCiAgICAgICAgdWlkOiAgICBuYW1lLAogICAgICAgIHBvb2w6ICAgewogICAgICAgICAgbmFtZSwKICAgICAgICAgIGV0Y2RSb2xlOiAgICAgICAgICAgICBudW1DdXJyZW50UG9vbHMgPT09IDAsCiAgICAgICAgICBjb250cm9sUGxhbmVSb2xlOiAgICAgbnVtQ3VycmVudFBvb2xzID09PSAwLAogICAgICAgICAgd29ya2VyUm9sZTogICAgICAgICAgIHRydWUsCiAgICAgICAgICBob3N0bmFtZVByZWZpeDogICAgICAgJycsCiAgICAgICAgICBsYWJlbHM6ICAgICAgICAgICAgICAge30sCiAgICAgICAgICBxdWFudGl0eTogICAgICAgICAgICAgMSwKICAgICAgICAgIHVuaGVhbHRoeU5vZGVUaW1lb3V0OiAnMG0nLAogICAgICAgICAgbWFjaGluZUNvbmZpZ1JlZjogICAgIHsKICAgICAgICAgICAga2luZDogdGhpcy5tYWNoaW5lQ29uZmlnU2NoZW1hLmF0dHJpYnV0ZXM/LmtpbmQsCiAgICAgICAgICAgIG5hbWU6IG51bGwsCiAgICAgICAgICB9LAogICAgICAgICAgZHJhaW5CZWZvcmVEZWxldGU6IHRydWUKICAgICAgICB9LAogICAgICB9OwoKICAgICAgaWYgKHRoaXMucHJvdmlkZXIgPT09ICd2bXdhcmV2c3BoZXJlJykgewogICAgICAgIHBvb2wucG9vbC5tYWNoaW5lT1MgPSAnbGludXgnOwogICAgICB9CgogICAgICBpZiAodGhpcy5pc0VsZW1lbnRhbENsdXN0ZXIpIHsKICAgICAgICBwb29sLnBvb2wubWFjaGluZUNvbmZpZ1JlZi5hcGlWZXJzaW9uID0gYCR7IHRoaXMubWFjaGluZUNvbmZpZ1NjaGVtYS5hdHRyaWJ1dGVzLmdyb3VwIH0vJHsgdGhpcy5tYWNoaW5lQ29uZmlnU2NoZW1hLmF0dHJpYnV0ZXMudmVyc2lvbiB9YDsKICAgICAgfQoKICAgICAgdGhpcy5tYWNoaW5lUG9vbHMucHVzaChwb29sKTsKCiAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICBpZiAoIHRoaXMuJHJlZnMucG9vbHM/LnNlbGVjdCApIHsKICAgICAgICAgIHRoaXMuJHJlZnMucG9vbHMuc2VsZWN0KG5hbWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIHJlbW92ZU1hY2hpbmVQb29sKGlkeCkgewogICAgICBjb25zdCBlbnRyeSA9IHRoaXMubWFjaGluZVBvb2xzW2lkeF07CgogICAgICBpZiAoICFlbnRyeSApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICggZW50cnkuY3JlYXRlICkgewogICAgICAgIC8vIElmIHRoaXMgaXMgYSBuZXcgcG9vbCB0aGF0IGlzbid0IHNhdmVkIHlldCwgaXQgY2FuIGp1c3QgYmUgZHJvcHBlZAogICAgICAgIHJlbW92ZU9iamVjdCh0aGlzLm1hY2hpbmVQb29scywgZW50cnkpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIE1hcmsgZm9yIHJlbW92YWwgb24gc2F2ZQogICAgICAgIGVudHJ5LnJlbW92ZSA9IHRydWU7CiAgICAgIH0KICAgIH0sCgogICAgYXN5bmMgc3luY01hY2hpbmVDb25maWdXaXRoTGF0ZXN0KG1hY2hpbmVQb29sKSB7CiAgICAgIGlmIChtYWNoaW5lUG9vbD8uY29uZmlnPy5pZCkgewogICAgICAgIC8vIFVzZSBtYW5hZ2VtZW50L3JlcXVlc3QgaW5zdGVhZCBvZiBtYW5hZ2VtZW50L2ZpbmQgdG8gYXZvaWQgb3ZlcndyaXRpbmcgdGhlIGN1cnJlbnQgbWFjaGluZSBwb29sIGluIHRoZSBzdG9yZQogICAgICAgIGNvbnN0IF9sYXRlc3RDb25maWcgPSBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnbWFuYWdlbWVudC9yZXF1ZXN0JywgeyB1cmw6IGAvdjEvJHsgbWFjaGluZVBvb2wuY29uZmlnLnR5cGUgfXMvJHsgbWFjaGluZVBvb2wuY29uZmlnLmlkIH1gIH0pOwogICAgICAgIGNvbnN0IGxhdGVzdENvbmZpZyA9IGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdtYW5hZ2VtZW50L2NyZWF0ZScsIF9sYXRlc3RDb25maWcpOwoKICAgICAgICBjb25zdCBjbG9uZWRDdXJyZW50Q29uZmlnID0gYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ21hbmFnZW1lbnQvY2xvbmUnLCB7IHJlc291cmNlOiBtYWNoaW5lUG9vbC5jb25maWcgfSk7CiAgICAgICAgY29uc3QgY2xvbmVkTGF0ZXN0Q29uZmlnID0gYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ21hbmFnZW1lbnQvY2xvbmUnLCB7IHJlc291cmNlOiBsYXRlc3RDb25maWcgfSk7CgogICAgICAgIC8vIFdlIGRvbid0IGFsbG93IHRoZSB1c2VyIHRvIGVkaXQgYW55IG9mIHRoZSBmaWVsZHMgaW4gbWV0YWRhdGEgZnJvbSB0aGUgVUkgc28gaXQncyBzYWZlIHRvIG92ZXJyaWRlIGl0IHdpdGggdGhlCiAgICAgICAgLy8gbWV0YWRhdGEgZGVmaW5lZCBieSB0aGUgbGF0ZXN0IGJhY2tlbmQgdmFsdWUuIFRoaXMgaXMgcHJpbWFyaWx5IHVzZWQgdG8gZW5zdXJlIHRoZSByZXNvdXJjZVZlcnNpb24gaXMgdXAgdG8gZGF0ZS4KICAgICAgICBkZWxldGUgY2xvbmVkQ3VycmVudENvbmZpZy5tZXRhZGF0YTsKICAgICAgICBtYWNoaW5lUG9vbC5jb25maWcgPSBtZXJnZShjbG9uZWRMYXRlc3RDb25maWcsIGNsb25lZEN1cnJlbnRDb25maWcpOwogICAgICB9CiAgICB9LAoKICAgIGFzeW5jIHNhdmVNYWNoaW5lUG9vbHMoaG9va0NvbnRleHQpIHsKICAgICAgaWYgKGhvb2tDb250ZXh0ID09PSBDT05URVhUX0hPT0tfRURJVF9ZQU1MKSB7CiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ2NsdXN0ZXIvcHJvbXB0TW9kYWwnLCB7CiAgICAgICAgICAgIGNvbXBvbmVudDogICAgICAnR2VuZXJpY1Byb21wdCcsCiAgICAgICAgICAgIGNvbXBvbmVudFByb3BzOiB7CiAgICAgICAgICAgICAgdGl0bGU6ICAgICB0aGlzLnQoJ2NsdXN0ZXIucmtlMi5tb2RhbC5lZGl0WWFtbE1hY2hpbmVQb29sLnRpdGxlJyksCiAgICAgICAgICAgICAgYm9keTogICAgICB0aGlzLnQoJ2NsdXN0ZXIucmtlMi5tb2RhbC5lZGl0WWFtbE1hY2hpbmVQb29sLmJvZHknKSwKICAgICAgICAgICAgICBhcHBseU1vZGU6ICdlZGl0QW5kQ29udGludWUnLAogICAgICAgICAgICAgIGNvbmZpcm06ICAgKGNvbmZpcm1lZCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGNvbmZpcm1lZCkgewogICAgICAgICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdVc2VyIENhbmNlbGxlZCcpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgY29uc3QgZmluYWxQb29scyA9IFtdOwoKICAgICAgLy8gSWYgdGhlIGV4dGVuc2lvbiBwcm92aWRlciB3YW50cyB0byBkbyB0aGlzLCBsZXQgdGhlbQogICAgICBpZiAodGhpcy5leHRlbnNpb25Qcm92aWRlcj8uc2F2ZU1hY2hpbmVQb29sQ29uZmlncykgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4dGVuc2lvblByb3ZpZGVyLnNhdmVNYWNoaW5lUG9vbENvbmZpZ3ModGhpcy5tYWNoaW5lUG9vbHMsIHRoaXMudmFsdWUpOwogICAgICB9CgogICAgICBmb3IgKCBjb25zdCBlbnRyeSBvZiB0aGlzLm1hY2hpbmVQb29scyApIHsKICAgICAgICBpZiAoIGVudHJ5LnJlbW92ZSApIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgdGhpcy5zeW5jTWFjaGluZUNvbmZpZ1dpdGhMYXRlc3QoZW50cnkpOwoKICAgICAgICAvLyBDYXBpdGFscyBhbmQgc3VjaCBhcmVuJ3QgYWxsb3dlZDsKICAgICAgICBzZXQoZW50cnkucG9vbCwgJ25hbWUnLCBub3JtYWxpemVOYW1lKGVudHJ5LnBvb2wubmFtZSkgfHwgJ3Bvb2wnKTsKCiAgICAgICAgY29uc3QgcHJlZml4ID0gYCR7IHRoaXMudmFsdWUubWV0YWRhdGEubmFtZSB9LSR7IGVudHJ5LnBvb2wubmFtZSB9YC5zdWJzdHIoMCwgNTApLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIGlmICggZW50cnkuY3JlYXRlICkgewogICAgICAgICAgaWYgKCAhZW50cnkuY29uZmlnLm1ldGFkYXRhPy5uYW1lICkgewogICAgICAgICAgICBlbnRyeS5jb25maWcubWV0YWRhdGEuZ2VuZXJhdGVOYW1lID0gYG5jLSR7IHByZWZpeCB9LWA7CiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgbmV1ID0gYXdhaXQgZW50cnkuY29uZmlnLnNhdmUoKTsKCiAgICAgICAgICBlbnRyeS5jb25maWcgPSBuZXU7CiAgICAgICAgICBlbnRyeS5wb29sLm1hY2hpbmVDb25maWdSZWYubmFtZSA9IG5ldS5tZXRhZGF0YS5uYW1lOwogICAgICAgICAgZW50cnkuY3JlYXRlID0gZmFsc2U7CiAgICAgICAgICBlbnRyeS51cGRhdGUgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoIGVudHJ5LnVwZGF0ZSApIHsKICAgICAgICAgIGVudHJ5LmNvbmZpZyA9IGF3YWl0IGVudHJ5LmNvbmZpZy5zYXZlKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBFbnN1cmUgRWxlbWVudGFsIGNsdXN0ZXJzIGhhdmUgYSBob3N0bmFtZSBwcmVmaXgKICAgICAgICBpZiAodGhpcy5pc0VsZW1lbnRhbENsdXN0ZXIgJiYgIWVudHJ5LnBvb2wuaG9zdG5hbWVQcmVmaXggKSB7CiAgICAgICAgICBlbnRyeS5wb29sLmhvc3RuYW1lUHJlZml4ID0gYCR7IHByZWZpeCB9LWA7CiAgICAgICAgfQoKICAgICAgICBmaW5hbFBvb2xzLnB1c2goZW50cnkucG9vbCk7CiAgICAgIH0KCiAgICAgIHRoaXMudmFsdWUuc3BlYy5ya2VDb25maWcubWFjaGluZVBvb2xzID0gZmluYWxQb29sczsKICAgIH0sCgogICAgYXN5bmMgY2xlYW51cE1hY2hpbmVQb29scygpIHsKICAgICAgZm9yICggY29uc3QgZW50cnkgb2YgdGhpcy5tYWNoaW5lUG9vbHMgKSB7CiAgICAgICAgaWYgKCBlbnRyeS5yZW1vdmUgJiYgZW50cnkuY29uZmlnICkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgZW50cnkuY29uZmlnLnJlbW92ZSgpOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgYXN5bmMgc2F2ZVJvbGVCaW5kaW5ncygpIHsKICAgICAgYXdhaXQgdGhpcy52YWx1ZS53YWl0Rm9yTWdtdCgpOwoKICAgICAgaWYgKHRoaXMubWVtYmVyc2hpcFVwZGF0ZS5zYXZlKSB7CiAgICAgICAgYXdhaXQgdGhpcy5tZW1iZXJzaGlwVXBkYXRlLnNhdmUodGhpcy52YWx1ZS5tZ210LmlkKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEVuc3VyZSB0aGF0IGFsbCB0aGUgZXhpc3Rpbmcgbm9kZSByb2xlcyBwb29sIGFyZSBhdCBsZWFzdCAxIGVhY2gKICAgICAqLwogICAgaGFzUmVxdWlyZWROb2RlcygpIHsKICAgICAgcmV0dXJuIHRoaXMubm9kZVRvdGFscz8uY29sb3IgJiYgT2JqZWN0LnZhbHVlcyh0aGlzLm5vZGVUb3RhbHMuY29sb3IpLmV2ZXJ5KChjb2xvcikgPT4gY29sb3IgIT09IE5PREVfVE9UQUwuZXJyb3IuY29sb3IpOwogICAgfSwKCiAgICBjYW5jZWxDcmVkZW50aWFsKCkgewogICAgICBpZiAoIHRoaXMuJHJlZnMuY3J1cmVzb3VyY2UgKSB7CiAgICAgICAgdGhpcy4kcmVmcy5jcnVyZXNvdXJjZS5lbWl0T3JSb3V0ZSgpOwogICAgICB9CiAgICB9LAoKICAgIGRvbmUoKSB7CiAgICAgIGxldCByb3V0ZU5hbWUgPSAnYy1jbHVzdGVyLXByb2R1Y3QtcmVzb3VyY2UnOwoKICAgICAgaWYgKCB0aGlzLm1vZGUgPT09IF9DUkVBVEUgJiYgKHRoaXMucHJvdmlkZXIgPT09ICdpbXBvcnQnIHx8IHRoaXMucHJvdmlkZXIgPT09ICdjdXN0b20nKSApIHsKICAgICAgICAvLyBHbyBzaG93IHRoZSByZWdpc3RyYXRpb24gY29tbWFuZAogICAgICAgIHJvdXRlTmFtZSA9ICdjLWNsdXN0ZXItcHJvZHVjdC1yZXNvdXJjZS1uYW1lc3BhY2UtaWQnOwogICAgICB9CgogICAgICB0aGlzLiRyb3V0ZXIucHVzaCh7CiAgICAgICAgbmFtZTogICByb3V0ZU5hbWUsCiAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICBjbHVzdGVyOiAgIHRoaXMuJHJvdXRlLnBhcmFtcy5jbHVzdGVyLAogICAgICAgICAgcHJvZHVjdDogICB0aGlzLiRzdG9yZS5nZXR0ZXJzWydwcm9kdWN0SWQnXSwKICAgICAgICAgIHJlc291cmNlOiAgQ0FQSS5SQU5DSEVSX0NMVVNURVIsCiAgICAgICAgICBuYW1lc3BhY2U6IHRoaXMudmFsdWUubWV0YWRhdGEubmFtZXNwYWNlLAogICAgICAgICAgaWQ6ICAgICAgICB0aGlzLnZhbHVlLm1ldGFkYXRhLm5hbWUsCiAgICAgICAgfSwKICAgICAgfSk7CiAgICB9LAoKICAgIHNob3dBZGRvbkNvbmZpcm1hdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnY2x1c3Rlci9wcm9tcHRNb2RhbCcsIHsKICAgICAgICAgIGNvbXBvbmVudDogJ0FkZG9uQ29uZmlnQ29uZmlybWF0aW9uRGlhbG9nJywKICAgICAgICAgIHJlc291cmNlczogWyh2YWx1ZSkgPT4gcmVzb2x2ZSh2YWx1ZSldCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIEluZm9ybSB1c2VyIHRvIHJlbW92ZSBQU1AgZm9yIGN1cnJlbnQgY2x1c3RlciBkdWUgZGVwcmVjYXRpb24KICAgICAqLwogICAgc2hvd1BzcENvbmZpcm1hdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnY2x1c3Rlci9wcm9tcHRNb2RhbCcsIHsKICAgICAgICAgIGNvbXBvbmVudDogICAgICAnR2VuZXJpY1Byb21wdCcsCiAgICAgICAgICBjb21wb25lbnRQcm9wczogewogICAgICAgICAgICB0aXRsZTogICAgIHRoaXMudCgnY2x1c3Rlci5ya2UyLm1vZGFsLnBzcENoYW5nZS50aXRsZScpLAogICAgICAgICAgICBib2R5OiAgICAgIHRoaXMudCgnY2x1c3Rlci5ya2UyLm1vZGFsLnBzcENoYW5nZS5ib2R5JyksCiAgICAgICAgICAgIGFwcGx5TW9kZTogJ2NvbnRpbnVlJywKICAgICAgICAgICAgY29uZmlybTogICByZXNvbHZlCiAgICAgICAgICB9LAogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gU2V0IGJ1c3kgYmVmb3JlIHNhdmUgYW5kIGNsZWFyIGFmdGVyIHNhdmUKICAgIGFzeW5jIHNhdmVPdmVycmlkZShidG5DYikgewogICAgICB0aGlzLiRzZXQodGhpcywgJ2J1c3knLCB0cnVlKTsKCiAgICAgIC8vIElmIHRoZSBwcm92aWRlciBpcyBmcm9tIGFuIGV4dGVuc2lvbiwgbGV0IGl0IGRvIHRoZSBwcm92aXNpb24gc3RlcAogICAgICBpZiAodGhpcy5leHRlbnNpb25Qcm92aWRlcj8ucHJvdmlzaW9uKSB7CiAgICAgICAgY29uc3QgZXJyb3JzID0gYXdhaXQgdGhpcy5leHRlbnNpb25Qcm92aWRlcj8ucHJvdmlzaW9uKHRoaXMudmFsdWUsIHRoaXMubWFjaGluZVBvb2xzKTsKICAgICAgICBjb25zdCBva2F5ID0gKGVycm9ycyB8fCBbXSkubGVuZ3RoID09PSAwOwoKICAgICAgICB0aGlzLmVycm9ycyA9IGVycm9yczsKICAgICAgICB0aGlzLiRzZXQodGhpcywgJ2J1c3knLCBmYWxzZSk7CgogICAgICAgIGJ0bkNiKG9rYXkpOwoKICAgICAgICBpZiAob2theSkgewogICAgICAgICAgLy8gSWYgc2F2ZWQgb2theSwgZ28gdG8gdGhlIGRvbmUgcm91dGUKICAgICAgICAgIHJldHVybiB0aGlzLmRvbmUoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIERlZmF1bHQgc2F2ZQogICAgICByZXR1cm4gdGhpcy5fZG9TYXZlT3ZlcnJpZGUoKGRvbmUpID0+IHsKICAgICAgICB0aGlzLiRzZXQodGhpcywgJ2J1c3knLCBmYWxzZSk7CgogICAgICAgIHJldHVybiBidG5DYihkb25lKTsKICAgICAgfSk7CiAgICB9LAoKICAgIGFzeW5jIF9kb1NhdmVPdmVycmlkZShidG5DYikgewogICAgICAvLyBXZSBjYW5ub3QgdXNlIHRoZSBob29rLCBiZWNhdXNlIGl0IGlzIHRyaWdnZXJlZCBvbiBZQU1MIHRvZ2dsZSB3aXRob3V0IHJlc3RvcmUgaW5pdGlhbGl6ZWQgZGF0YQogICAgICB0aGlzLmFnZW50Q29uZmlndXJhdGlvbkNsZWFudXAoKTsKCiAgICAgIGlmICggdGhpcy5lcnJvcnMgKSB7CiAgICAgICAgY2xlYXIodGhpcy5lcnJvcnMpOwogICAgICB9CgogICAgICBjb25zdCBpc0VkaXRWZXJzaW9uID0gdGhpcy5pc0VkaXQgJiYgdGhpcy5saXZlVmFsdWU/LnNwZWM/Lmt1YmVybmV0ZXNWZXJzaW9uICE9PSB0aGlzLnZhbHVlPy5zcGVjPy5rdWJlcm5ldGVzVmVyc2lvbjsKICAgICAgY29uc3QgaGFzUHNwTWFudWFsbHlBZGRlZCA9ICEhdGhpcy52YWx1ZS5zcGVjLnJrZUNvbmZpZz8ubWFjaGluZUdsb2JhbENvbmZpZz8uWydrdWJlLWFwaXNlcnZlci1hcmcnXTsKCiAgICAgIGlmIChpc0VkaXRWZXJzaW9uICYmICF0aGlzLm5lZWRzUFNQICYmIGhhc1BzcE1hbnVhbGx5QWRkZWQpIHsKICAgICAgICBpZiAoIWF3YWl0IHRoaXMuc2hvd1BzcENvbmZpcm1hdGlvbigpKSB7CiAgICAgICAgICByZXR1cm4gYnRuQ2IoJ2NhbmNlbGxlZCcpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzRWRpdFZlcnNpb24pIHsKICAgICAgICBjb25zdCBzaG91bGRDb250aW51ZSA9IGF3YWl0IHRoaXMuc2hvd0FkZG9uQ29uZmlybWF0aW9uKCk7CgogICAgICAgIGlmICghc2hvdWxkQ29udGludWUpIHsKICAgICAgICAgIHJldHVybiBidG5DYignY2FuY2VsbGVkJyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy52YWx1ZS5jbG91ZFByb3ZpZGVyID09PSAnYXdzJykgewogICAgICAgIGNvbnN0IG1pc3NpbmdQcm9maWxlTmFtZSA9IHRoaXMubWFjaGluZVBvb2xzLnNvbWUoKG1wKSA9PiAhbXAuY29uZmlnLmlhbUluc3RhbmNlUHJvZmlsZSk7CgogICAgICAgIGlmIChtaXNzaW5nUHJvZmlsZU5hbWUpIHsKICAgICAgICAgIHRoaXMuZXJyb3JzLnB1c2godGhpcy50KCdjbHVzdGVyLnZhbGlkYXRpb24uaWFtSW5zdGFuY2VQcm9maWxlTmFtZScsIHt9LCB0cnVlKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGNvbnN0IFtpbmRleF0gb2YgdGhpcy5tYWNoaW5lUG9vbHMuZW50cmllcygpKSB7IC8vIHZhbGlkYXRvciBtYWNoaW5lIGNvbmZpZwogICAgICAgIGlmICggdHlwZW9mIHRoaXMuJHJlZnMucG9vbFtpbmRleF0/LnRlc3QgPT09ICdmdW5jdGlvbicgKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLiRyZWZzLnBvb2xbaW5kZXhdLnRlc3QoKTsKCiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlcykgJiYgcmVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB0aGlzLmVycm9ycy5wdXNoKC4uLnJlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgdGhpcy5lcnJvcnMucHVzaChlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy52YWx1ZS5tZXRhZGF0YS5uYW1lICYmIHRoaXMuYWdlbnRDb25maWdbJ2Nsb3VkLXByb3ZpZGVyLW5hbWUnXSA9PT0gSEFSVkVTVEVSKSB7CiAgICAgICAgdGhpcy5lcnJvcnMucHVzaCh0aGlzLnQoJ3ZhbGlkYXRpb24ucmVxdWlyZWQnLCB7IGtleTogdGhpcy50KCdjbHVzdGVyLm5hbWUubGFiZWwnKSB9LCB0cnVlKSk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmVycm9ycy5sZW5ndGgpIHsKICAgICAgICBidG5DYihmYWxzZSk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCBjbHVzdGVySWQgPSBnZXQodGhpcy5jcmVkZW50aWFsLCAnZGVjb2RlZERhdGEuY2x1c3RlcklkJykgfHwgJyc7CgogICAgICAgIHRoaXMuYXBwbHlDaGFydFZhbHVlcyh0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnKTsKCiAgICAgICAgY29uc3QgaXNVcGdyYWRlID0gdGhpcy5pc0VkaXQgJiYgdGhpcy5saXZlVmFsdWU/LnNwZWM/Lmt1YmVybmV0ZXNWZXJzaW9uICE9PSB0aGlzLnZhbHVlPy5zcGVjPy5rdWJlcm5ldGVzVmVyc2lvbjsKCiAgICAgICAgaWYgKHRoaXMuYWdlbnRDb25maWdbJ2Nsb3VkLXByb3ZpZGVyLW5hbWUnXSA9PT0gSEFSVkVTVEVSICYmIGNsdXN0ZXJJZCAmJiAodGhpcy5pc0NyZWF0ZSB8fCBpc1VwZ3JhZGUpKSB7CiAgICAgICAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLm1hY2hpbmVQb29scz8uWzBdPy5jb25maWc/LnZtTmFtZXNwYWNlOwoKICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdtYW5hZ2VtZW50L3JlcXVlc3QnLCB7CiAgICAgICAgICAgIHVybDogICAgYC9rOHMvY2x1c3RlcnMvJHsgY2x1c3RlcklkIH0vdjEvaGFydmVzdGVyL2t1YmVjb25maWdgLAogICAgICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICAgICAgZGF0YTogICB7CiAgICAgICAgICAgICAgY3NpQ2x1c3RlclJvbGVOYW1lOiAnaGFydmVzdGVyaGNpLmlvOmNzaS1kcml2ZXInLAogICAgICAgICAgICAgIGNsdXN0ZXJSb2xlTmFtZTogICAgJ2hhcnZlc3RlcmhjaS5pbzpjbG91ZHByb3ZpZGVyJywKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgc2VydmljZUFjY291bnROYW1lOiB0aGlzLnZhbHVlLm1ldGFkYXRhLm5hbWUsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KTsKCiAgICAgICAgICBjb25zdCBrdWJlY29uZmlnID0gcmVzLmRhdGE7CgogICAgICAgICAgY29uc3QgaGFydmVzdGVyS3ViZWNvbmZpZ1NlY3JldCA9IGF3YWl0IHRoaXMuY3JlYXRlS3ViZWNvbmZpZ1NlY3JldChrdWJlY29uZmlnKTsKCiAgICAgICAgICBzZXQodGhpcy5hZ2VudENvbmZpZywgJ2Nsb3VkLXByb3ZpZGVyLWNvbmZpZycsIGBzZWNyZXQ6Ly9mbGVldC1kZWZhdWx0OiR7IGhhcnZlc3Rlckt1YmVjb25maWdTZWNyZXQ/Lm1ldGFkYXRhPy5uYW1lIH1gKTsKCiAgICAgICAgICBpZiAodGhpcy5pc0NyZWF0ZSkgewogICAgICAgICAgICBzZXQodGhpcy5jaGFydFZhbHVlcywgYCR7IEhBUlZFU1RFUl9DTE9VRF9QUk9WSURFUiB9Lmdsb2JhbC5jYXR0bGUuY2x1c3Rlck5hbWVgLCB0aGlzLnZhbHVlLm1ldGFkYXRhLm5hbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIHNldCh0aGlzLmNoYXJ0VmFsdWVzLCBgJHsgSEFSVkVTVEVSX0NMT1VEX1BST1ZJREVSIH0uY2xvdWRDb25maWdQYXRoYCwgJy92YXIvbGliL3JhbmNoZXIvcmtlMi9ldGMvY29uZmlnLWZpbGVzL2Nsb3VkLXByb3ZpZGVyLWNvbmZpZycpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgdGhpcy5lcnJvcnMucHVzaChlcnIpOwoKICAgICAgICBidG5DYihmYWxzZSk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gUmVtb3ZlIG51bGwgcHJvZmlsZSBvbiBtYWNoaW5lR2xvYmFsQ29uZmlnIC0gaHR0cHM6Ly9naXRodWIuY29tL3JhbmNoZXIvZGFzaGJvYXJkL2lzc3Vlcy84NDgwCiAgICAgIGlmICh0aGlzLnZhbHVlLnNwZWM/LnJrZUNvbmZpZz8ubWFjaGluZUdsb2JhbENvbmZpZz8ucHJvZmlsZSA9PT0gbnVsbCkgewogICAgICAgIGRlbGV0ZSB0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnLm1hY2hpbmVHbG9iYWxDb25maWcucHJvZmlsZTsKICAgICAgfQoKICAgICAgLy8gU3RvcmUgdGhlIGN1cnJlbnQgZGF0YSBmb3IgZmxlZXQgYW5kIGNsdXN0ZXIgYWdlbnQgc28gdGhhdCB3ZSBjYW4gcmUtYXBwbHkgaXQgbGF0ZXIgaWYgdGhlIHNhdmUgZmFpbHMKICAgICAgLy8gVGhlIGNsZWFudXAgb2NjdXJzIGJlZm9yZSBzYXZlIHdpdGggYWdlbnRDb25maWd1cmF0aW9uQ2xlYW51cCgpCiAgICAgIGNvbnN0IGNsdXN0ZXJBZ2VudERlcGxveW1lbnRDdXN0b21pemF0aW9uID0gdGhpcy52YWx1ZS5zcGVjW0NMVVNURVJfQUdFTlRfQ1VTVE9NSVpBVElPTl0gPyBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMudmFsdWUuc3BlY1tDTFVTVEVSX0FHRU5UX0NVU1RPTUlaQVRJT05dKSkgOiBudWxsOwogICAgICBjb25zdCBmbGVldEFnZW50RGVwbG95bWVudEN1c3RvbWl6YXRpb24gPSB0aGlzLnZhbHVlLnNwZWNbRkxFRVRfQUdFTlRfQ1VTVE9NSVpBVElPTl0gPyBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMudmFsdWUuc3BlY1tGTEVFVF9BR0VOVF9DVVNUT01JWkFUSU9OXSkpIDogbnVsbDsKCiAgICAgIGF3YWl0IHRoaXMuc2F2ZShidG5DYik7CgogICAgICAvLyBjb21lcyBmcm9tIGNyZWF0ZUVkaXRWaWV3IG1peGluCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBhbnkgZXJyb3JzIHNhdmluZywgcmVzdG9yZSB0aGUgYWdlbnQgY29uZmlnIGRhdGEKICAgICAgaWYgKHRoaXMuZXJyb3JzPy5sZW5ndGgpIHsKICAgICAgICAvLyBFbnN1cmUgdGhlIGFnZW50IGNvbmZpZ3VyYXRpb24gaXMgc2V0IGJhY2sgdG8gdGhlIHZhbHVlcyBiZWZvcmUgd2UgY2hhbmdlZCAoY2xlYW5lZCkgaXQKICAgICAgICBzZXQodGhpcy52YWx1ZS5zcGVjLCBDTFVTVEVSX0FHRU5UX0NVU1RPTUlaQVRJT04sIGNsdXN0ZXJBZ2VudERlcGxveW1lbnRDdXN0b21pemF0aW9uKTsKICAgICAgICBzZXQodGhpcy52YWx1ZS5zcGVjLCBGTEVFVF9BR0VOVF9DVVNUT01JWkFUSU9OLCBmbGVldEFnZW50RGVwbG95bWVudEN1c3RvbWl6YXRpb24pOwogICAgICB9CiAgICB9LAoKICAgIGFzeW5jIGFjdHVhbGx5U2F2ZSh1cmwpIHsKICAgICAgaWYgKHRoaXMuZXh0ZW5zaW9uUHJvdmlkZXI/LnNhdmVDbHVzdGVyKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZXh0ZW5zaW9uUHJvdmlkZXI/LnNhdmVDbHVzdGVyKHRoaXMudmFsdWUsIHRoaXMuc2NoZW1hKTsKICAgICAgfQoKICAgICAgaWYgKCB0aGlzLmlzQ3JlYXRlICkgewogICAgICAgIHVybCA9IHVybCB8fCB0aGlzLnNjaGVtYS5saW5rRm9yKCdjb2xsZWN0aW9uJyk7CiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy52YWx1ZS5zYXZlKHsgdXJsIH0pOwoKICAgICAgICBpZiAocmVzKSB7CiAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudmFsdWUsIHJlcyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGF3YWl0IHRoaXMudmFsdWUuc2F2ZSgpOwogICAgICB9CiAgICB9LAoKICAgIC8vIGNyZWF0ZSBhIHNlY3JldCB0byByZWZlcmVuY2UgdGhlIGhhcnZlc3RlciBjbHVzdGVyIGt1YmVjb25maWcgaW4gcmtlQ29uZmlnCiAgICBhc3luYyBjcmVhdGVLdWJlY29uZmlnU2VjcmV0KGt1YmVjb25maWcgPSAnJykgewogICAgICBjb25zdCBjbHVzdGVyTmFtZSA9IHRoaXMudmFsdWUubWV0YWRhdGEubmFtZTsKICAgICAgY29uc3Qgc2VjcmV0ID0gYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ21hbmFnZW1lbnQvY3JlYXRlJywgewogICAgICAgIHR5cGU6ICAgICBTRUNSRVQsCiAgICAgICAgbWV0YWRhdGE6IHsKICAgICAgICAgIG5hbWVzcGFjZTogJ2ZsZWV0LWRlZmF1bHQnLCBnZW5lcmF0ZU5hbWU6ICdoYXJ2ZXN0ZXJjb25maWcnLCBhbm5vdGF0aW9uczogeyBbQ0FQSV9BTk5PVEFUSU9OUy5TRUNSRVRfQVVUSF06IGNsdXN0ZXJOYW1lLCBbQ0FQSV9BTk5PVEFUSU9OUy5TRUNSRVRfV0lMTF9ERUxFVEVdOiAndHJ1ZScgfQogICAgICAgIH0sCiAgICAgICAgZGF0YTogeyBjcmVkZW50aWFsOiBiYXNlNjRFbmNvZGUoa3ViZWNvbmZpZykgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBzZWNyZXQuc2F2ZSh7IHVybDogJy92MS9zZWNyZXRzJywgbWV0aG9kOiAnUE9TVCcgfSk7CiAgICB9LAoKICAgIGNhbmNlbCgpIHsKICAgICAgdGhpcy4kcm91dGVyLnB1c2goewogICAgICAgIG5hbWU6ICAgJ2MtY2x1c3Rlci1wcm9kdWN0LXJlc291cmNlJywKICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgIGNsdXN0ZXI6ICB0aGlzLiRyb3V0ZS5wYXJhbXMuY2x1c3RlciwKICAgICAgICAgIHByb2R1Y3Q6ICB0aGlzLiRzdG9yZS5nZXR0ZXJzWydwcm9kdWN0SWQnXSwKICAgICAgICAgIHJlc291cmNlOiBDQVBJLlJBTkNIRVJfQ0xVU1RFUiwKICAgICAgICB9LAogICAgICB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBFbnN1cmUgYWxsIGNoYXJ0IGluZm9ybWF0aW9uIHJlcXVpcmVkIHRvIHNob3cgYWRkb25zIGlzIGF2YWlsYWJsZQogICAgICoKICAgICAqIFRoaXMgYmFzaWNhbGx5IG1lYW5zCiAgICAgKiAxKSBUaGF0IHRoZSBmdWxsIGNoYXJ0IHJlbGF0aW5nIHRvIHRoZSBhZGRvbiBpcyBmZXRjaGVkICh3aGljaCBpbmNsdWRlcyBjb3JlIGNoYXJ0LCByZWFkbWUgYW5kIHZhbHVlcykKICAgICAqIDIpIFdlJ3JlIHJlYWR5IHRvIGNhY2hlIGFueSB2YWx1ZXMgdGhlIHVzZXIgcHJvdmlkZXMgZm9yIGVhY2ggYWRkb24KICAgICAqLwogICAgYXN5bmMgaW5pdEFkZG9ucygpIHsKICAgICAgZm9yICggY29uc3QgY2hhcnROYW1lIG9mIHRoaXMuYWRkb25OYW1lcyApIHsKICAgICAgICBjb25zdCBlbnRyeSA9IHRoaXMuY2hhcnRWZXJzaW9uc1tjaGFydE5hbWVdOwoKICAgICAgICBpZiAoIHRoaXMudmVyc2lvbkluZm9bY2hhcnROYW1lXSApIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdjYXRhbG9nL2dldFZlcnNpb25JbmZvJywgewogICAgICAgICAgICByZXBvVHlwZTogICAgJ2NsdXN0ZXInLAogICAgICAgICAgICByZXBvTmFtZTogICAgZW50cnkucmVwbywKICAgICAgICAgICAgY2hhcnROYW1lLAogICAgICAgICAgICB2ZXJzaW9uTmFtZTogZW50cnkudmVyc2lvbiwKICAgICAgICAgIH0pOwoKICAgICAgICAgIHNldCh0aGlzLnZlcnNpb25JbmZvLCBjaGFydE5hbWUsIHJlcyk7CiAgICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmNoYXJ0VmVyc2lvbktleShjaGFydE5hbWUpOwoKICAgICAgICAgIGlmICghdGhpcy51c2VyQ2hhcnRWYWx1ZXNba2V5XSkgewogICAgICAgICAgICB0aGlzLnVzZXJDaGFydFZhbHVlc1trZXldID0ge307CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGZldGNoIG9yIHByb2Nlc3MgY2hhcnQgaW5mbyBmb3IgJHsgY2hhcnROYW1lIH1gKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlCiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGxhYmVsRm9yQWRkb24obmFtZSkgewogICAgICBjb25zdCBmYWxsYmFjayA9IGAkeyBjYW1lbFRvVGl0bGUobmFtZS5yZXBsYWNlKC9eKHJrZXxya2UyfHJhbmNoZXIpLS8sICcnKSkgfSBDb25maWd1cmF0aW9uYDsKCiAgICAgIHJldHVybiB0aGlzLiRzdG9yZS5nZXR0ZXJzWydpMThuL3dpdGhGYWxsYmFjayddKGBjbHVzdGVyLmFkZG9uQ2hhcnQuIiR7IG5hbWUgfSJgLCBudWxsLCBmYWxsYmFjayk7CiAgICB9LAoKICAgIHNob3dBZGRvbnMoKSB7CiAgICAgIHRoaXMuYWRkb25zUmV2Kys7CiAgICAgIHRoaXMuYWRkb25OYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7CiAgICAgICAgY29uc3QgY2hhcnRWYWx1ZXMgPSB0aGlzLnZlcnNpb25JbmZvW25hbWVdPy5xdWVzdGlvbnMgPyB0aGlzLmluaXRZYW1sRWRpdG9yKG5hbWUpIDoge307CgogICAgICAgIHNldCh0aGlzLnVzZXJDaGFydFZhbHVlc1RlbXAsIG5hbWUsIGNoYXJ0VmFsdWVzKTsKICAgICAgfSk7CiAgICAgIHRoaXMucmVmcmVzaFlhbWxzKCk7CiAgICB9LAoKICAgIHJlZnJlc2hZYW1scygpIHsKICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuJHJlZnMpLmZpbHRlcigoeCkgPT4geC5zdGFydHNXaXRoKCd5YW1sJykpOwoKICAgICAgZm9yICggY29uc3QgayBvZiBrZXlzICkgewogICAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy4kcmVmc1trXTsKICAgICAgICBjb25zdCBsaXN0ID0gaXNBcnJheShlbnRyeSkgPyBlbnRyeSA6IFtlbnRyeV07CgogICAgICAgIGZvciAoIGNvbnN0IGNvbXBvbmVudCBvZiBsaXN0ICkgewogICAgICAgICAgY29tcG9uZW50Py5yZWZyZXNoKCk7IC8vIGB5YW1sYCByZWYgY2FuIGJlIHVuZGVmaW5lZCBvbiBzd2l0Y2hpbmcgZnJvbSBCYXNpYyB0byBBZGRvbiB0YWIgKEF6dXJlIC0tPiBBbWF6b24gLS0+IGFkZG9uKQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICB1cGRhdGVWYWx1ZXMobmFtZSwgdmFsdWVzKSB7CiAgICAgIHNldCh0aGlzLnVzZXJDaGFydFZhbHVlc1RlbXAsIG5hbWUsIHZhbHVlcyk7CiAgICAgIHRoaXMuc3luY0NoYXJ0VmFsdWVzKG5hbWUpOwogICAgfSwKCiAgICBzeW5jQ2hhcnRWYWx1ZXM6IHRocm90dGxlKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgY29uc3QgZnJvbUNoYXJ0ID0gdGhpcy52ZXJzaW9uSW5mb1tuYW1lXT8udmFsdWVzOwogICAgICBjb25zdCBmcm9tVXNlciA9IHRoaXMudXNlckNoYXJ0VmFsdWVzVGVtcFtuYW1lXTsKICAgICAgY29uc3QgZGlmZmVyZW50ID0gZGlmZihmcm9tQ2hhcnQsIGZyb21Vc2VyKTsKCiAgICAgIHRoaXMudXNlckNoYXJ0VmFsdWVzW3RoaXMuY2hhcnRWZXJzaW9uS2V5KG5hbWUpXSA9IGRpZmZlcmVudDsKICAgIH0sIDI1MCwgeyBsZWFkaW5nOiB0cnVlIH0pLAoKICAgIHVwZGF0ZVF1ZXN0aW9ucyhuYW1lKSB7CiAgICAgIHRoaXMuc3luY0NoYXJ0VmFsdWVzKG5hbWUpOwogICAgfSwKCiAgICBpbml0WWFtbEVkaXRvcihuYW1lKSB7CiAgICAgIGNvbnN0IGRlZmF1bHRDaGFydFZhbHVlID0gdGhpcy52ZXJzaW9uSW5mb1tuYW1lXTsKICAgICAgY29uc3Qga2V5ID0gdGhpcy5jaGFydFZlcnNpb25LZXkobmFtZSk7CgogICAgICByZXR1cm4gbWVyZ2Uoe30sIGRlZmF1bHRDaGFydFZhbHVlPy52YWx1ZXMgfHwge30sIHRoaXMudXNlckNoYXJ0VmFsdWVzW2tleV0gfHwge30pOwogICAgfSwKCiAgICBpbml0U2VydmVyQWdlbnRBcmdzKCkgewogICAgICBmb3IgKCBjb25zdCBrIGluIHRoaXMuc2VydmVyQXJncyApIHsKICAgICAgICBpZiAoIHRoaXMuc2VydmVyQ29uZmlnW2tdID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICBjb25zdCBkZWYgPSB0aGlzLnNlcnZlckFyZ3Nba10uZGVmYXVsdDsKCiAgICAgICAgICBzZXQodGhpcy5zZXJ2ZXJDb25maWcsIGssIChkZWYgIT09IHVuZGVmaW5lZCA/IGRlZiA6IHVuZGVmaW5lZCkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yICggY29uc3QgayBpbiB0aGlzLmFnZW50QXJncyApIHsKICAgICAgICBpZiAoIHRoaXMuYWdlbnRDb25maWdba10gPT09IHVuZGVmaW5lZCApIHsKICAgICAgICAgIGNvbnN0IGRlZiA9IHRoaXMuYWdlbnRBcmdzW2tdLmRlZmF1bHQ7CgogICAgICAgICAgc2V0KHRoaXMuYWdlbnRDb25maWcsIGssIChkZWYgIT09IHVuZGVmaW5lZCA/IGRlZiA6IHVuZGVmaW5lZCkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCAhdGhpcy5zZXJ2ZXJDb25maWc/LnByb2ZpbGUgKSB7CiAgICAgICAgc2V0KHRoaXMuc2VydmVyQ29uZmlnLCAncHJvZmlsZScsIG51bGwpOwogICAgICB9CiAgICB9LAoKICAgIGNoYXJ0VmVyc2lvbktleShuYW1lKSB7CiAgICAgIGNvbnN0IGFkZG9uVmVyc2lvbiA9IHRoaXMuYWRkb25WZXJzaW9ucy5maW5kKChhdikgPT4gYXYubmFtZSA9PT0gbmFtZSk7CgogICAgICByZXR1cm4gYWRkb25WZXJzaW9uID8gYCR7IG5hbWUgfS0keyBhZGRvblZlcnNpb24udmVyc2lvbiB9YCA6IG5hbWU7CiAgICB9LAoKICAgIG9uTWVtYmVyc2hpcFVwZGF0ZSh1cGRhdGUpIHsKICAgICAgdGhpcy4kc2V0KHRoaXMsICdtZW1iZXJzaGlwVXBkYXRlJywgdXBkYXRlKTsKICAgIH0sCgogICAgY2FuUmVtb3ZlS3ViZWxldFJvdyhyb3csIGlkeCkgewogICAgICByZXR1cm4gaWR4ICE9PSAwOwogICAgfSwKCiAgICBhc3luYyBpbml0UmVnaXN0cnkoKSB7CiAgICAgIC8vIENoZWNrIGZvciBhbiBleGlzdGluZyBjbHVzdGVyIHNjb3BlZCByZWdpc3RyeQogICAgICBjb25zdCBjbHVzdGVyUmVnaXN0cnkgPSB0aGlzLmFnZW50Q29uZmlnPy5bJ3N5c3RlbS1kZWZhdWx0LXJlZ2lzdHJ5J10gfHwgJyc7CgogICAgICAvLyBDaGVjayBmb3IgdGhlIGdsb2JhbCByZWdpc3RyeQogICAgICB0aGlzLnN5c3RlbVJlZ2lzdHJ5ID0gKGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdtYW5hZ2VtZW50L2ZpbmQnLCB7IHR5cGU6IE1BTkFHRU1FTlQuU0VUVElORywgaWQ6IFNFVFRJTkcuU1lTVEVNX0RFRkFVTFRfUkVHSVNUUlkgfSkpLnZhbHVlIHx8ICcnOwoKICAgICAgLy8gVGhlIG9yZGVyIG9mIHByZWNlZGVuY2UgaXMgdG8gdXNlIHRoZSBjbHVzdGVyIHNjb3BlZCByZWdpc3RyeQogICAgICAvLyBpZiBpdCBleGlzdHMsIHRoZW4gdXNlIHRoZSBnbG9iYWwgc2NvcGVkIHJlZ2lzdHJ5IGFzIGEgZmFsbGJhY2sKICAgICAgaWYgKGNsdXN0ZXJSZWdpc3RyeSkgewogICAgICAgIHRoaXMucmVnaXN0cnlIb3N0ID0gY2x1c3RlclJlZ2lzdHJ5OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucmVnaXN0cnlIb3N0ID0gdGhpcy5zeXN0ZW1SZWdpc3RyeTsKICAgICAgfQoKICAgICAgbGV0IHJlZ2lzdHJ5U2VjcmV0ID0gbnVsbDsKICAgICAgbGV0IHJlZ3MgPSB0aGlzLnJrZUNvbmZpZy5yZWdpc3RyaWVzOwoKICAgICAgaWYgKCAhcmVncyApIHsKICAgICAgICByZWdzID0ge307CiAgICAgICAgc2V0KHRoaXMucmtlQ29uZmlnLCAncmVnaXN0cmllcycsIHJlZ3MpOwogICAgICB9CgogICAgICBpZiAoICFyZWdzLmNvbmZpZ3MgKSB7CiAgICAgICAgc2V0KHJlZ3MsICdjb25maWdzJywge30pOwogICAgICB9CgogICAgICBpZiAoICFyZWdzLm1pcnJvcnMgKSB7CiAgICAgICAgc2V0KHJlZ3MsICdtaXJyb3JzJywge30pOwogICAgICB9CgogICAgICBjb25zdCBob3N0bmFtZSA9IE9iamVjdC5rZXlzKHJlZ3MuY29uZmlncylbMF07CiAgICAgIGNvbnN0IGNvbmZpZyA9IHJlZ3MuY29uZmlnc1tob3N0bmFtZV07CgogICAgICBpZiAoIGNvbmZpZyApIHsKICAgICAgICByZWdpc3RyeVNlY3JldCA9IGNvbmZpZy5hdXRoQ29uZmlnU2VjcmV0TmFtZTsKICAgICAgfQoKICAgICAgdGhpcy5yZWdpc3RyeVNlY3JldCA9IHJlZ2lzdHJ5U2VjcmV0OwoKICAgICAgY29uc3QgaGFzTWlycm9yc09yQXV0aENvbmZpZyA9IE9iamVjdC5rZXlzKHJlZ3MuY29uZmlncykubGVuZ3RoID4gMCB8fCBPYmplY3Qua2V5cyhyZWdzLm1pcnJvcnMpLmxlbmd0aCA+IDA7CgogICAgICBpZiAodGhpcy5yZWdpc3RyeUhvc3QgfHwgcmVnaXN0cnlTZWNyZXQgfHwgaGFzTWlycm9yc09yQXV0aENvbmZpZykgewogICAgICAgIHRoaXMuc2hvd0N1c3RvbVJlZ2lzdHJ5SW5wdXQgPSB0cnVlOwoKICAgICAgICBpZiAoaGFzTWlycm9yc09yQXV0aENvbmZpZykgewogICAgICAgICAgdGhpcy5zaG93Q3VzdG9tUmVnaXN0cnlBZHZhbmNlZElucHV0ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0UmVnaXN0cnlDb25maWcoKSB7CiAgICAgIGNvbnN0IGhvc3RuYW1lID0gKHRoaXMucmVnaXN0cnlIb3N0IHx8ICcnKS50cmltKCk7CgogICAgICBpZiAoIHRoaXMuc3lzdGVtUmVnaXN0cnkgKSB7CiAgICAgICAgLy8gRW1wdHkgc3RyaW5nIG92ZXJyaWRlcyB0aGUgc3lzdGVtIGRlZmF1bHQgdG8gbm90aGluZwogICAgICAgIHNldCh0aGlzLmFnZW50Q29uZmlnLCAnc3lzdGVtLWRlZmF1bHQtcmVnaXN0cnknLCAnJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTm8gbmVlZCB0byBzZXQgYW55dGhpbmcKICAgICAgICBzZXQodGhpcy5hZ2VudENvbmZpZywgJ3N5c3RlbS1kZWZhdWx0LXJlZ2lzdHJ5JywgdW5kZWZpbmVkKTsKICAgICAgfQogICAgICBpZiAoICFob3N0bmFtZSB8fCBob3N0bmFtZSA9PT0gdGhpcy5zeXN0ZW1SZWdpc3RyeSApIHsKICAgICAgICAvLyBVbmRlZmluZWQgcmVtb3ZlcyB0aGUga2V5IHdoaWNoIHVzZXMgdGhlIGdsb2JhbCBzZXR0aW5nIHdpdGhvdXQgaGFyZGNvZGluZyBpdCBpbnRvIHRoZSBjb25maWcKICAgICAgICBzZXQodGhpcy5hZ2VudENvbmZpZywgJ3N5c3RlbS1kZWZhdWx0LXJlZ2lzdHJ5JywgdW5kZWZpbmVkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXQodGhpcy5hZ2VudENvbmZpZywgJ3N5c3RlbS1kZWZhdWx0LXJlZ2lzdHJ5JywgaG9zdG5hbWUpOwogICAgICB9CgogICAgICBpZiAoIGhvc3RuYW1lICYmIHRoaXMucmVnaXN0cnlTZWNyZXQgKSB7CiAgICAgICAgLy8gRm9yIGEgcmVnaXN0cnkgd2l0aCBiYXNpYyBhdXRoLCBidXQgbm8gbWlycm9ycywKICAgICAgICAvLyBhZGQgYSBzaW5nbGUgcmVnaXN0cnkgY29uZmlnIHdpdGggdGhlIGJhc2ljIGF1dGggc2VjcmV0LgogICAgICAgIGNvbnN0IGJhc2ljQXV0aENvbmZpZyA9IHsKICAgICAgICAgIFtob3N0bmFtZV06IHsKICAgICAgICAgICAgYXV0aENvbmZpZ1NlY3JldE5hbWU6IHRoaXMucmVnaXN0cnlTZWNyZXQsCiAgICAgICAgICAgIGNhQnVuZGxlOiAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICBpbnNlY3VyZVNraXBWZXJpZnk6ICAgZmFsc2UsCiAgICAgICAgICAgIHRsc1NlY3JldE5hbWU6ICAgICAgICBudWxsLAogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHJrZUNvbmZpZyA9IHRoaXMudmFsdWUuc3BlYy5ya2VDb25maWc7CgogICAgICAgIGlmICghcmtlQ29uZmlnKSB7CiAgICAgICAgICB0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnID0geyByZWdpc3RyaWVzOiB7IGNvbmZpZ3M6IGJhc2ljQXV0aENvbmZpZyB9IH07CiAgICAgICAgfSBlbHNlIGlmIChya2VDb25maWcucmVnaXN0cmllcy5jb25maWdzICYmIE9iamVjdC5rZXlzKHJrZUNvbmZpZy5yZWdpc3RyaWVzLmNvbmZpZ3MpLmxlbmd0aCA+IDApIHsKICAgICAgICAgIC8vIElmIHNvbWUgZXhpc3RpbmcgYXV0aGVudGljYXRpb24gc2VjcmV0cyBhcmUgYWxyZWFkeSBjb25maWd1cmVkCiAgICAgICAgICAvLyBmb3IgcmVnaXN0cnkgbWlycm9ycywgdGhlIGJhc2ljIGF1dGggaXMgYWRkZWQgdG8gdGhlIGV4aXN0aW5nIG9uZXMuCiAgICAgICAgICBjb25zdCBleGlzdGluZ0NvbmZpZ3MgPSBya2VDb25maWcucmVnaXN0cmllcy5jb25maWdzOwoKICAgICAgICAgIHRoaXMudmFsdWUuc3BlYy5ya2VDb25maWcucmVnaXN0cmllcy5jb25maWdzID0geyAuLi5iYXNpY0F1dGhDb25maWcsIC4uLmV4aXN0aW5nQ29uZmlncyB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBleGlzdGluZ01pcnJvckFuZEF1dGhDb25maWcgPSB0aGlzLnZhbHVlLnNwZWMucmtlQ29uZmlnLnJlZ2lzdHJpZXM7CgogICAgICAgICAgdGhpcy52YWx1ZS5zcGVjLnJrZUNvbmZpZy5yZWdpc3RyaWVzID0gewogICAgICAgICAgICAuLi5leGlzdGluZ01pcnJvckFuZEF1dGhDb25maWcsCiAgICAgICAgICAgIGNvbmZpZ3M6IGJhc2ljQXV0aENvbmZpZwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgdXBkYXRlQ29uZmlncyhjb25maWdzKSB7CiAgICAgIC8vIFVwZGF0ZSBhdXRoZW50aWNhdGlvbiBjb25maWd1cmF0aW9uCiAgICAgIC8vIGZvciBlYWNoIG1pcnJvcgogICAgICBpZiAoIXRoaXMudmFsdWUuc3BlYz8ucmtlQ29uZmlnKSB7CiAgICAgICAgdGhpcy52YWx1ZS5zcGVjLnJrZUNvbmZpZyA9IHsgcmVnaXN0cmllczoge30gfTsKICAgICAgfQogICAgICBzZXQodGhpcy52YWx1ZS5zcGVjLnJrZUNvbmZpZy5yZWdpc3RyaWVzLCAnY29uZmlncycsIGNvbmZpZ3MpOwogICAgfSwKCiAgICBnZXRBbGxPcHRpb25zQWZ0ZXJDdXJyZW50VmVyc2lvbih2ZXJzaW9ucywgY3VycmVudFZlcnNpb24sIGRlZmF1bHRWZXJzaW9uKSB7CiAgICAgIGNvbnN0IG91dCA9ICh2ZXJzaW9ucyB8fCBbXSkuZmlsdGVyKChvYmopID0+ICEhb2JqLnNlcnZlckFyZ3MpLm1hcCgob2JqKSA9PiB7CiAgICAgICAgbGV0IGRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgbGV0IGV4cGVyaW1lbnRhbCA9IGZhbHNlOwogICAgICAgIGxldCBpc0N1cnJlbnRWZXJzaW9uID0gZmFsc2U7CiAgICAgICAgbGV0IGxhYmVsID0gb2JqLmlkOwoKICAgICAgICBpZiAoIGN1cnJlbnRWZXJzaW9uICkgewogICAgICAgICAgZGlzYWJsZWQgPSBjb21wYXJlKG9iai5pZCwgY3VycmVudFZlcnNpb24pIDwgMDsKICAgICAgICAgIGlzQ3VycmVudFZlcnNpb24gPSBjb21wYXJlKG9iai5pZCwgY3VycmVudFZlcnNpb24pID09PSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKCBkZWZhdWx0VmVyc2lvbiApIHsKICAgICAgICAgIGV4cGVyaW1lbnRhbCA9IGNvbXBhcmUoZGVmYXVsdFZlcnNpb24sIG9iai5pZCkgPCAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzQ3VycmVudFZlcnNpb24pIHsKICAgICAgICAgIGxhYmVsID0gYCR7IGxhYmVsIH0gJHsgdGhpcy50KCdjbHVzdGVyLmt1YmVybmV0ZXNWZXJzaW9uLmN1cnJlbnQnKSB9YDsKICAgICAgICB9CgogICAgICAgIGlmIChleHBlcmltZW50YWwpIHsKICAgICAgICAgIGxhYmVsID0gYCR7IGxhYmVsIH0gJHsgdGhpcy50KCdjbHVzdGVyLmt1YmVybmV0ZXNWZXJzaW9uLmV4cGVyaW1lbnRhbCcpIH1gOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxhYmVsLAogICAgICAgICAgdmFsdWU6ICAgICAgb2JqLmlkLAogICAgICAgICAgc29ydDogICAgICAgc29ydGFibGUob2JqLmlkKSwKICAgICAgICAgIHNlcnZlckFyZ3M6IG9iai5zZXJ2ZXJBcmdzLAogICAgICAgICAgYWdlbnRBcmdzOiAgb2JqLmFnZW50QXJncywKICAgICAgICAgIGNoYXJ0czogICAgIG9iai5jaGFydHMsCiAgICAgICAgICBkaXNhYmxlZCwKICAgICAgICB9OwogICAgICB9KTsKCiAgICAgIGlmIChjdXJyZW50VmVyc2lvbiAmJiAhb3V0LmZpbmQoKG9iaikgPT4gb2JqLnZhbHVlID09PSBjdXJyZW50VmVyc2lvbikpIHsKICAgICAgICBvdXQucHVzaCh7CiAgICAgICAgICBsYWJlbDogYCR7IGN1cnJlbnRWZXJzaW9uIH0gJHsgdGhpcy50KCdjbHVzdGVyLmt1YmVybmV0ZXNWZXJzaW9uLmN1cnJlbnQnKSB9YCwKICAgICAgICAgIHZhbHVlOiBjdXJyZW50VmVyc2lvbiwKICAgICAgICAgIHNvcnQ6ICBzb3J0YWJsZShjdXJyZW50VmVyc2lvbiksCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHNvcnRlZCA9IHNvcnRCeShvdXQsICdzb3J0OmRlc2MnKTsKCiAgICAgIGNvbnN0IG1vc3RSZWNlbnRQYXRjaFZlcnNpb25zID0gdGhpcy5nZXRNb3N0UmVjZW50UGF0Y2hWZXJzaW9ucyhzb3J0ZWQpOwoKICAgICAgY29uc3Qgc29ydGVkV2l0aERlcHJlY2F0ZWRMYWJlbCA9IHNvcnRlZC5tYXAoKG9wdGlvbkRhdGEpID0+IHsKICAgICAgICBjb25zdCBtYWpvck1pbm9yID0gYCR7IHNlbXZlci5tYWpvcihvcHRpb25EYXRhLnZhbHVlKSB9LiR7IHNlbXZlci5taW5vcihvcHRpb25EYXRhLnZhbHVlKSB9YDsKCiAgICAgICAgaWYgKG1vc3RSZWNlbnRQYXRjaFZlcnNpb25zW21ham9yTWlub3JdID09PSBvcHRpb25EYXRhLnZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gb3B0aW9uRGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAuLi5vcHRpb25EYXRhLAogICAgICAgICAgbGFiZWw6IGAkeyBvcHRpb25EYXRhLmxhYmVsIH0gJHsgdGhpcy50KCdjbHVzdGVyLmt1YmVybmV0ZXNWZXJzaW9uLmRlcHJlY2F0ZWQnKSB9YAogICAgICAgIH07CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHNvcnRlZFdpdGhEZXByZWNhdGVkTGFiZWw7CiAgICB9LAoKICAgIGdldE1vc3RSZWNlbnRQYXRjaFZlcnNpb25zKHNvcnRlZFZlcnNpb25zKSB7CiAgICAgIC8vIEdldCB0aGUgbW9zdCByZWNlbnQgcGF0Y2ggdmVyc2lvbiBmb3IgZWFjaCBLdWJlcm5ldGVzIG1pbm9yIHZlcnNpb24uCiAgICAgIGNvbnN0IHZlcnNpb25NYXAgPSB7fTsKCiAgICAgIHNvcnRlZFZlcnNpb25zLmZvckVhY2goKHZlcnNpb24pID0+IHsKICAgICAgICBjb25zdCBtYWpvck1pbm9yID0gYCR7IHNlbXZlci5tYWpvcih2ZXJzaW9uLnZhbHVlKSB9LiR7IHNlbXZlci5taW5vcih2ZXJzaW9uLnZhbHVlKSB9YDsKCiAgICAgICAgaWYgKCF2ZXJzaW9uTWFwW21ham9yTWlub3JdKSB7CiAgICAgICAgICAvLyBCZWNhdXNlIHdlIHN0YXJ0IHdpdGggYSBzb3J0ZWQgbGlzdCBvZiB2ZXJzaW9ucywgd2Uga25vdyB0aGUKICAgICAgICAgIC8vIGhpZ2hlc3QgcGF0Y2ggdmVyc2lvbiBpcyBmaXJzdCBpbiB0aGUgbGlzdCwgc28gd2Ugb25seSBrZWVwIHRoZQogICAgICAgICAgLy8gZmlyc3Qgb2YgZWFjaCBtaW5vciB2ZXJzaW9uIGluIHRoZSBsaXN0LgogICAgICAgICAgdmVyc2lvbk1hcFttYWpvck1pbm9yXSA9IHZlcnNpb24udmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiB2ZXJzaW9uTWFwOwogICAgfSwKCiAgICBmaWx0ZXJPdXREZXByZWNhdGVkUGF0Y2hWZXJzaW9ucyhhbGxWZXJzaW9ucywgY3VycmVudFZlcnNpb24pIHsKICAgICAgLy8gR2V0IHRoZSBtb3N0IHJlY2VudCBwYXRjaCB2ZXJzaW9uIGZvciBlYWNoIEt1YmVybmV0ZXMgbWlub3IgdmVyc2lvbi4KICAgICAgY29uc3QgbW9zdFJlY2VudFBhdGNoVmVyc2lvbnMgPSB0aGlzLmdldE1vc3RSZWNlbnRQYXRjaFZlcnNpb25zKGFsbFZlcnNpb25zKTsKCiAgICAgIGNvbnN0IGZpbHRlcmVkVmVyc2lvbnMgPSBhbGxWZXJzaW9ucy5maWx0ZXIoKHZlcnNpb24pID0+IHsKICAgICAgICAvLyBBbHdheXMgc2hvdyBwcmUtcmVsZWFzZXMKICAgICAgICBpZiAoc2VtdmVyLnByZXJlbGVhc2UodmVyc2lvbi52YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgbWFqb3JNaW5vciA9IGAkeyBzZW12ZXIubWFqb3IodmVyc2lvbi52YWx1ZSkgfS4keyBzZW12ZXIubWlub3IodmVyc2lvbi52YWx1ZSkgfWA7CgogICAgICAgIC8vIEFsd2F5cyBzaG93IGN1cnJlbnQgdmVyc2lvbiwgZWxzZSBzaG93IGlmIHdlIGhhdmVuJ3Qgc2hvd24gYW55dGhpbmcgZm9yIHRoaXMgbWFqb3IubWlub3IgdmVyc2lvbiB5ZXQKICAgICAgICBpZiAodmVyc2lvbi52YWx1ZSA9PT0gY3VycmVudFZlcnNpb24gfHwgbW9zdFJlY2VudFBhdGNoVmVyc2lvbnNbbWFqb3JNaW5vcl0gPT09IHZlcnNpb24udmFsdWUpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9KTsKCiAgICAgIHJldHVybiBmaWx0ZXJlZFZlcnNpb25zOwogICAgfSwKCiAgICBnZW5lcmF0ZVlhbWwoKSB7CiAgICAgIGNvbnN0IHJlc291cmNlID0gdGhpcy52YWx1ZTsKICAgICAgY29uc3QgaW5TdG9yZSA9IHRoaXMuJHN0b3JlLmdldHRlcnNbJ2N1cnJlbnRTdG9yZSddKHJlc291cmNlKTsKICAgICAgY29uc3Qgc2NoZW1hcyA9IHRoaXMuJHN0b3JlLmdldHRlcnNbYCR7IGluU3RvcmUgfS9hbGxgXShTQ0hFTUEpOwogICAgICBjb25zdCBjbG9uZWRSZXNvdXJjZSA9IGNsb25lKHJlc291cmNlKTsKCiAgICAgIHRoaXMuYXBwbHlDaGFydFZhbHVlcyhjbG9uZWRSZXNvdXJjZS5zcGVjLnJrZUNvbmZpZyk7CgogICAgICBjb25zdCBvdXQgPSBjcmVhdGVZYW1sKHNjaGVtYXMsIHJlc291cmNlLnR5cGUsIGNsb25lZFJlc291cmNlKTsKCiAgICAgIHJldHVybiBvdXQ7CiAgICB9LAoKICAgIGFwcGx5Q2hhcnRWYWx1ZXMocmtlQ29uZmlnKSB7CiAgICAgIHJrZUNvbmZpZy5jaGFydFZhbHVlcyA9IHt9OwogICAgICB0aGlzLmFkZG9uTmFtZXMuZm9yRWFjaCgobmFtZSkgPT4gewogICAgICAgIGNvbnN0IGtleSA9IHRoaXMuY2hhcnRWZXJzaW9uS2V5KG5hbWUpOwogICAgICAgIGNvbnN0IHVzZXJWYWx1ZXMgPSB0aGlzLnVzZXJDaGFydFZhbHVlc1trZXldOwoKICAgICAgICBpZiAodXNlclZhbHVlcykgewogICAgICAgICAgc2V0KHJrZUNvbmZpZy5jaGFydFZhbHVlcywgbmFtZSwgdXNlclZhbHVlcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBnZXQsCgogICAgc2V0SGFydmVzdGVyRGVmYXVsdENsb3VkUHJvdmlkZXIoKSB7CiAgICAgIGlmICh0aGlzLmlzSGFydmVzdGVyRHJpdmVyICYmCiAgICAgICAgdGhpcy5tb2RlID09PSBfQ1JFQVRFICYmCiAgICAgICAgIXRoaXMuYWdlbnRDb25maWdbJ2Nsb3VkLXByb3ZpZGVyLW5hbWUnXSAmJgogICAgICAgICF0aGlzLmlzSGFydmVzdGVyRXh0ZXJuYWxDcmVkZW50aWFsICYmCiAgICAgICAgIXRoaXMuaXNIYXJ2ZXN0ZXJJbmNvbXBhdGlibGUKICAgICAgKSB7CiAgICAgICAgdGhpcy5hZ2VudENvbmZpZ1snY2xvdWQtcHJvdmlkZXItbmFtZSddID0gSEFSVkVTVEVSOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWdlbnRDb25maWdbJ2Nsb3VkLXByb3ZpZGVyLW5hbWUnXSA9ICcnOwogICAgICB9CiAgICB9LAoKICAgIGFzeW5jIHNldEhhcnZlc3RlclZlcnNpb25SYW5nZSgpIHsKICAgICAgY29uc3QgY2x1c3RlcklkID0gdGhpcy5jcmVkZW50aWFsPy5kZWNvZGVkRGF0YT8uY2x1c3RlcklkOwogICAgICBjb25zdCBjbHVzdGVyVHlwZSA9IHRoaXMuY3JlZGVudGlhbD8uZGVjb2RlZERhdGE/LmNsdXN0ZXJUeXBlOwoKICAgICAgaWYgKGNsdXN0ZXJJZCAmJiBjbHVzdGVyVHlwZSA9PT0gJ2ltcG9ydGVkJykgewogICAgICAgIGNvbnN0IHVybCA9IGAvazhzL2NsdXN0ZXJzLyR7IGNsdXN0ZXJJZCB9L3YxYDsKICAgICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnY2x1c3Rlci9yZXF1ZXN0JywgeyB1cmw6IGAkeyB1cmwgfS8keyBIQ0kuU0VUVElORyB9c2AgfSk7CgogICAgICAgIGNvbnN0IHZlcnNpb24gPSAocmVzPy5kYXRhIHx8IFtdKS5maW5kKChzKSA9PiBzLmlkID09PSAnaGFydmVzdGVyLWNzaS1jY20tdmVyc2lvbnMnKTsKCiAgICAgICAgaWYgKHZlcnNpb24pIHsKICAgICAgICAgIHRoaXMuaGFydmVzdGVyVmVyc2lvblJhbmdlID0gSlNPTi5wYXJzZSh2ZXJzaW9uLnZhbHVlIHx8IHZlcnNpb24uZGVmYXVsdCB8fCAne30nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5oYXJ2ZXN0ZXJWZXJzaW9uUmFuZ2UgPSB7fTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5zZXRIYXJ2ZXN0ZXJEZWZhdWx0Q2xvdWRQcm92aWRlcigpOwogICAgfSwKICAgIHRvZ2dsZUN1c3RvbVJlZ2lzdHJ5KGUpIHsKICAgICAgaWYgKHRoaXMucmVnaXN0cnlIb3N0KSB7CiAgICAgICAgdGhpcy5yZWdpc3RyeUhvc3QgPSBudWxsOwogICAgICAgIHRoaXMucmVnaXN0cnlTZWNyZXQgPSBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuaW5pdFJlZ2lzdHJ5KCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBHZXQgcHJvdmlzaW9uZWQgUktFMiBjbHVzdGVyIFBTUHMgaW4gZWRpdCBtb2RlCiAgICAgKi8KICAgIGFzeW5jIGdldFBzcHMoKSB7CiAgICAgIC8vIEFzIHNlcnZlciByZXR1cm5zIDUwMCB3ZSBleGNsdWRlIGFsbCB0aGUgcG9zc2libGUgY2FzZXMKICAgICAgaWYgKAogICAgICAgIHRoaXMubW9kZSAhPT0gX0NSRUFURSAmJgogICAgICAgICF0aGlzLmlzSzNzICYmCiAgICAgICAgdGhpcy52YWx1ZS5zdGF0ZSAhPT0gJ3JlY29uY2lsaW5nJyAmJgogICAgICAgIHRoaXMuZ2V0TmVlZHNQU1AodGhpcy5saXZlVmFsdWUpIC8vIFdlIGNvbnNpZGVyIGVkaXRpbmcgb25seSBwb3NzaWJsZSBQU1AgY2FzZXMKICAgICAgKSB7CiAgICAgICAgY29uc3QgY2x1c3RlcklkID0gdGhpcy52YWx1ZS5tZ210Q2x1c3RlcklkOwogICAgICAgIGNvbnN0IHVybCA9IGAvazhzL2NsdXN0ZXJzLyR7IGNsdXN0ZXJJZCB9L3YxLyR7IFBTUFMgfWA7CgogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ2NsdXN0ZXIvcmVxdWVzdCcsIHsgdXJsIH0pOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAvLyBQU1AgbWF5IG5vdCBleGlzdHMgZm9yIHRoaXMgY2x1c3RlciBhbmQgYW4gZXJyb3IgaXMgcmV0dXJuZWQgd2l0aG91dCBuZWVkIHRvIGhhbmRsZQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIFJlc2V0IFBTQSBvbiBzZXZlcmFsIGlucHV0IGNoYW5nZXMgZm9yIGdpdmVuIGNvbmRpdGlvbnMKICAgICAqLwogICAgdG9nZ2xlUHNhRGVmYXVsdCgpIHsKICAgICAgLy8gVGhpcyBvcHRpb24gaXMgY3JlYXRlZCBmcm9tIHRoZSBzZXJ2ZXIgYW5kIGlzIGd1YXJhbnRlZWQgdG8gZXhpc3QgIzgwMzIKICAgICAgY29uc3QgaGFyZGNvZGVkVGVtcGxhdGUgPSAncmFuY2hlci1yZXN0cmljdGVkJzsKICAgICAgY29uc3QgY2lzVmFsdWUgPSB0aGlzLmFnZW50Q29uZmlnPy5wcm9maWxlIHx8IHRoaXMuc2VydmVyQ29uZmlnPy5wcm9maWxlOwoKICAgICAgaWYgKCF0aGlzLmNpc092ZXJyaWRlKSB7CiAgICAgICAgaWYgKHRoaXMuaGFzUHNhVGVtcGxhdGVzICYmIGNpc1ZhbHVlKSB7CiAgICAgICAgICBzZXQodGhpcy52YWx1ZS5zcGVjLCAnZGVmYXVsdFBvZFNlY3VyaXR5QWRtaXNzaW9uQ29uZmlndXJhdGlvblRlbXBsYXRlTmFtZScsIGhhcmRjb2RlZFRlbXBsYXRlKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2lzUHNhQ2hhbmdlQmFubmVyID0gdGhpcy5oYXNQc2FUZW1wbGF0ZXM7CiAgICAgIH0KICAgIH0sCgogICAgaGFuZGxlQ2lzQ2hhbmdlKCkgewogICAgICB0aGlzLnRvZ2dsZVBzYURlZmF1bHQoKTsKICAgICAgdGhpcy51cGRhdGVDaXNQcm9maWxlKCk7CiAgICB9LAoKICAgIHVwZGF0ZUNpc1Byb2ZpbGUoKSB7CiAgICAgIC8vIElmIHRoZSB1c2VyIHNlbGVjdHMgYW55IFdvcmtlciBDSVMgUHJvZmlsZSwKICAgICAgLy8gcHJvdGVjdC1rZXJuZWwtZGVmYXVsdHMgc2hvdWxkIGJlIHNldCB0byBmYWxzZQogICAgICAvLyBpbiB0aGUgUktFMiB3b3JrZXIvYWdlbnQgY29uZmlnLgogICAgICBjb25zdCBzZWxlY3RlZENpc1Byb2ZpbGUgPSB0aGlzLmFnZW50Q29uZmlnPy5wcm9maWxlOwoKICAgICAgaWYgKHNlbGVjdGVkQ2lzUHJvZmlsZSkgewogICAgICAgIHNldCh0aGlzLmFnZW50Q29uZmlnLCAncHJvdGVjdC1rZXJuZWwtZGVmYXVsdHMnLCB0cnVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXQodGhpcy5hZ2VudENvbmZpZywgJ3Byb3RlY3Qta2VybmVsLWRlZmF1bHRzJywgZmFsc2UpOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogSGFuZGxlIGs4cyBjaGFuZ2VzIHNpZGUgZWZmZWN0cywgbGlrZSBQU1AgYW5kIFBTQSByZXNldHMKICAgICAqLwogICAgaGFuZGxlS3ViZXJuZXRlc0NoYW5nZSh2YWx1ZSkgewogICAgICBpZiAodmFsdWUpIHsKICAgICAgICB0aGlzLnRvZ2dsZVBzYURlZmF1bHQoKTsKICAgICAgICBjb25zdCB2ZXJzaW9uID0gVkVSU0lPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgY29uc3QgbWFqb3IgPSBwYXJzZUludCh2ZXJzaW9uPy5bMF0gfHwgMCk7CiAgICAgICAgY29uc3QgbWlub3IgPSBwYXJzZUludCh2ZXJzaW9uPy5bMV0gfHwgMCk7CgogICAgICAgIC8vIFJlc2V0IFBTQSBpZiBub3QgUktFMgogICAgICAgIGlmICghdmFsdWUuaW5jbHVkZXMoJ3JrZTInKSkgewogICAgICAgICAgc2V0KHRoaXMudmFsdWUuc3BlYywgJ2RlZmF1bHRQb2RTZWN1cml0eVBvbGljeVRlbXBsYXRlTmFtZScsICcnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gUmVzZXQgUFNQIGlmIGl0J3MgbGVnYWN5IGR1ZSBrOHMgdmVyc2lvbiAxLjI1KwogICAgICAgICAgaWYgKG1ham9yID09PSAxICYmIG1pbm9yID49IDI1KSB7CiAgICAgICAgICAgIHNldCh0aGlzLnZhbHVlLnNwZWMsICdkZWZhdWx0UG9kU2VjdXJpdHlQb2xpY3lUZW1wbGF0ZU5hbWUnLCAnJyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXQodGhpcy52YWx1ZS5zcGVjLCAnZGVmYXVsdFBvZFNlY3VyaXR5UG9saWN5VGVtcGxhdGVOYW1lJywgdGhpcy5sYXN0RGVmYXVsdFBvZFNlY3VyaXR5UG9saWN5VGVtcGxhdGVOYW1lKTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLnByZXZpb3VzS3ViZXJuZXRlc1ZlcnNpb24gPSB2YWx1ZTsKICAgICAgICB9CgogICAgICAgIC8vIElmIEhhcnZlc3RlciBkcml2ZXIsIHJlc2V0IGNsb3VkIHByb3ZpZGVyIGlmIG5vdCBjb21wYXRpYmxlCiAgICAgICAgaWYgKHRoaXMuaXNIYXJ2ZXN0ZXJEcml2ZXIgJiYgdGhpcy5tb2RlID09PSBfQ1JFQVRFICYmIHRoaXMuaXNIYXJ2ZXN0ZXJJbmNvbXBhdGlibGUpIHsKICAgICAgICAgIHRoaXMuc2V0SGFydmVzdGVyRGVmYXVsdENsb3VkUHJvdmlkZXIoKTsKICAgICAgICB9CgogICAgICAgIC8vIENsb3VkIFByb3ZpZGVyIGNoZWNrCiAgICAgICAgLy8gSWYgdGhlIGNsb3VkIHByb3ZpZGVyIGlzIHVuc3VwcG9ydGVkLCBzd2l0Y2ggcHJvdmlkZXIgdG8gJ2V4dGVybmFsJwogICAgICAgIGlmICh0aGlzLnVuc3VwcG9ydGVkQ2xvdWRQcm92aWRlcikgewogICAgICAgICAgc2V0KHRoaXMuYWdlbnRDb25maWcsICdjbG91ZC1wcm92aWRlci1uYW1lJywgJ2V4dGVybmFsJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFN3aXRjaCB0aGUgY2xvdWQgcHJvdmlkZXIgYmFjayB0byB0aGUgaW5pdGlhbCB2YWx1ZQogICAgICAgICAgLy8gVXNlIGNoYW5nZWQgdGhlIEt1YmVybmV0ZXMgdmVyc2lvbiBiYWNrIHRvIGEgdmVyc2lvbiB3aGVyZSB0aGUgaW5pdGlhbCBjbG91ZCBwcm92aWRlciBpcyB2YWxpZCAtIHNvIHN3aXRjaCBiYWNrIHRvIHRoaXMgb25lCiAgICAgICAgICAvLyB0byB1bmRvIHRoZSBjaGFuZ2UgdG8gZXh0ZXJuYWwgdGhhdCB3ZSBtYXkgaGF2ZSBtYWRlCiAgICAgICAgICAvLyBOb3RlOiBDbG91ZCBQcm92aWRlciBjYW4gb25seSBiZSBjaGFuZ2VkIG9uIGVkaXQgd2hlbiB0aGUgaW5pdGlhbCBwcm92aWRlciBpcyBubyBsb25nZXIgc3VwcG9ydGVkCiAgICAgICAgICBzZXQodGhpcy5hZ2VudENvbmZpZywgJ2Nsb3VkLXByb3ZpZGVyLW5hbWUnLCB0aGlzLmluaXRpYWxDbG91ZFByb3ZpZGVyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBLZWVwIGxhc3QgUFNQIHZhbHVlCiAgICAgKi8KICAgIGhhbmRsZVBzcENoYW5nZSh2YWx1ZSkgewogICAgICB0aGlzLmxhc3REZWZhdWx0UG9kU2VjdXJpdHlQb2xpY3lUZW1wbGF0ZU5hbWUgPSB2YWx1ZTsKICAgIH0sCgogICAgaGFuZGxlU2hvd0RlcHJlY2F0ZWRQYXRjaFZlcnNpb25zQ2hhbmdlZCh2YWx1ZSkgewogICAgICB0aGlzLnNob3dEZXByZWNhdGVkUGF0Y2hWZXJzaW9ucyA9IHZhbHVlOwogICAgfSwKICAgIC8qKgogICAgICogVHJhY2sgTWFjaGluZSBQb29sIHZhbGlkYXRpb24gc3RhdHVzCiAgICAgKi8KICAgIG1hY2hpbmVQb29sVmFsaWRhdGlvbkNoYW5nZWQoaWQsIHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy4kZGVsZXRlKHRoaXMubWFjaGluZVBvb2xWYWxpZGF0aW9uLCBpZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy4kc2V0KHRoaXMubWFjaGluZVBvb2xWYWxpZGF0aW9uLCBpZCwgdmFsdWUpOwogICAgICB9CiAgICB9LAogICAgaGFuZGxlRW5hYmxlZFN5c3RlbVNlcnZpY2VzQ2hhbmdlZCh2YWwpIHsKICAgICAgc2V0KHRoaXMuc2VydmVyQ29uZmlnLCAnZGlzYWJsZScsIHZhbCk7CiAgICB9LAogICAgaGFuZGxlQ2lsaXVtSXB2NkNoYW5nZWQobmV1KSB7CiAgICAgIGNvbnN0IG5hbWUgPSB0aGlzLmNoYXJ0VmVyc2lvbktleSgncmtlMi1jaWxpdW0nKTsKICAgICAgY29uc3QgdmFsdWVzID0gdGhpcy51c2VyQ2hhcnRWYWx1ZXNbbmFtZV07CgogICAgICBzZXQodGhpcywgJ3VzZXJDaGFydFZhbHVlcycsIHsKICAgICAgICAuLi50aGlzLnVzZXJDaGFydFZhbHVlcywKICAgICAgICBbbmFtZV06IHsKICAgICAgICAgIC4uLnZhbHVlcywKICAgICAgICAgIGNpbGl1bTogewogICAgICAgICAgICAuLi52YWx1ZXM/LmNpbGl1bSwKICAgICAgICAgICAgaXB2NjogewogICAgICAgICAgICAgIC4uLnZhbHVlcz8uY2lsaXVtPy5pcHY2LAogICAgICAgICAgICAgIGVuYWJsZWQ6IG5ldQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBoYW5kbGVQc3BDaGFuZ2VkKG5ldSkgewogICAgICB0aGlzLmhhbmRsZVBzcENoYW5nZShuZXUpOwogICAgfSwKICAgIGhhbmRsZUNpc0NoYW5nZWQoKSB7CiAgICAgIHRoaXMuaGFuZGxlQ2lzQ2hhbmdlKCk7CiAgICB9LAogICAgaGFuZGxlUHNhRGVmYXVsdENoYW5nZWQoKSB7CiAgICAgIHRoaXMudG9nZ2xlUHNhRGVmYXVsdCgpOwogICAgfSwKICAgIGhhbmRsZU1hY2hpbmVQb29sRXJyb3IoZXJyb3IpIHsKICAgICAgdGhpcy5tYWNoaW5lUG9vbEVycm9ycyA9IG1lcmdlKHRoaXMubWFjaGluZVBvb2xFcnJvcnMsIGVycm9yKTsKCiAgICAgIGNvbnN0IGVycm9ycyA9IE9iamVjdC5lbnRyaWVzKHRoaXMubWFjaGluZVBvb2xFcnJvcnMpCiAgICAgICAgLm1hcCgoeCkgPT4gewogICAgICAgICAgaWYgKCF4WzFdLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgZm9ybWF0dGVkRmllbGRzID0gKCgpID0+IHsKICAgICAgICAgICAgc3dpdGNoICh4WzFdLmxlbmd0aCkgewogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgcmV0dXJuIHhbMV1bMF07CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICByZXR1cm4gYCR7IHhbMV1bMF0gfSBhbmQgJHsgeFsxXVsxXSB9YDsKICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIGNvbnN0IFtoZWFkLCAuLi5yZXN0XSA9IHhbMV07CgogICAgICAgICAgICAgIHJldHVybiBgJHsgcmVzdC5qb2luKCcsICcpIH0sIGFuZCAkeyBoZWFkIH1gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pKCk7CgogICAgICAgICAgcmV0dXJuIHRoaXMudCgnY2x1c3Rlci5iYW5uZXIubWFjaGluZVBvb2xFcnJvcicsIHsKICAgICAgICAgICAgY291bnQ6IHhbMV0ubGVuZ3RoLCBwb29sX25hbWU6IHhbMF0sIGZpZWxkczogZm9ybWF0dGVkRmllbGRzCiAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICB9ICkKICAgICAgICAuZmlsdGVyKCh4KSA9PiB4KTsKCiAgICAgIGlmICghZXJyb3JzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmVycm9ycyA9IGVycm9yczsKICAgIH0KICB9LAp9Owo="},{"version":3,"sources":["rke2.vue"],"names":[],"mappings":";AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA","file":"rke2.vue","sourceRoot":"node_modules/@rancher/shell/edit/provisioning.cattle.io.cluster","sourcesContent":["<script>\nimport difference from 'lodash/difference';\nimport throttle from 'lodash/throttle';\nimport isArray from 'lodash/isArray';\nimport merge from 'lodash/merge';\nimport CreateEditView from '@shell/mixins/create-edit-view';\nimport FormValidation from '@shell/mixins/form-validation';\nimport { normalizeName } from '@shell/utils/kube';\n\nimport {\n  CAPI,\n  MANAGEMENT,\n  NAMESPACE,\n  NORMAN,\n  SCHEMA,\n  DEFAULT_WORKSPACE,\n  SECRET,\n  HCI,\n  PSPS,\n} from '@shell/config/types';\nimport { _CREATE, _EDIT, _VIEW } from '@shell/config/query-params';\n\nimport { findBy, removeObject, clear } from '@shell/utils/array';\nimport { createYaml } from '@shell/utils/create-yaml';\nimport {\n  clone, diff, set, get, isEmpty\n} from '@shell/utils/object';\nimport { allHash } from '@shell/utils/promise';\nimport { sortBy } from '@shell/utils/sort';\n\nimport { camelToTitle } from '@shell/utils/string';\nimport { compare, sortable } from '@shell/utils/version';\nimport { isHarvesterSatisfiesVersion } from '@shell/utils/cluster';\nimport * as VERSION from '@shell/utils/version';\n\nimport ArrayList from '@shell/components/form/ArrayList';\nimport ArrayListGrouped from '@shell/components/form/ArrayListGrouped';\nimport { BadgeState } from '@components/BadgeState';\nimport { Banner } from '@components/Banner';\nimport { Checkbox } from '@components/Form/Checkbox';\nimport CruResource, { CONTEXT_HOOK_EDIT_YAML } from '@shell/components/CruResource';\nimport { LabeledInput } from '@components/Form/LabeledInput';\nimport LabeledSelect from '@shell/components/form/LabeledSelect';\nimport Loading from '@shell/components/Loading';\nimport MatchExpressions from '@shell/components/form/MatchExpressions';\nimport NameNsDescription from '@shell/components/form/NameNsDescription';\nimport { RadioGroup } from '@components/Form/Radio';\nimport Tab from '@shell/components/Tabbed/Tab';\nimport Tabbed from '@shell/components/Tabbed';\nimport UnitInput from '@shell/components/form/UnitInput';\nimport YamlEditor from '@shell/components/YamlEditor';\nimport Questions from '@shell/components/Questions';\n\nimport { canViewClusterMembershipEditor } from '@shell/components/form/Members/ClusterMembershipEditor';\nimport SelectOrCreateAuthSecret from '@shell/components/form/SelectOrCreateAuthSecret';\nimport semver from 'semver';\n\nimport { SETTING } from '@shell/config/settings';\nimport { base64Encode } from '@shell/utils/crypto';\nimport { CAPI as CAPI_ANNOTATIONS } from '@shell/config/labels-annotations';\nimport ACE from './ACE';\nimport AgentEnv from './AgentEnv';\nimport DrainOptions from './DrainOptions';\nimport Labels from './Labels';\nimport MachinePool from './MachinePool';\nimport RegistryConfigs from './RegistryConfigs';\nimport RegistryMirrors from './RegistryMirrors';\nimport S3Config from './S3Config';\nimport SelectCredential from './SelectCredential';\nimport AdvancedSection from '@shell/components/AdvancedSection.vue';\nimport { ELEMENTAL_SCHEMA_IDS, KIND, ELEMENTAL_CLUSTER_PROVIDER } from '../../config/elemental-types';\nimport AgentConfiguration from './AgentConfiguration';\nimport { getApplicableExtensionEnhancements } from '@shell/core/plugin-helpers';\nimport { ExtensionPoint, TabLocation } from '@shell/core/types';\nimport MemberRoles from '@shell/edit/provisioning.cattle.io.cluster/MemberRoles';\nimport Basics from '@shell/edit/provisioning.cattle.io.cluster/Basics';\n\nconst HARVESTER = 'harvester';\nconst HARVESTER_CLOUD_PROVIDER = 'harvester-cloud-provider';\n\nconst NETBIOS_TRUNCATION_LENGTH = 15;\n\n/**\n * Classes to be adopted by the node badges in Machine pools\n */\nconst NODE_TOTAL = {\n  error: {\n    color: 'bg-error',\n    icon:  'icon-x',\n  },\n  warning: {\n    color: 'bg-warning',\n    icon:  'icon-warning',\n  },\n  success: {\n    color: 'bg-success',\n    icon:  'icon-checkmark'\n  }\n};\nconst CLUSTER_AGENT_CUSTOMIZATION = 'clusterAgentDeploymentCustomization';\nconst FLEET_AGENT_CUSTOMIZATION = 'fleetAgentDeploymentCustomization';\n\nexport default {\n  components: {\n    ACE,\n    AdvancedSection,\n    AgentEnv,\n    ArrayList,\n    ArrayListGrouped,\n    BadgeState,\n    Banner,\n    Checkbox,\n    AgentConfiguration,\n    CruResource,\n    DrainOptions,\n    LabeledInput,\n    LabeledSelect,\n    Labels,\n    Loading,\n    MachinePool,\n    MatchExpressions,\n    NameNsDescription,\n    Questions,\n    RadioGroup,\n    RegistryConfigs,\n    RegistryMirrors,\n    S3Config,\n    SelectCredential,\n    SelectOrCreateAuthSecret,\n    Tab,\n    Tabbed,\n    UnitInput,\n    YamlEditor,\n    MemberRoles,\n    Basics\n  },\n\n  mixins: [CreateEditView, FormValidation],\n\n  props: {\n    mode: {\n      type:     String,\n      required: true,\n    },\n\n    value: {\n      type:     Object,\n      required: true,\n    },\n\n    provider: {\n      type:     String,\n      required: true,\n    },\n  },\n\n  async fetch() {\n    this.psps = await this.getPsps();\n    await this.fetchRke2Versions();\n    await this.initSpecs();\n    await this.initAddons();\n    await this.initRegistry();\n\n    Object.entries(this.chartValues).forEach(([name, value]) => {\n      const key = this.chartVersionKey(name);\n\n      this.userChartValues[key] = value;\n    });\n\n    this.setAgentConfiguration();\n  },\n\n  data() {\n    if ( !this.value.spec.rkeConfig ) {\n      set(this.value.spec, 'rkeConfig', {});\n    }\n\n    if ( !this.value.spec.rkeConfig.chartValues ) {\n      set(this.value.spec.rkeConfig, 'chartValues', {});\n    }\n\n    if ( !this.value.spec.rkeConfig.upgradeStrategy ) {\n      set(this.value.spec.rkeConfig, 'upgradeStrategy', {\n        controlPlaneConcurrency:  '1',\n        controlPlaneDrainOptions: {},\n        workerConcurrency:        '1',\n        workerDrainOptions:       {},\n      });\n    }\n\n    if ( !this.value.spec.rkeConfig.machineGlobalConfig ) {\n      set(this.value.spec, 'rkeConfig.machineGlobalConfig', {});\n    }\n\n    if ( !this.value.spec.rkeConfig.machineSelectorConfig?.length ) {\n      set(this.value.spec, 'rkeConfig.machineSelectorConfig', [{ config: {} }]);\n    }\n\n    // Store the initial PSP template name, so we can set it back if needed\n    const lastDefaultPodSecurityPolicyTemplateName = this.value.spec.defaultPodSecurityPolicyTemplateName;\n    const previousKubernetesVersion = this.value.spec.kubernetesVersion;\n\n    const truncateLimit = this.value.defaultHostnameLengthLimit;\n\n    return {\n      loadedOnce:                      false,\n      lastIdx:                         0,\n      allPSPs:                         null,\n      allPSAs:                         [],\n      credentialId:                    '',\n      credential:                      null,\n      machinePools:                    null,\n      rke2Versions:                    null,\n      k3sVersions:                     null,\n      defaultRke2:                     '',\n      defaultK3s:                      '',\n      s3Backup:                        false,\n      /**\n       * All info related to a specific version of the chart\n       *\n       * This includes chart itself, README and values\n       *\n       * { [chartName:string]: { chart: json, readme: string, values: json } }\n       */\n      versionInfo:                     {},\n      membershipUpdate:                {},\n      showDeprecatedPatchVersions:     false,\n      systemRegistry:                  null,\n      registryHost:                    null,\n      showCustomRegistryInput:         false,\n      showCustomRegistryAdvancedInput: false,\n      registrySecret:                  null,\n      userChartValues:                 {},\n      userChartValuesTemp:             {},\n      addonsRev:                       0,\n      clusterIsAlreadyCreated:         !!this.value.id,\n      fvFormRuleSets:                  [{\n        path: 'metadata.name', rules: ['subDomain'], translationKey: 'nameNsDescription.name.label'\n      }],\n      harvesterVersionRange: {},\n      lastDefaultPodSecurityPolicyTemplateName, // Used for reset on k8s version changes\n      previousKubernetesVersion,\n      cisOverride:           false,\n      cisPsaChangeBanner:    false,\n      psps:                  null, // List of policies if any\n      truncateHostnames:     truncateLimit === NETBIOS_TRUNCATION_LENGTH,\n      truncateLimit,\n      busy:                  false,\n      machinePoolValidation: {}, // map of validation states for each machine pool\n      machinePoolErrors:     {},\n      allNamespaces:         [],\n      initialCloudProvider:  this.value?.agentConfig?.['cloud-provider-name'] || '',\n      extensionTabs:         getApplicableExtensionEnhancements(this, ExtensionPoint.TAB, TabLocation.CLUSTER_CREATE_RKE2, this.$route, this),\n    };\n  },\n\n  computed: {\n\n    rkeConfig() {\n      return this.value.spec.rkeConfig;\n    },\n\n    hostnameTruncationManuallySet() {\n      return this.truncateLimit && this.truncateLimit !== NETBIOS_TRUNCATION_LENGTH;\n    },\n\n    isElementalCluster() {\n      return this.provider === ELEMENTAL_CLUSTER_PROVIDER || this.value?.machineProvider?.toLowerCase() === KIND.MACHINE_INV_SELECTOR_TEMPLATES.toLowerCase();\n    },\n\n    advancedTitleAlt() {\n      const machineSelectorLength = this.rkeConfig.machineSelectorConfig.length;\n\n      return this.t('cluster.advanced.argInfo.machineSelector.titleAlt', { count: machineSelectorLength });\n    },\n\n    chartValues() {\n      return this.value.spec.rkeConfig.chartValues;\n    },\n\n    serverConfig() {\n      return this.value.spec.rkeConfig.machineGlobalConfig;\n    },\n\n    agentConfig() {\n      return this.value.agentConfig;\n    },\n\n    /**\n     * Define PSP deprecation and restrict use of PSP based on min k8s version\n     */\n    needsPSP() {\n      return this.getNeedsPSP();\n    },\n\n    /**\n     * Define introduction of Rancher defined PSA templates\n     */\n    hasPsaTemplates() {\n      return !this.needsPSP;\n    },\n\n    unsupportedSelectorConfig() {\n      let global = 0;\n      let kubeletOnly = 0;\n      let other = 0;\n\n      // The form supports one config that has no selector for all the main parts\n      // And one or more configs that have a selector and exactly only kubelet-args.\n      // If there are any other properties set, or multiple configs with no selector\n      // show a warning that you're editing only part of the config in the UI.\n\n      for ( const conf of this.value.spec?.rkeConfig?.machineSelectorConfig ) {\n        if ( conf.machineLabelSelector ) {\n          const keys = Object.keys(conf.config || {});\n\n          if ( keys.length === 0 || (keys.length === 1 && keys[0] === 'kubelet-arg') ) {\n            kubeletOnly++;\n          } else {\n            other++;\n          }\n        } else {\n          global++;\n        }\n      }\n\n      // eslint-disable-next-line no-console\n      console.log(`Global: ${ global }, Kubelet Only: ${ kubeletOnly }, Other: ${ other }`);\n\n      return ( global > 1 || other > 0 );\n    },\n\n    versionOptions() {\n      const cur = this.liveValue?.spec?.kubernetesVersion || '';\n      const existingRke2 = this.mode === _EDIT && cur.includes('rke2');\n      const existingK3s = this.mode === _EDIT && cur.includes('k3s');\n\n      let allValidRke2Versions = this.getAllOptionsAfterCurrentVersion(this.rke2Versions, (existingRke2 ? cur : null), this.defaultRke2);\n      let allValidK3sVersions = this.getAllOptionsAfterCurrentVersion(this.k3sVersions, (existingK3s ? cur : null), this.defaultK3s);\n\n      if (!this.showDeprecatedPatchVersions) {\n        // Normally, we only want to show the most recent patch version\n        // for each Kubernetes minor version. However, if the user\n        // opts in to showing deprecated versions, we don't filter them.\n        allValidRke2Versions = this.filterOutDeprecatedPatchVersions(allValidRke2Versions, cur);\n        allValidK3sVersions = this.filterOutDeprecatedPatchVersions(allValidK3sVersions, cur);\n      }\n\n      const showRke2 = allValidRke2Versions.length && !existingK3s;\n      const showK3s = allValidK3sVersions.length && !existingRke2;\n      const out = [];\n\n      if ( showRke2 ) {\n        if ( showK3s ) {\n          out.push({ kind: 'group', label: this.t('cluster.provider.rke2') });\n        }\n\n        out.push(...allValidRke2Versions);\n      }\n\n      if ( showK3s ) {\n        if ( showRke2 ) {\n          out.push({ kind: 'group', label: this.t('cluster.provider.k3s') });\n        }\n\n        out.push(...allValidK3sVersions);\n      }\n\n      if ( cur ) {\n        const existing = out.find((x) => x.value === cur);\n\n        if ( existing ) {\n          existing.disabled = false;\n        }\n      }\n\n      return out;\n    },\n\n    isK3s() {\n      return (this.value?.spec?.kubernetesVersion || '').includes('k3s');\n    },\n\n    /**\n     * Kube Version\n     */\n    selectedVersion() {\n      const str = this.value.spec.kubernetesVersion;\n\n      if ( !str ) {\n        return;\n      }\n\n      const out = findBy(this.versionOptions, 'value', str);\n\n      return out;\n    },\n\n    haveArgInfo() {\n      return Boolean(this.selectedVersion?.serverArgs && this.selectedVersion?.agentArgs);\n    },\n\n    serverArgs() {\n      return this.selectedVersion?.serverArgs || {};\n    },\n\n    agentArgs() {\n      return this.selectedVersion?.agentArgs || {};\n    },\n\n    /**\n     * The addons (kube charts) applicable for the selected kube version\n     *\n     * { [chartName:string]: { repo: string, version: string } }\n     */\n    chartVersions() {\n      return this.selectedVersion?.charts || {};\n    },\n\n    needCredential() {\n      if ( this.provider === 'custom' || this.provider === 'import' || this.isElementalCluster || this.mode === _VIEW ) {\n        return false;\n      }\n\n      if (this.customCredentialComponentRequired === false) {\n        return false;\n      }\n\n      return true;\n    },\n\n    /**\n     * Only for extensions - extension can register a 'false' cloud credential to indicate that a cloud credential is not needed\n     */\n    customCredentialComponentRequired() {\n      return this.$plugin.getDynamic('cloud-credential', this.provider);\n    },\n\n    hasMachinePools() {\n      if ( this.provider === 'custom' || this.provider === 'import' ) {\n        return false;\n      }\n\n      return true;\n    },\n\n    unremovedMachinePools() {\n      return (this.machinePools || []).filter((x) => !x.remove);\n    },\n\n    /**\n     * Extension provider where being provisioned by an extension\n     */\n    extensionProvider() {\n      const extClass = this.$plugin.getDynamic('provisioner', this.provider);\n\n      if (extClass) {\n        return new extClass({\n          dispatch: this.$store.dispatch,\n          getters:  this.$store.getters,\n          axios:    this.$store.$axios,\n          $plugin:  this.$store.app.$plugin,\n          $t:       this.t,\n          isCreate: this.isCreate\n        });\n      }\n\n      return undefined;\n    },\n\n    /**\n     * Is a namespace needed? Only supported for providers from extensions, otherwise default is no\n     */\n    needsNamespace() {\n      return this.extensionProvider ? !!this.extensionProvider.namespaced : false;\n    },\n\n    machineConfigSchema() {\n      let schema;\n\n      if ( !this.hasMachinePools ) {\n        return null;\n      } else if (this.isElementalCluster) {\n        schema = ELEMENTAL_SCHEMA_IDS.MACHINE_INV_SELECTOR_TEMPLATES;\n      } else {\n        schema = `${ CAPI.MACHINE_CONFIG_GROUP }.${ this.provider }config`;\n      }\n\n      // If this is an extension provider then the extension can provide the schema\n      const extensionSchema = this.extensionProvider?.machineConfigSchema;\n\n      if (extensionSchema) {\n        // machineConfigSchema can either be the schema name (string) or the schema itself (object)\n        if (typeof extensionSchema === 'object') {\n          return extensionSchema;\n        }\n\n        // Name of schema to use\n        schema = extensionSchema;\n      }\n\n      return this.$store.getters['management/schemaFor'](schema);\n    },\n\n    nodeTotals() {\n      const roles = ['etcd', 'controlPlane', 'worker'];\n      const counts = {};\n      const out = {\n        color:   {},\n        label:   {},\n        icon:    {},\n        tooltip: {},\n      };\n\n      for ( const role of roles ) {\n        counts[role] = 0;\n        out.color[role] = NODE_TOTAL.success.color;\n        out.icon[role] = NODE_TOTAL.success.icon;\n      }\n\n      for ( const row of this.machinePools || [] ) {\n        if ( row.remove ) {\n          continue;\n        }\n\n        const qty = parseInt(row.pool.quantity, 10);\n\n        if ( isNaN(qty) ) {\n          continue;\n        }\n\n        for ( const role of roles ) {\n          counts[role] = counts[role] + (row.pool[`${ role }Role`] ? qty : 0);\n        }\n      }\n\n      for ( const role of roles ) {\n        out.label[role] = this.t(`cluster.machinePool.nodeTotals.label.${ role }`, { count: counts[role] });\n        out.tooltip[role] = this.t(`cluster.machinePool.nodeTotals.tooltip.${ role }`, { count: counts[role] });\n      }\n\n      if ( counts.etcd === 0 ) {\n        out.color.etcd = NODE_TOTAL.error.color;\n        out.icon.etcd = NODE_TOTAL.error.icon;\n      } else if ( counts.etcd === 1 || counts.etcd % 2 === 0 || counts.etcd > 7 ) {\n        out.color.etcd = NODE_TOTAL.warning.color;\n        out.icon.etcd = NODE_TOTAL.warning.icon;\n      }\n\n      if ( counts.controlPlane === 0 ) {\n        out.color.controlPlane = NODE_TOTAL.error.color;\n        out.icon.controlPlane = NODE_TOTAL.error.icon;\n      } else if ( counts.controlPlane === 1 ) {\n        out.color.controlPlane = NODE_TOTAL.warning.color;\n        out.icon.controlPlane = NODE_TOTAL.warning.icon;\n      }\n\n      if ( counts.worker === 0 ) {\n        out.color.worker = NODE_TOTAL.error.color;\n        out.icon.worker = NODE_TOTAL.error.icon;\n      } else if ( counts.worker === 1 ) {\n        out.color.worker = NODE_TOTAL.warning.color;\n        out.icon.worker = NODE_TOTAL.warning.icon;\n      }\n\n      return out;\n    },\n\n    showCni() {\n      return !!this.serverArgs.cni;\n    },\n\n    showCloudProvider() {\n      return !!this.agentArgs['cloud-provider-name'];\n    },\n\n    /**\n     * The chart names of the addons applicable to the current kube version and selected cloud provider\n     */\n    addonNames() {\n      const names = [];\n      const cni = this.serverConfig.cni;\n\n      if (typeof cni === 'string') {\n        names.push(...cni.split(',').map((x) => `rke2-${ x }`));\n      } else if (Array.isArray(cni)) {\n        names.push(...cni.map((x) => `rke2-${ x }`));\n      }\n\n      if (this.showCloudProvider) { // Shouldn't be removed such that changes to it will re-trigger this watch\n        if ( this.agentConfig['cloud-provider-name'] === 'rancher-vsphere' ) {\n          names.push('rancher-vsphere-cpi', 'rancher-vsphere-csi');\n        }\n\n        if ( this.agentConfig['cloud-provider-name'] === HARVESTER ) {\n          names.push(HARVESTER_CLOUD_PROVIDER);\n        }\n      }\n\n      return names;\n    },\n\n    /**\n     * The charts of the addons applicable to the current kube version and selected cloud provider\n     *\n     * These are the charts themselves and do not include chart readme or values\n     */\n    addonVersions() {\n      const versions = this.addonNames.map((name) => this.versionInfo[name]?.chart);\n\n      return versions.filter((x) => !!x);\n    },\n\n    cloudProviderOptions() {\n      const out = [{\n        label: this.$store.getters['i18n/t']('cluster.rke2.cloudProvider.defaultValue.label'),\n        value: '',\n      }];\n\n      if ( !!this.agentArgs['cloud-provider-name']?.options ) {\n        const preferred = this.$store.getters['plugins/cloudProviderForDriver'](this.provider);\n\n        for ( const opt of this.agentArgs['cloud-provider-name']?.options ) {\n        // If we don't have a preferred provider... show all options\n          const showAllOptions = preferred === undefined;\n          // If we have a preferred provider... only show default, preferred and external\n          const isPreferred = opt === preferred;\n          const isExternal = opt === 'external';\n          let disabled = false;\n\n          if ((this.isHarvesterExternalCredential || this.isHarvesterIncompatible) && isPreferred) {\n            disabled = true;\n          }\n\n          if (showAllOptions || isPreferred || isExternal) {\n            out.push({\n              label: this.$store.getters['i18n/withFallback'](`cluster.cloudProvider.\"${ opt }\".label`, null, opt),\n              value: opt,\n              disabled,\n            });\n          }\n        }\n      }\n\n      const cur = this.agentConfig['cloud-provider-name'];\n\n      if (cur && !out.find((x) => x.value === cur)) {\n        // Localization missing\n        // Look up cur in the localization file\n        const label = this.$store.getters['i18n/withFallback'](`cluster.cloudProvider.\"${ cur }\".label`, null, cur);\n\n        out.unshift({\n          label:       `${ label } (Current)`,\n          value:       cur,\n          unsupported: true,\n          disabled:    true\n        });\n      }\n\n      const initial = this.initialCloudProvider;\n\n      if (cur !== initial && initial && !out.find((x) => x.value === initial)) {\n        const label = this.$store.getters['i18n/withFallback'](`cluster.cloudProvider.\"${ initial }\".label`, null, initial);\n\n        out.unshift({\n          label:       `${ label } (Current)`,\n          value:       initial,\n          unsupported: true,\n          disabled:    true\n        });\n      }\n\n      return out;\n    },\n\n    canManageMembers() {\n      return canViewClusterMembershipEditor(this.$store);\n    },\n\n    isHarvesterDriver() {\n      return this.$route.query.type === HARVESTER;\n    },\n\n    defaultVersion() {\n      const all = this.versionOptions.filter((x) => !!x.value);\n      const first = all[0]?.value;\n      const preferred = all.find((x) => x.value === this.defaultRke2)?.value;\n\n      const rke2 = this.getAllOptionsAfterCurrentVersion(this.rke2Versions, null);\n      const showRke2 = rke2.length;\n      let out;\n\n      if (this.isHarvesterDriver && showRke2) {\n        const satisfiesVersion = rke2.filter((v) => {\n          return isHarvesterSatisfiesVersion(v.value);\n        }) || [];\n\n        if (satisfiesVersion.length > 0) {\n          out = satisfiesVersion[0]?.value;\n        }\n      }\n\n      if ( !out ) {\n        out = preferred || first;\n      }\n\n      return out;\n    },\n\n    showIpv6Warning() {\n      const clusterCIDR = this.serverConfig['cluster-cidr'] || '';\n      const serviceCIDR = this.serverConfig['service-cidr'] || '';\n\n      return clusterCIDR.includes(':') || serviceCIDR.includes(':');\n    },\n\n    appsOSWarning() {\n      if (this.mode !== _EDIT ) {\n        return null;\n      }\n      const { linuxWorkerCount, windowsWorkerCount } = this.value?.mgmt?.status || {};\n\n      if (!windowsWorkerCount) {\n        if (!!this.machinePools.find((pool) => {\n          return pool?.config?.os === 'windows';\n        })) {\n          return this.t('cluster.banner.os', { newOS: 'Windows', existingOS: 'Linux' });\n        }\n      } else if (!linuxWorkerCount) {\n        if (this.machinePools.find((pool) => {\n          return pool?.config?.os === 'linux';\n        })) {\n          return this.t('cluster.banner.os', { newOS: 'Linux', existingOS: 'Windows' });\n        }\n      }\n\n      return null;\n    },\n\n    showForm() {\n      return !!this.credentialId || !this.needCredential;\n    },\n\n    isHarvesterExternalCredential() {\n      return this.credential?.harvestercredentialConfig?.clusterType === 'external';\n    },\n\n    isHarvesterIncompatible() {\n      let ccmRke2Version = (this.chartVersions['harvester-cloud-provider'] || {})['version'];\n      let csiRke2Version = (this.chartVersions['harvester-csi-driver'] || {})['version'];\n\n      const ccmVersion = this.harvesterVersionRange?.['harvester-cloud-provider'];\n      const csiVersion = this.harvesterVersionRange?.['harvester-csi-provider'];\n\n      if ((ccmRke2Version || '').endsWith('00')) {\n        ccmRke2Version = ccmRke2Version.slice(0, -2);\n      }\n\n      if ((csiRke2Version || '').endsWith('00')) {\n        csiRke2Version = csiRke2Version.slice(0, -2);\n      }\n\n      if (ccmVersion && csiVersion) {\n        if (semver.satisfies(ccmRke2Version, ccmVersion) &&\n          semver.satisfies(csiRke2Version, csiVersion)) {\n          return false;\n        } else {\n          return true;\n        }\n      } else {\n        return false;\n      }\n    },\n\n    validationPassed() {\n      const validRequiredPools = this.hasMachinePools ? this.hasRequiredNodes() : true;\n\n      let base = (this.provider === 'custom' || this.isElementalCluster || !!this.credentialId || !this.needCredential);\n\n      // and in all of the validation statuses for each machine pool\n      Object.values(this.machinePoolValidation).forEach((v) => (base = base && v));\n\n      return validRequiredPools && base;\n    },\n    unsupportedCloudProvider() {\n      // The current cloud provider\n      const cur = this.initialCloudProvider;\n\n      const provider = cur && this.cloudProviderOptions.find((x) => x.value === cur);\n\n      return !!provider?.unsupported;\n    },\n  },\n\n  watch: {\n    s3Backup(neu) {\n      if ( neu ) {\n        // We need to make sure that s3 doesn't already have an existing value otherwise when editing a cluster with s3 defined this will clear s3.\n        if (isEmpty(this.rkeConfig.etcd?.s3)) {\n          set(this.rkeConfig.etcd, 's3', {});\n        }\n      } else {\n        set(this.rkeConfig.etcd, 's3', null);\n      }\n    },\n\n    credentialId(val) {\n      if ( val ) {\n        this.credential = this.$store.getters['rancher/byId'](NORMAN.CLOUD_CREDENTIAL, this.credentialId);\n\n        if (this.isHarvesterDriver) {\n          this.setHarvesterVersionRange();\n        }\n      } else {\n        this.credential = null;\n      }\n\n      this.value.spec.cloudCredentialSecretName = val;\n    },\n\n    addonNames(neu, old) {\n      // To catch the 'some addons' --> 'no addons' case also check array length (`difference([], [1,2,3]) === []`)\n      const diff = old.length !== neu.length || difference(neu, old).length ;\n\n      if (diff) {\n        // Allow time for addonNames to update... then fetch any missing addons\n        this.$nextTick(() => this.initAddons());\n      }\n    },\n\n    selectedVersion() {\n      this.versionInfo = {}; // Invalidate cache such that version info relevent to selected kube version is updated\n\n      // Allow time for addonNames to update... then fetch any missing addons\n      this.$nextTick(() => this.initAddons());\n      if (this.mode === _CREATE) {\n        this.initServerAgentArgs();\n      }\n    },\n\n    showCni(neu) {\n      // Update `serverConfig.cni to recalculate addonNames...\n      // ... which will eventually update `value.spec.rkeConfig.chartValues`\n      if (neu) {\n        // Type supports CNI, assign default if we can\n        if (!this.serverConfig.cni) {\n          const def = this.serverArgs.cni.default;\n\n          set(this.serverConfig, 'cni', def);\n        }\n      } else {\n        // Type doesn't support cni, clear `cni`\n        set(this.serverConfig, 'cni', undefined);\n      }\n    },\n\n    showCloudProvider(neu) {\n      if (!neu) {\n        // No cloud provider available? Then clear cloud provider setting. This will recalculate addonNames...\n        // ... which will eventually update `value.spec.rkeConfig.chartValues`\n        set(this.agentConfig, 'cloud-provider-name', undefined);\n      }\n    },\n  },\n\n  created() {\n    this.registerBeforeHook(this.saveMachinePools, 'save-machine-pools', 1);\n    this.registerBeforeHook(this.setRegistryConfig, 'set-registry-config');\n    this.registerAfterHook(this.cleanupMachinePools, 'cleanup-machine-pools');\n    this.registerAfterHook(this.saveRoleBindings, 'save-role-bindings');\n\n    // Register any hooks for this extension provider\n    if (this.extensionProvider?.registerSaveHooks) {\n      this.extensionProvider.registerSaveHooks(this.registerBeforeHook, this.registerAfterHook, this.value);\n    }\n  },\n\n  methods: {\n    set,\n\n    /**\n     * Initialize all the cluster specs\n     */\n    async initSpecs() {\n      if ( !this.value.spec ) {\n        set(this.value, 'spec', {});\n      }\n\n      if ( !this.value.spec.machineSelectorConfig ) {\n        set(this.value.spec, 'machineSelectorConfig', []);\n      }\n\n      if ( !this.value.spec.machineSelectorConfig.find((x) => !x.machineLabelSelector) ) {\n        this.value.spec.machineSelectorConfig.unshift({ config: {} });\n      }\n\n      if ( this.value.spec.cloudCredentialSecretName ) {\n        await this.$store.dispatch('rancher/findAll', { type: NORMAN.CLOUD_CREDENTIAL });\n        this.credentialId = `${ this.value.spec.cloudCredentialSecretName }`;\n      }\n\n      if ( !this.value.spec.kubernetesVersion ) {\n        set(this.value.spec, 'kubernetesVersion', this.defaultVersion);\n      }\n\n      if ( this.rkeConfig.etcd?.s3?.bucket ) {\n        this.s3Backup = true;\n      }\n\n      if ( !this.rkeConfig.etcd ) {\n        set(this.rkeConfig, 'etcd', {\n          disableSnapshots:     false,\n          s3:                   null,\n          snapshotRetention:    5,\n          snapshotScheduleCron: '0 */5 * * *',\n        });\n      } else if (typeof this.rkeConfig.etcd.disableSnapshots === 'undefined') {\n        const disableSnapshots = !this.rkeConfig.etcd.snapshotRetention && !this.rkeConfig.etcd.snapshotScheduleCron;\n\n        set(this.rkeConfig.etcd, 'disableSnapshots', disableSnapshots);\n      }\n\n      // Namespaces if required - this is mainly for custom provisioners via extensions that want\n      // to allow creating their resources in a different namespace\n      if (this.needsNamespace) {\n        this.allNamespaces = await this.$store.dispatch('management/findAll', { type: NAMESPACE });\n      }\n\n      if ( !this.machinePools ) {\n        await this.initMachinePools(this.value.spec.rkeConfig.machinePools);\n        if ( this.mode === _CREATE && !this.machinePools.length ) {\n          await this.addMachinePool();\n        }\n      }\n\n      if ( this.value.spec.defaultPodSecurityPolicyTemplateName === undefined ) {\n        set(this.value.spec, 'defaultPodSecurityPolicyTemplateName', '');\n      }\n\n      if ( this.value.spec.defaultPodSecurityAdmissionConfigurationTemplateName === undefined ) {\n        set(this.value.spec, 'defaultPodSecurityAdmissionConfigurationTemplateName', '');\n      }\n    },\n\n    /**\n     * Fetch RKE versions and their configurations to be mapped to the form\n     */\n    async fetchRke2Versions() {\n      if ( !this.rke2Versions ) {\n        const hash = {\n          rke2Versions: this.$store.dispatch('management/request', { url: '/v1-rke2-release/releases' }),\n          k3sVersions:  this.$store.dispatch('management/request', { url: '/v1-k3s-release/releases' }),\n        };\n\n        if ( this.$store.getters['management/canList'](MANAGEMENT.POD_SECURITY_POLICY_TEMPLATE) ) {\n          hash.allPSPs = await this.$store.dispatch('management/findAll', { type: MANAGEMENT.POD_SECURITY_POLICY_TEMPLATE });\n        }\n\n        if (this.$store.getters['management/canList'](MANAGEMENT.PSA)) {\n          hash.allPSAs = await this.$store.dispatch('management/findAll', { type: MANAGEMENT.PSA });\n        }\n\n        // Get the latest versions from the global settings if possible\n        const globalSettings = await this.$store.getters['management/all'](MANAGEMENT.SETTING) || [];\n        const defaultRke2Setting = globalSettings.find((setting) => setting.id === 'rke2-default-version') || {};\n        const defaultK3sSetting = globalSettings.find((setting) => setting.id === 'k3s-default-version') || {};\n\n        let defaultRke2 = defaultRke2Setting?.value || defaultRke2Setting?.default;\n        let defaultK3s = defaultK3sSetting?.value || defaultK3sSetting?.default;\n\n        // RKE2: Use the channel if we can not get the version from the settings\n        if (!defaultRke2) {\n          hash.rke2Channels = this.$store.dispatch('management/request', { url: '/v1-rke2-release/channels' });\n        }\n\n        // K3S: Use the channel if we can not get the version from the settings\n        if (!defaultK3s) {\n          hash.k3sChannels = this.$store.dispatch('management/request', { url: '/v1-k3s-release/channels' });\n        }\n\n        const res = await allHash(hash);\n\n        this.allPSPs = res.allPSPs || [];\n        this.allPSAs = res.allPSAs || [];\n        this.rke2Versions = res.rke2Versions.data || [];\n        this.k3sVersions = res.k3sVersions.data || [];\n\n        if (!defaultRke2) {\n          const rke2Channels = res.rke2Channels.data || [];\n\n          defaultRke2 = rke2Channels.find((x) => x.id === 'default')?.latest;\n        }\n\n        if (!defaultK3s) {\n          const k3sChannels = res.k3sChannels.data || [];\n\n          defaultK3s = k3sChannels.find((x) => x.id === 'default')?.latest;\n        }\n\n        if ( !this.rke2Versions.length && !this.k3sVersions.length ) {\n          throw new Error('No version info found in KDM');\n        }\n\n        // Store default versions\n        this.defaultRke2 = defaultRke2;\n        this.defaultK3s = defaultK3s;\n      }\n    },\n\n    cleanAgentConfiguration(model, key) {\n      if (!model || !model[key]) {\n        return;\n      }\n\n      const v = model[key];\n\n      if (Array.isArray(v) && v.length === 0) {\n        delete model[key];\n      } else if (v && typeof v === 'object') {\n        Object.keys(v).forEach((k) => {\n          // delete these auxiliary props used in podAffinity and nodeAffinity that shouldn't be sent to the server\n          if (k === '_namespaceOption' || k === '_namespaces' || k === '_anti' || k === '_id') {\n            delete v[k];\n          }\n\n          // prevent cleanup of \"namespaceSelector\" when an empty object because it represents all namespaces in pod/node affinity\n          // https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#podaffinityterm-v1-core\n          if (k !== 'namespaceSelector') {\n            this.cleanAgentConfiguration(v, k);\n          }\n        });\n\n        if (Object.keys(v).length === 0) {\n          delete model[key];\n        }\n      }\n    },\n\n    /**\n     * Clean agent configuration objects, so we only send values when the user has configured something\n     */\n    agentConfigurationCleanup() {\n      this.cleanAgentConfiguration(this.value.spec, CLUSTER_AGENT_CUSTOMIZATION);\n      this.cleanAgentConfiguration(this.value.spec, FLEET_AGENT_CUSTOMIZATION);\n    },\n\n    /**\n     * Ensure we have empty models for the two agent configurations\n     */\n    setAgentConfiguration() {\n      // Cluster Agent Configuration\n      if ( !this.value.spec[CLUSTER_AGENT_CUSTOMIZATION]) {\n        set(this.value.spec, CLUSTER_AGENT_CUSTOMIZATION, {});\n      }\n\n      // Fleet Agent Configuration\n      if ( !this.value.spec[FLEET_AGENT_CUSTOMIZATION] ) {\n        set(this.value.spec, FLEET_AGENT_CUSTOMIZATION, {});\n      }\n    },\n\n    /**\n     * set instanceNameLimit to 15 to all pool machine if truncateHostnames checkbox is clicked\n     */\n    truncateName() {\n      if (this.truncateHostnames) {\n        this.value.defaultHostnameLengthLimit = NETBIOS_TRUNCATION_LENGTH;\n      } else {\n        this.value.removeDefaultHostnameLengthLimit();\n      }\n    },\n    /**\n     * Define PSP deprecation and restrict use of PSP based on min k8s version and current/edited mode\n     */\n    getNeedsPSP(value = this.value) {\n      const release = value?.spec?.kubernetesVersion || '';\n      const version = release.match(/\\d+/g);\n      const isRequiredVersion = version?.length ? +version[0] === 1 && +version[1] < 25 : false;\n\n      return isRequiredVersion;\n    },\n\n    /**\n     * Get machine pools from the cluster configuration\n     * this.value.spec.rkeConfig.machinePools\n     */\n    async initMachinePools(existing) {\n      const out = [];\n\n      if ( existing?.length ) {\n        for ( const pool of existing ) {\n          let type;\n\n          if (this.isElementalCluster) {\n            type = ELEMENTAL_SCHEMA_IDS.MACHINE_INV_SELECTOR_TEMPLATES;\n          } else {\n            type = `${ CAPI.MACHINE_CONFIG_GROUP }.${ pool.machineConfigRef.kind.toLowerCase() }`;\n          }\n\n          let config;\n          let configMissing = false;\n\n          if ( this.$store.getters['management/canList'](type) ) {\n            try {\n              config = await this.$store.dispatch('management/find', {\n                type,\n                id: `${ this.value.metadata.namespace }/${ pool.machineConfigRef.name }`,\n              });\n            } catch (e) {\n              // Some users can't see the config, that's ok.\n              // we will display a banner for a 404 only for elemental\n              if (e?.status === 404) {\n                if (this.isElementalCluster) {\n                  configMissing = true;\n                }\n              }\n            }\n          }\n\n          // @TODO what if the pool is missing?\n          const id = `pool${ ++this.lastIdx }`;\n\n          out.push({\n            id,\n            remove: false,\n            create: false,\n            update: true,\n            pool:   clone(pool),\n            config: config ? await this.$store.dispatch('management/clone', { resource: config }) : null,\n            configMissing\n          });\n        }\n      }\n\n      this.machinePools = out;\n    },\n\n    async addMachinePool(idx) {\n      // this.machineConfigSchema is the schema for the Machine Pool's machine configuration for the given provider\n      if ( !this.machineConfigSchema ) {\n        return;\n      }\n\n      const numCurrentPools = this.machinePools.length || 0;\n\n      let config;\n\n      if (this.extensionProvider?.createMachinePoolMachineConfig) {\n        config = await this.extensionProvider.createMachinePoolMachineConfig(idx, this.machinePools, this.value);\n      } else {\n        // Default - use the schema\n        config = await this.$store.dispatch('management/createPopulated', {\n          type:     this.machineConfigSchema.id,\n          metadata: { namespace: DEFAULT_WORKSPACE }\n        });\n\n        // If there is no specific model, the applyDefaults does nothing by default\n        config.applyDefaults(idx, this.machinePools);\n      }\n\n      const name = `pool${ ++this.lastIdx }`;\n\n      const pool = {\n        id:     name,\n        config,\n        remove: false,\n        create: true,\n        update: false,\n        uid:    name,\n        pool:   {\n          name,\n          etcdRole:             numCurrentPools === 0,\n          controlPlaneRole:     numCurrentPools === 0,\n          workerRole:           true,\n          hostnamePrefix:       '',\n          labels:               {},\n          quantity:             1,\n          unhealthyNodeTimeout: '0m',\n          machineConfigRef:     {\n            kind: this.machineConfigSchema.attributes?.kind,\n            name: null,\n          },\n          drainBeforeDelete: true\n        },\n      };\n\n      if (this.provider === 'vmwarevsphere') {\n        pool.pool.machineOS = 'linux';\n      }\n\n      if (this.isElementalCluster) {\n        pool.pool.machineConfigRef.apiVersion = `${ this.machineConfigSchema.attributes.group }/${ this.machineConfigSchema.attributes.version }`;\n      }\n\n      this.machinePools.push(pool);\n\n      this.$nextTick(() => {\n        if ( this.$refs.pools?.select ) {\n          this.$refs.pools.select(name);\n        }\n      });\n    },\n\n    removeMachinePool(idx) {\n      const entry = this.machinePools[idx];\n\n      if ( !entry ) {\n        return;\n      }\n\n      if ( entry.create ) {\n        // If this is a new pool that isn't saved yet, it can just be dropped\n        removeObject(this.machinePools, entry);\n      } else {\n        // Mark for removal on save\n        entry.remove = true;\n      }\n    },\n\n    async syncMachineConfigWithLatest(machinePool) {\n      if (machinePool?.config?.id) {\n        // Use management/request instead of management/find to avoid overwriting the current machine pool in the store\n        const _latestConfig = await this.$store.dispatch('management/request', { url: `/v1/${ machinePool.config.type }s/${ machinePool.config.id }` });\n        const latestConfig = await this.$store.dispatch('management/create', _latestConfig);\n\n        const clonedCurrentConfig = await this.$store.dispatch('management/clone', { resource: machinePool.config });\n        const clonedLatestConfig = await this.$store.dispatch('management/clone', { resource: latestConfig });\n\n        // We don't allow the user to edit any of the fields in metadata from the UI so it's safe to override it with the\n        // metadata defined by the latest backend value. This is primarily used to ensure the resourceVersion is up to date.\n        delete clonedCurrentConfig.metadata;\n        machinePool.config = merge(clonedLatestConfig, clonedCurrentConfig);\n      }\n    },\n\n    async saveMachinePools(hookContext) {\n      if (hookContext === CONTEXT_HOOK_EDIT_YAML) {\n        await new Promise((resolve, reject) => {\n          this.$store.dispatch('cluster/promptModal', {\n            component:      'GenericPrompt',\n            componentProps: {\n              title:     this.t('cluster.rke2.modal.editYamlMachinePool.title'),\n              body:      this.t('cluster.rke2.modal.editYamlMachinePool.body'),\n              applyMode: 'editAndContinue',\n              confirm:   (confirmed) => {\n                if (confirmed) {\n                  resolve();\n                } else {\n                  reject(new Error('User Cancelled'));\n                }\n              }\n            },\n          });\n        });\n      }\n\n      const finalPools = [];\n\n      // If the extension provider wants to do this, let them\n      if (this.extensionProvider?.saveMachinePoolConfigs) {\n        return await this.extensionProvider.saveMachinePoolConfigs(this.machinePools, this.value);\n      }\n\n      for ( const entry of this.machinePools ) {\n        if ( entry.remove ) {\n          continue;\n        }\n\n        await this.syncMachineConfigWithLatest(entry);\n\n        // Capitals and such aren't allowed;\n        set(entry.pool, 'name', normalizeName(entry.pool.name) || 'pool');\n\n        const prefix = `${ this.value.metadata.name }-${ entry.pool.name }`.substr(0, 50).toLowerCase();\n\n        if ( entry.create ) {\n          if ( !entry.config.metadata?.name ) {\n            entry.config.metadata.generateName = `nc-${ prefix }-`;\n          }\n\n          const neu = await entry.config.save();\n\n          entry.config = neu;\n          entry.pool.machineConfigRef.name = neu.metadata.name;\n          entry.create = false;\n          entry.update = true;\n        } else if ( entry.update ) {\n          entry.config = await entry.config.save();\n        }\n\n        // Ensure Elemental clusters have a hostname prefix\n        if (this.isElementalCluster && !entry.pool.hostnamePrefix ) {\n          entry.pool.hostnamePrefix = `${ prefix }-`;\n        }\n\n        finalPools.push(entry.pool);\n      }\n\n      this.value.spec.rkeConfig.machinePools = finalPools;\n    },\n\n    async cleanupMachinePools() {\n      for ( const entry of this.machinePools ) {\n        if ( entry.remove && entry.config ) {\n          try {\n            await entry.config.remove();\n          } catch (e) {}\n        }\n      }\n    },\n\n    async saveRoleBindings() {\n      await this.value.waitForMgmt();\n\n      if (this.membershipUpdate.save) {\n        await this.membershipUpdate.save(this.value.mgmt.id);\n      }\n    },\n\n    /**\n     * Ensure that all the existing node roles pool are at least 1 each\n     */\n    hasRequiredNodes() {\n      return this.nodeTotals?.color && Object.values(this.nodeTotals.color).every((color) => color !== NODE_TOTAL.error.color);\n    },\n\n    cancelCredential() {\n      if ( this.$refs.cruresource ) {\n        this.$refs.cruresource.emitOrRoute();\n      }\n    },\n\n    done() {\n      let routeName = 'c-cluster-product-resource';\n\n      if ( this.mode === _CREATE && (this.provider === 'import' || this.provider === 'custom') ) {\n        // Go show the registration command\n        routeName = 'c-cluster-product-resource-namespace-id';\n      }\n\n      this.$router.push({\n        name:   routeName,\n        params: {\n          cluster:   this.$route.params.cluster,\n          product:   this.$store.getters['productId'],\n          resource:  CAPI.RANCHER_CLUSTER,\n          namespace: this.value.metadata.namespace,\n          id:        this.value.metadata.name,\n        },\n      });\n    },\n\n    showAddonConfirmation() {\n      return new Promise((resolve, reject) => {\n        this.$store.dispatch('cluster/promptModal', {\n          component: 'AddonConfigConfirmationDialog',\n          resources: [(value) => resolve(value)]\n        });\n      });\n    },\n\n    /**\n     * Inform user to remove PSP for current cluster due deprecation\n     */\n    showPspConfirmation() {\n      return new Promise((resolve, reject) => {\n        this.$store.dispatch('cluster/promptModal', {\n          component:      'GenericPrompt',\n          componentProps: {\n            title:     this.t('cluster.rke2.modal.pspChange.title'),\n            body:      this.t('cluster.rke2.modal.pspChange.body'),\n            applyMode: 'continue',\n            confirm:   resolve\n          },\n        });\n      });\n    },\n\n    // Set busy before save and clear after save\n    async saveOverride(btnCb) {\n      this.$set(this, 'busy', true);\n\n      // If the provider is from an extension, let it do the provision step\n      if (this.extensionProvider?.provision) {\n        const errors = await this.extensionProvider?.provision(this.value, this.machinePools);\n        const okay = (errors || []).length === 0;\n\n        this.errors = errors;\n        this.$set(this, 'busy', false);\n\n        btnCb(okay);\n\n        if (okay) {\n          // If saved okay, go to the done route\n          return this.done();\n        }\n      }\n\n      // Default save\n      return this._doSaveOverride((done) => {\n        this.$set(this, 'busy', false);\n\n        return btnCb(done);\n      });\n    },\n\n    async _doSaveOverride(btnCb) {\n      // We cannot use the hook, because it is triggered on YAML toggle without restore initialized data\n      this.agentConfigurationCleanup();\n\n      if ( this.errors ) {\n        clear(this.errors);\n      }\n\n      const isEditVersion = this.isEdit && this.liveValue?.spec?.kubernetesVersion !== this.value?.spec?.kubernetesVersion;\n      const hasPspManuallyAdded = !!this.value.spec.rkeConfig?.machineGlobalConfig?.['kube-apiserver-arg'];\n\n      if (isEditVersion && !this.needsPSP && hasPspManuallyAdded) {\n        if (!await this.showPspConfirmation()) {\n          return btnCb('cancelled');\n        }\n      }\n\n      if (isEditVersion) {\n        const shouldContinue = await this.showAddonConfirmation();\n\n        if (!shouldContinue) {\n          return btnCb('cancelled');\n        }\n      }\n\n      if (this.value.cloudProvider === 'aws') {\n        const missingProfileName = this.machinePools.some((mp) => !mp.config.iamInstanceProfile);\n\n        if (missingProfileName) {\n          this.errors.push(this.t('cluster.validation.iamInstanceProfileName', {}, true));\n        }\n      }\n\n      for (const [index] of this.machinePools.entries()) { // validator machine config\n        if ( typeof this.$refs.pool[index]?.test === 'function' ) {\n          try {\n            const res = await this.$refs.pool[index].test();\n\n            if (Array.isArray(res) && res.length > 0) {\n              this.errors.push(...res);\n            }\n          } catch (e) {\n            this.errors.push(e);\n          }\n        }\n      }\n\n      if (!this.value.metadata.name && this.agentConfig['cloud-provider-name'] === HARVESTER) {\n        this.errors.push(this.t('validation.required', { key: this.t('cluster.name.label') }, true));\n      }\n\n      if (this.errors.length) {\n        btnCb(false);\n\n        return;\n      }\n\n      try {\n        const clusterId = get(this.credential, 'decodedData.clusterId') || '';\n\n        this.applyChartValues(this.value.spec.rkeConfig);\n\n        const isUpgrade = this.isEdit && this.liveValue?.spec?.kubernetesVersion !== this.value?.spec?.kubernetesVersion;\n\n        if (this.agentConfig['cloud-provider-name'] === HARVESTER && clusterId && (this.isCreate || isUpgrade)) {\n          const namespace = this.machinePools?.[0]?.config?.vmNamespace;\n\n          const res = await this.$store.dispatch('management/request', {\n            url:    `/k8s/clusters/${ clusterId }/v1/harvester/kubeconfig`,\n            method: 'POST',\n            data:   {\n              csiClusterRoleName: 'harvesterhci.io:csi-driver',\n              clusterRoleName:    'harvesterhci.io:cloudprovider',\n              namespace,\n              serviceAccountName: this.value.metadata.name,\n            },\n          });\n\n          const kubeconfig = res.data;\n\n          const harvesterKubeconfigSecret = await this.createKubeconfigSecret(kubeconfig);\n\n          set(this.agentConfig, 'cloud-provider-config', `secret://fleet-default:${ harvesterKubeconfigSecret?.metadata?.name }`);\n\n          if (this.isCreate) {\n            set(this.chartValues, `${ HARVESTER_CLOUD_PROVIDER }.global.cattle.clusterName`, this.value.metadata.name);\n          }\n\n          set(this.chartValues, `${ HARVESTER_CLOUD_PROVIDER }.cloudConfigPath`, '/var/lib/rancher/rke2/etc/config-files/cloud-provider-config');\n        }\n      } catch (err) {\n        this.errors.push(err);\n\n        btnCb(false);\n\n        return;\n      }\n\n      // Remove null profile on machineGlobalConfig - https://github.com/rancher/dashboard/issues/8480\n      if (this.value.spec?.rkeConfig?.machineGlobalConfig?.profile === null) {\n        delete this.value.spec.rkeConfig.machineGlobalConfig.profile;\n      }\n\n      // Store the current data for fleet and cluster agent so that we can re-apply it later if the save fails\n      // The cleanup occurs before save with agentConfigurationCleanup()\n      const clusterAgentDeploymentCustomization = this.value.spec[CLUSTER_AGENT_CUSTOMIZATION] ? JSON.parse(JSON.stringify(this.value.spec[CLUSTER_AGENT_CUSTOMIZATION])) : null;\n      const fleetAgentDeploymentCustomization = this.value.spec[FLEET_AGENT_CUSTOMIZATION] ? JSON.parse(JSON.stringify(this.value.spec[FLEET_AGENT_CUSTOMIZATION])) : null;\n\n      await this.save(btnCb);\n\n      // comes from createEditView mixin\n      // if there are any errors saving, restore the agent config data\n      if (this.errors?.length) {\n        // Ensure the agent configuration is set back to the values before we changed (cleaned) it\n        set(this.value.spec, CLUSTER_AGENT_CUSTOMIZATION, clusterAgentDeploymentCustomization);\n        set(this.value.spec, FLEET_AGENT_CUSTOMIZATION, fleetAgentDeploymentCustomization);\n      }\n    },\n\n    async actuallySave(url) {\n      if (this.extensionProvider?.saveCluster) {\n        return await this.extensionProvider?.saveCluster(this.value, this.schema);\n      }\n\n      if ( this.isCreate ) {\n        url = url || this.schema.linkFor('collection');\n        const res = await this.value.save({ url });\n\n        if (res) {\n          Object.assign(this.value, res);\n        }\n      } else {\n        await this.value.save();\n      }\n    },\n\n    // create a secret to reference the harvester cluster kubeconfig in rkeConfig\n    async createKubeconfigSecret(kubeconfig = '') {\n      const clusterName = this.value.metadata.name;\n      const secret = await this.$store.dispatch('management/create', {\n        type:     SECRET,\n        metadata: {\n          namespace: 'fleet-default', generateName: 'harvesterconfig', annotations: { [CAPI_ANNOTATIONS.SECRET_AUTH]: clusterName, [CAPI_ANNOTATIONS.SECRET_WILL_DELETE]: 'true' }\n        },\n        data: { credential: base64Encode(kubeconfig) }\n      });\n\n      return secret.save({ url: '/v1/secrets', method: 'POST' });\n    },\n\n    cancel() {\n      this.$router.push({\n        name:   'c-cluster-product-resource',\n        params: {\n          cluster:  this.$route.params.cluster,\n          product:  this.$store.getters['productId'],\n          resource: CAPI.RANCHER_CLUSTER,\n        },\n      });\n    },\n\n    /**\n     * Ensure all chart information required to show addons is available\n     *\n     * This basically means\n     * 1) That the full chart relating to the addon is fetched (which includes core chart, readme and values)\n     * 2) We're ready to cache any values the user provides for each addon\n     */\n    async initAddons() {\n      for ( const chartName of this.addonNames ) {\n        const entry = this.chartVersions[chartName];\n\n        if ( this.versionInfo[chartName] ) {\n          continue;\n        }\n\n        try {\n          const res = await this.$store.dispatch('catalog/getVersionInfo', {\n            repoType:    'cluster',\n            repoName:    entry.repo,\n            chartName,\n            versionName: entry.version,\n          });\n\n          set(this.versionInfo, chartName, res);\n          const key = this.chartVersionKey(chartName);\n\n          if (!this.userChartValues[key]) {\n            this.userChartValues[key] = {};\n          }\n        } catch (e) {\n          console.error(`Failed to fetch or process chart info for ${ chartName }`); // eslint-disable-line no-console\n        }\n      }\n    },\n\n    labelForAddon(name) {\n      const fallback = `${ camelToTitle(name.replace(/^(rke|rke2|rancher)-/, '')) } Configuration`;\n\n      return this.$store.getters['i18n/withFallback'](`cluster.addonChart.\"${ name }\"`, null, fallback);\n    },\n\n    showAddons() {\n      this.addonsRev++;\n      this.addonNames.forEach((name) => {\n        const chartValues = this.versionInfo[name]?.questions ? this.initYamlEditor(name) : {};\n\n        set(this.userChartValuesTemp, name, chartValues);\n      });\n      this.refreshYamls();\n    },\n\n    refreshYamls() {\n      const keys = Object.keys(this.$refs).filter((x) => x.startsWith('yaml'));\n\n      for ( const k of keys ) {\n        const entry = this.$refs[k];\n        const list = isArray(entry) ? entry : [entry];\n\n        for ( const component of list ) {\n          component?.refresh(); // `yaml` ref can be undefined on switching from Basic to Addon tab (Azure --> Amazon --> addon)\n        }\n      }\n    },\n\n    updateValues(name, values) {\n      set(this.userChartValuesTemp, name, values);\n      this.syncChartValues(name);\n    },\n\n    syncChartValues: throttle(function(name) {\n      const fromChart = this.versionInfo[name]?.values;\n      const fromUser = this.userChartValuesTemp[name];\n      const different = diff(fromChart, fromUser);\n\n      this.userChartValues[this.chartVersionKey(name)] = different;\n    }, 250, { leading: true }),\n\n    updateQuestions(name) {\n      this.syncChartValues(name);\n    },\n\n    initYamlEditor(name) {\n      const defaultChartValue = this.versionInfo[name];\n      const key = this.chartVersionKey(name);\n\n      return merge({}, defaultChartValue?.values || {}, this.userChartValues[key] || {});\n    },\n\n    initServerAgentArgs() {\n      for ( const k in this.serverArgs ) {\n        if ( this.serverConfig[k] === undefined ) {\n          const def = this.serverArgs[k].default;\n\n          set(this.serverConfig, k, (def !== undefined ? def : undefined));\n        }\n      }\n\n      for ( const k in this.agentArgs ) {\n        if ( this.agentConfig[k] === undefined ) {\n          const def = this.agentArgs[k].default;\n\n          set(this.agentConfig, k, (def !== undefined ? def : undefined));\n        }\n      }\n\n      if ( !this.serverConfig?.profile ) {\n        set(this.serverConfig, 'profile', null);\n      }\n    },\n\n    chartVersionKey(name) {\n      const addonVersion = this.addonVersions.find((av) => av.name === name);\n\n      return addonVersion ? `${ name }-${ addonVersion.version }` : name;\n    },\n\n    onMembershipUpdate(update) {\n      this.$set(this, 'membershipUpdate', update);\n    },\n\n    canRemoveKubeletRow(row, idx) {\n      return idx !== 0;\n    },\n\n    async initRegistry() {\n      // Check for an existing cluster scoped registry\n      const clusterRegistry = this.agentConfig?.['system-default-registry'] || '';\n\n      // Check for the global registry\n      this.systemRegistry = (await this.$store.dispatch('management/find', { type: MANAGEMENT.SETTING, id: SETTING.SYSTEM_DEFAULT_REGISTRY })).value || '';\n\n      // The order of precedence is to use the cluster scoped registry\n      // if it exists, then use the global scoped registry as a fallback\n      if (clusterRegistry) {\n        this.registryHost = clusterRegistry;\n      } else {\n        this.registryHost = this.systemRegistry;\n      }\n\n      let registrySecret = null;\n      let regs = this.rkeConfig.registries;\n\n      if ( !regs ) {\n        regs = {};\n        set(this.rkeConfig, 'registries', regs);\n      }\n\n      if ( !regs.configs ) {\n        set(regs, 'configs', {});\n      }\n\n      if ( !regs.mirrors ) {\n        set(regs, 'mirrors', {});\n      }\n\n      const hostname = Object.keys(regs.configs)[0];\n      const config = regs.configs[hostname];\n\n      if ( config ) {\n        registrySecret = config.authConfigSecretName;\n      }\n\n      this.registrySecret = registrySecret;\n\n      const hasMirrorsOrAuthConfig = Object.keys(regs.configs).length > 0 || Object.keys(regs.mirrors).length > 0;\n\n      if (this.registryHost || registrySecret || hasMirrorsOrAuthConfig) {\n        this.showCustomRegistryInput = true;\n\n        if (hasMirrorsOrAuthConfig) {\n          this.showCustomRegistryAdvancedInput = true;\n        }\n      }\n    },\n\n    setRegistryConfig() {\n      const hostname = (this.registryHost || '').trim();\n\n      if ( this.systemRegistry ) {\n        // Empty string overrides the system default to nothing\n        set(this.agentConfig, 'system-default-registry', '');\n      } else {\n        // No need to set anything\n        set(this.agentConfig, 'system-default-registry', undefined);\n      }\n      if ( !hostname || hostname === this.systemRegistry ) {\n        // Undefined removes the key which uses the global setting without hardcoding it into the config\n        set(this.agentConfig, 'system-default-registry', undefined);\n      } else {\n        set(this.agentConfig, 'system-default-registry', hostname);\n      }\n\n      if ( hostname && this.registrySecret ) {\n        // For a registry with basic auth, but no mirrors,\n        // add a single registry config with the basic auth secret.\n        const basicAuthConfig = {\n          [hostname]: {\n            authConfigSecretName: this.registrySecret,\n            caBundle:             null,\n            insecureSkipVerify:   false,\n            tlsSecretName:        null,\n          }\n        };\n\n        const rkeConfig = this.value.spec.rkeConfig;\n\n        if (!rkeConfig) {\n          this.value.spec.rkeConfig = { registries: { configs: basicAuthConfig } };\n        } else if (rkeConfig.registries.configs && Object.keys(rkeConfig.registries.configs).length > 0) {\n          // If some existing authentication secrets are already configured\n          // for registry mirrors, the basic auth is added to the existing ones.\n          const existingConfigs = rkeConfig.registries.configs;\n\n          this.value.spec.rkeConfig.registries.configs = { ...basicAuthConfig, ...existingConfigs };\n        } else {\n          const existingMirrorAndAuthConfig = this.value.spec.rkeConfig.registries;\n\n          this.value.spec.rkeConfig.registries = {\n            ...existingMirrorAndAuthConfig,\n            configs: basicAuthConfig\n          };\n        }\n      }\n    },\n\n    updateConfigs(configs) {\n      // Update authentication configuration\n      // for each mirror\n      if (!this.value.spec?.rkeConfig) {\n        this.value.spec.rkeConfig = { registries: {} };\n      }\n      set(this.value.spec.rkeConfig.registries, 'configs', configs);\n    },\n\n    getAllOptionsAfterCurrentVersion(versions, currentVersion, defaultVersion) {\n      const out = (versions || []).filter((obj) => !!obj.serverArgs).map((obj) => {\n        let disabled = false;\n        let experimental = false;\n        let isCurrentVersion = false;\n        let label = obj.id;\n\n        if ( currentVersion ) {\n          disabled = compare(obj.id, currentVersion) < 0;\n          isCurrentVersion = compare(obj.id, currentVersion) === 0;\n        }\n\n        if ( defaultVersion ) {\n          experimental = compare(defaultVersion, obj.id) < 0;\n        }\n\n        if (isCurrentVersion) {\n          label = `${ label } ${ this.t('cluster.kubernetesVersion.current') }`;\n        }\n\n        if (experimental) {\n          label = `${ label } ${ this.t('cluster.kubernetesVersion.experimental') }`;\n        }\n\n        return {\n          label,\n          value:      obj.id,\n          sort:       sortable(obj.id),\n          serverArgs: obj.serverArgs,\n          agentArgs:  obj.agentArgs,\n          charts:     obj.charts,\n          disabled,\n        };\n      });\n\n      if (currentVersion && !out.find((obj) => obj.value === currentVersion)) {\n        out.push({\n          label: `${ currentVersion } ${ this.t('cluster.kubernetesVersion.current') }`,\n          value: currentVersion,\n          sort:  sortable(currentVersion),\n        });\n      }\n\n      const sorted = sortBy(out, 'sort:desc');\n\n      const mostRecentPatchVersions = this.getMostRecentPatchVersions(sorted);\n\n      const sortedWithDeprecatedLabel = sorted.map((optionData) => {\n        const majorMinor = `${ semver.major(optionData.value) }.${ semver.minor(optionData.value) }`;\n\n        if (mostRecentPatchVersions[majorMinor] === optionData.value) {\n          return optionData;\n        }\n\n        return {\n          ...optionData,\n          label: `${ optionData.label } ${ this.t('cluster.kubernetesVersion.deprecated') }`\n        };\n      });\n\n      return sortedWithDeprecatedLabel;\n    },\n\n    getMostRecentPatchVersions(sortedVersions) {\n      // Get the most recent patch version for each Kubernetes minor version.\n      const versionMap = {};\n\n      sortedVersions.forEach((version) => {\n        const majorMinor = `${ semver.major(version.value) }.${ semver.minor(version.value) }`;\n\n        if (!versionMap[majorMinor]) {\n          // Because we start with a sorted list of versions, we know the\n          // highest patch version is first in the list, so we only keep the\n          // first of each minor version in the list.\n          versionMap[majorMinor] = version.value;\n        }\n      });\n\n      return versionMap;\n    },\n\n    filterOutDeprecatedPatchVersions(allVersions, currentVersion) {\n      // Get the most recent patch version for each Kubernetes minor version.\n      const mostRecentPatchVersions = this.getMostRecentPatchVersions(allVersions);\n\n      const filteredVersions = allVersions.filter((version) => {\n        // Always show pre-releases\n        if (semver.prerelease(version.value)) {\n          return true;\n        }\n\n        const majorMinor = `${ semver.major(version.value) }.${ semver.minor(version.value) }`;\n\n        // Always show current version, else show if we haven't shown anything for this major.minor version yet\n        if (version.value === currentVersion || mostRecentPatchVersions[majorMinor] === version.value) {\n          return true;\n        }\n\n        return false;\n      });\n\n      return filteredVersions;\n    },\n\n    generateYaml() {\n      const resource = this.value;\n      const inStore = this.$store.getters['currentStore'](resource);\n      const schemas = this.$store.getters[`${ inStore }/all`](SCHEMA);\n      const clonedResource = clone(resource);\n\n      this.applyChartValues(clonedResource.spec.rkeConfig);\n\n      const out = createYaml(schemas, resource.type, clonedResource);\n\n      return out;\n    },\n\n    applyChartValues(rkeConfig) {\n      rkeConfig.chartValues = {};\n      this.addonNames.forEach((name) => {\n        const key = this.chartVersionKey(name);\n        const userValues = this.userChartValues[key];\n\n        if (userValues) {\n          set(rkeConfig.chartValues, name, userValues);\n        }\n      });\n    },\n    get,\n\n    setHarvesterDefaultCloudProvider() {\n      if (this.isHarvesterDriver &&\n        this.mode === _CREATE &&\n        !this.agentConfig['cloud-provider-name'] &&\n        !this.isHarvesterExternalCredential &&\n        !this.isHarvesterIncompatible\n      ) {\n        this.agentConfig['cloud-provider-name'] = HARVESTER;\n      } else {\n        this.agentConfig['cloud-provider-name'] = '';\n      }\n    },\n\n    async setHarvesterVersionRange() {\n      const clusterId = this.credential?.decodedData?.clusterId;\n      const clusterType = this.credential?.decodedData?.clusterType;\n\n      if (clusterId && clusterType === 'imported') {\n        const url = `/k8s/clusters/${ clusterId }/v1`;\n        const res = await this.$store.dispatch('cluster/request', { url: `${ url }/${ HCI.SETTING }s` });\n\n        const version = (res?.data || []).find((s) => s.id === 'harvester-csi-ccm-versions');\n\n        if (version) {\n          this.harvesterVersionRange = JSON.parse(version.value || version.default || '{}');\n        } else {\n          this.harvesterVersionRange = {};\n        }\n      }\n      this.setHarvesterDefaultCloudProvider();\n    },\n    toggleCustomRegistry(e) {\n      if (this.registryHost) {\n        this.registryHost = null;\n        this.registrySecret = null;\n      } else {\n        this.initRegistry();\n      }\n    },\n\n    /**\n     * Get provisioned RKE2 cluster PSPs in edit mode\n     */\n    async getPsps() {\n      // As server returns 500 we exclude all the possible cases\n      if (\n        this.mode !== _CREATE &&\n        !this.isK3s &&\n        this.value.state !== 'reconciling' &&\n        this.getNeedsPSP(this.liveValue) // We consider editing only possible PSP cases\n      ) {\n        const clusterId = this.value.mgmtClusterId;\n        const url = `/k8s/clusters/${ clusterId }/v1/${ PSPS }`;\n\n        try {\n          return await this.$store.dispatch('cluster/request', { url });\n        } catch (error) {\n          // PSP may not exists for this cluster and an error is returned without need to handle\n        }\n      }\n    },\n\n    /**\n     * Reset PSA on several input changes for given conditions\n     */\n    togglePsaDefault() {\n      // This option is created from the server and is guaranteed to exist #8032\n      const hardcodedTemplate = 'rancher-restricted';\n      const cisValue = this.agentConfig?.profile || this.serverConfig?.profile;\n\n      if (!this.cisOverride) {\n        if (this.hasPsaTemplates && cisValue) {\n          set(this.value.spec, 'defaultPodSecurityAdmissionConfigurationTemplateName', hardcodedTemplate);\n        }\n\n        this.cisPsaChangeBanner = this.hasPsaTemplates;\n      }\n    },\n\n    handleCisChange() {\n      this.togglePsaDefault();\n      this.updateCisProfile();\n    },\n\n    updateCisProfile() {\n      // If the user selects any Worker CIS Profile,\n      // protect-kernel-defaults should be set to false\n      // in the RKE2 worker/agent config.\n      const selectedCisProfile = this.agentConfig?.profile;\n\n      if (selectedCisProfile) {\n        set(this.agentConfig, 'protect-kernel-defaults', true);\n      } else {\n        set(this.agentConfig, 'protect-kernel-defaults', false);\n      }\n    },\n\n    /**\n     * Handle k8s changes side effects, like PSP and PSA resets\n     */\n    handleKubernetesChange(value) {\n      if (value) {\n        this.togglePsaDefault();\n        const version = VERSION.parse(value);\n        const major = parseInt(version?.[0] || 0);\n        const minor = parseInt(version?.[1] || 0);\n\n        // Reset PSA if not RKE2\n        if (!value.includes('rke2')) {\n          set(this.value.spec, 'defaultPodSecurityPolicyTemplateName', '');\n        } else {\n          // Reset PSP if it's legacy due k8s version 1.25+\n          if (major === 1 && minor >= 25) {\n            set(this.value.spec, 'defaultPodSecurityPolicyTemplateName', '');\n          } else {\n            set(this.value.spec, 'defaultPodSecurityPolicyTemplateName', this.lastDefaultPodSecurityPolicyTemplateName);\n          }\n\n          this.previousKubernetesVersion = value;\n        }\n\n        // If Harvester driver, reset cloud provider if not compatible\n        if (this.isHarvesterDriver && this.mode === _CREATE && this.isHarvesterIncompatible) {\n          this.setHarvesterDefaultCloudProvider();\n        }\n\n        // Cloud Provider check\n        // If the cloud provider is unsupported, switch provider to 'external'\n        if (this.unsupportedCloudProvider) {\n          set(this.agentConfig, 'cloud-provider-name', 'external');\n        } else {\n          // Switch the cloud provider back to the initial value\n          // Use changed the Kubernetes version back to a version where the initial cloud provider is valid - so switch back to this one\n          // to undo the change to external that we may have made\n          // Note: Cloud Provider can only be changed on edit when the initial provider is no longer supported\n          set(this.agentConfig, 'cloud-provider-name', this.initialCloudProvider);\n        }\n      }\n    },\n\n    /**\n     * Keep last PSP value\n     */\n    handlePspChange(value) {\n      this.lastDefaultPodSecurityPolicyTemplateName = value;\n    },\n\n    handleShowDeprecatedPatchVersionsChanged(value) {\n      this.showDeprecatedPatchVersions = value;\n    },\n    /**\n     * Track Machine Pool validation status\n     */\n    machinePoolValidationChanged(id, value) {\n      if (value === undefined) {\n        this.$delete(this.machinePoolValidation, id);\n      } else {\n        this.$set(this.machinePoolValidation, id, value);\n      }\n    },\n    handleEnabledSystemServicesChanged(val) {\n      set(this.serverConfig, 'disable', val);\n    },\n    handleCiliumIpv6Changed(neu) {\n      const name = this.chartVersionKey('rke2-cilium');\n      const values = this.userChartValues[name];\n\n      set(this, 'userChartValues', {\n        ...this.userChartValues,\n        [name]: {\n          ...values,\n          cilium: {\n            ...values?.cilium,\n            ipv6: {\n              ...values?.cilium?.ipv6,\n              enabled: neu\n            }\n          }\n        }\n      });\n    },\n    handlePspChanged(neu) {\n      this.handlePspChange(neu);\n    },\n    handleCisChanged() {\n      this.handleCisChange();\n    },\n    handlePsaDefaultChanged() {\n      this.togglePsaDefault();\n    },\n    handleMachinePoolError(error) {\n      this.machinePoolErrors = merge(this.machinePoolErrors, error);\n\n      const errors = Object.entries(this.machinePoolErrors)\n        .map((x) => {\n          if (!x[1].length) {\n            return;\n          }\n\n          const formattedFields = (() => {\n            switch (x[1].length) {\n            case 1:\n              return x[1][0];\n            case 2:\n              return `${ x[1][0] } and ${ x[1][1] }`;\n            default: {\n              const [head, ...rest] = x[1];\n\n              return `${ rest.join(', ') }, and ${ head }`;\n            }\n            }\n          })();\n\n          return this.t('cluster.banner.machinePoolError', {\n            count: x[1].length, pool_name: x[0], fields: formattedFields\n          }, true);\n        } )\n        .filter((x) => x);\n\n      if (!errors) {\n        return;\n      }\n\n      this.errors = errors;\n    }\n  },\n};\n</script>\n\n<template>\n  <Loading v-if=\"$fetchState.pending && !loadedOnce\" />\n  <Banner\n    v-else-if=\"$fetchState.error\"\n    color=\"error\"\n    :label=\"$fetchState.error\"\n  />\n  <CruResource\n    v-else\n    ref=\"cruresource\"\n    :mode=\"mode\"\n    :validation-passed=\"validationPassed && fvFormIsValid\"\n    :resource=\"value\"\n    :errors=\"errors\"\n    :cancel-event=\"true\"\n    :done-route=\"doneRoute\"\n    :apply-hooks=\"applyHooks\"\n    :generate-yaml=\"generateYaml\"\n    class=\"rke2\"\n    component-testid=\"rke2-custom-create\"\n    @done=\"done\"\n    @finish=\"saveOverride\"\n    @cancel=\"cancel\"\n    @error=\"fvUnreportedValidationErrors\"\n  >\n    <div class=\"header-warnings\">\n      <Banner\n        v-if=\"isEdit\"\n        color=\"warning\"\n      >\n        <span v-clean-html=\"t('cluster.banner.rke2-k3-reprovisioning', {}, true)\" />\n      </Banner>\n    </div>\n    <SelectCredential\n      v-if=\"needCredential\"\n      v-model=\"credentialId\"\n      :mode=\"mode\"\n      :provider=\"provider\"\n      :cancel=\"cancelCredential\"\n      :showing-form=\"showForm\"\n      class=\"mt-20\"\n    />\n\n    <div\n      v-if=\"showForm\"\n      class=\"mt-20\"\n    >\n      <NameNsDescription\n        v-if=\"!isView\"\n        v-model=\"value\"\n        :mode=\"mode\"\n        :namespaced=\"needsNamespace\"\n        :namespace-options=\"allNamespaces\"\n        name-label=\"cluster.name.label\"\n        name-placeholder=\"cluster.name.placeholder\"\n        description-label=\"cluster.description.label\"\n        description-placeholder=\"cluster.description.placeholder\"\n        :rules=\"{name:fvGetAndReportPathRules('metadata.name')}\"\n      />\n\n      <Banner\n        v-if=\"appsOSWarning\"\n        color=\"error\"\n      >\n        {{ appsOSWarning }}\n      </Banner>\n\n      <!-- Pools Extras -->\n      <template v-if=\"hasMachinePools\">\n        <div class=\"clearfix\">\n          <h2\n            v-t=\"'cluster.tabs.machinePools'\"\n            class=\"pull-left\"\n          />\n          <div\n            v-if=\"!isView\"\n            class=\"pull-right\"\n          >\n            <BadgeState\n              v-clean-tooltip=\"nodeTotals.tooltip.etcd\"\n              :color=\"nodeTotals.color.etcd\"\n              :icon=\"nodeTotals.icon.etcd\"\n              :label=\"nodeTotals.label.etcd\"\n              class=\"mr-10\"\n            />\n            <BadgeState\n              v-clean-tooltip=\"nodeTotals.tooltip.controlPlane\"\n              :color=\"nodeTotals.color.controlPlane\"\n              :icon=\"nodeTotals.icon.controlPlane\"\n              :label=\"nodeTotals.label.controlPlane\"\n              class=\"mr-10\"\n            />\n            <BadgeState\n              v-clean-tooltip=\"nodeTotals.tooltip.worker\"\n              :color=\"nodeTotals.color.worker\"\n              :icon=\"nodeTotals.icon.worker\"\n              :label=\"nodeTotals.label.worker\"\n            />\n          </div>\n        </div>\n\n        <!-- Extra Tabs for Machine Pool -->\n        <Tabbed\n          ref=\"pools\"\n          :side-tabs=\"true\"\n          :show-tabs-add-remove=\"!isView\"\n          @addTab=\"addMachinePool($event)\"\n          @removeTab=\"removeMachinePool($event)\"\n        >\n          <template v-for=\"(obj, idx) in machinePools\">\n            <Tab\n              v-if=\"!obj.remove\"\n              :key=\"obj.id\"\n              :name=\"obj.id\"\n              :label=\"obj.pool.name || '(Not Named)'\"\n              :show-header=\"false\"\n              :error=\"!machinePoolValidation[obj.id]\"\n            >\n              <MachinePool\n                ref=\"pool\"\n                :value=\"obj\"\n                :cluster=\"value\"\n                :mode=\"mode\"\n                :provider=\"provider\"\n                :credential-id=\"credentialId\"\n                :idx=\"idx\"\n                :machine-pools=\"machinePools\"\n                :busy=\"busy\"\n                :pool-id=\"obj.id\"\n                @error=\"handleMachinePoolError\"\n                @validationChanged=\"v=>machinePoolValidationChanged(obj.id, v)\"\n              />\n            </Tab>\n          </template>\n          <div v-if=\"!unremovedMachinePools.length\">\n            {{ t('cluster.machinePool.noPoolsDisclaimer') }}\n          </div>\n        </Tabbed>\n        <div class=\"spacer\" />\n      </template>\n\n      <!-- Cluster Tabs -->\n      <h2 v-t=\"'cluster.tabs.cluster'\" />\n      <Tabbed\n        :side-tabs=\"true\"\n        class=\"min-height\"\n      >\n        <Tab\n          name=\"basic\"\n          label-key=\"cluster.tabs.basic\"\n          :weight=\"11\"\n          @active=\"refreshYamls\"\n        >\n          <!-- Basic -->\n          <Basics\n            v-model=\"value\"\n            :live-value=\"liveValue\"\n            :mode=\"mode\"\n            :provider=\"provider\"\n            :psps=\"psps\"\n            :user-chart-values=\"userChartValues\"\n            :credential=\"credential\"\n            :cis-override=\"cisOverride\"\n            :cis-psa-change-banner=\"cisPsaChangeBanner\"\n            :all-psps=\"allPSPs\"\n            :all-psas=\"allPSAs\"\n            :addon-versions=\"addonVersions\"\n            :show-deprecated-patch-versions=\"showDeprecatedPatchVersions\"\n            :needs-psp=\"needsPSP\"\n            :selected-version=\"selectedVersion\"\n            :is-harvester-driver=\"isHarvesterDriver\"\n            :is-harvester-incompatible=\"isHarvesterIncompatible\"\n            :version-options=\"versionOptions\"\n            :cluster-is-already-created=\"clusterIsAlreadyCreated\"\n            :is-elemental-cluster=\"isElementalCluster\"\n            :has-psa-templates=\"hasPsaTemplates\"\n            :is-k3s=\"isK3s\"\n            :have-arg-info=\"haveArgInfo\"\n            :show-cni=\"showCni\"\n            :show-cloud-provider=\"showCloudProvider\"\n            :unsupported-cloud-provider=\"unsupportedCloudProvider\"\n            :cloud-provider-options=\"cloudProviderOptions\"\n            @cilium-ipv6-changed=\"handleCiliumIpv6Changed\"\n            @enabled-system-services-changed=\"handleEnabledSystemServicesChanged\"\n            @kubernetes-changed=\"handleKubernetesChange\"\n            @psp-changed=\"handlePspChanged\"\n            @cis-changed=\"handleCisChanged\"\n            @psa-default-changed=\"handlePsaDefaultChanged\"\n            @show-deprecated-patch-versions-changed=\"handleShowDeprecatedPatchVersionsChanged\"\n          />\n        </Tab>\n\n        <!-- Member Roles -->\n        <Tab\n          v-if=\"canManageMembers\"\n          name=\"memberRoles\"\n          label-key=\"cluster.tabs.memberRoles\"\n          :weight=\"10\"\n        >\n          <MemberRoles\n            v-model=\"value\"\n            :mode=\"mode\"\n            :on-membership-update=\"onMembershipUpdate\"\n          />\n        </Tab>\n        <!-- etcd -->\n        <Tab\n          name=\"etcd\"\n          label-key=\"cluster.tabs.etcd\"\n        >\n          <div class=\"row\">\n            <div class=\"col span-6\">\n              <RadioGroup\n                v-model=\"rkeConfig.etcd.disableSnapshots\"\n                name=\"etcd-disable-snapshots\"\n                :options=\"[true, false]\"\n                :label=\"t('cluster.rke2.etcd.disableSnapshots.label')\"\n                :labels=\"[t('generic.disable'), t('generic.enable')]\"\n                :mode=\"mode\"\n              />\n            </div>\n          </div>\n          <div\n            v-if=\"rkeConfig.etcd.disableSnapshots !== true\"\n            class=\"row\"\n          >\n            <div class=\"col span-6\">\n              <LabeledInput\n                v-model=\"rkeConfig.etcd.snapshotScheduleCron\"\n                type=\"cron\"\n                placeholder=\"0 * * * *\"\n                :mode=\"mode\"\n                :label=\"t('cluster.rke2.etcd.snapshotScheduleCron.label')\"\n              />\n            </div>\n            <div class=\"col span-6\">\n              <UnitInput\n                v-model=\"rkeConfig.etcd.snapshotRetention\"\n                :mode=\"mode\"\n                :label=\"t('cluster.rke2.etcd.snapshotRetention.label')\"\n                :suffix=\"t('cluster.rke2.snapshots.suffix')\"\n              />\n            </div>\n          </div>\n\n          <template v-if=\"rkeConfig.etcd.disableSnapshots !== true\">\n            <div class=\"spacer\" />\n\n            <RadioGroup\n              v-model=\"s3Backup\"\n              name=\"etcd-s3\"\n              :options=\"[false, true]\"\n              label=\"Backup Snapshots to S3\"\n              :labels=\"['Disable','Enable']\"\n              :mode=\"mode\"\n            />\n\n            <S3Config\n              v-if=\"s3Backup\"\n              v-model=\"rkeConfig.etcd.s3\"\n              :namespace=\"value.metadata.namespace\"\n              :register-before-hook=\"registerBeforeHook\"\n              :mode=\"mode\"\n            />\n          </template>\n\n          <div class=\"spacer\" />\n\n          <div class=\"row\">\n            <div class=\"col span-6\">\n              <RadioGroup\n                v-if=\"serverArgs['etcd-expose-metrics']\"\n                v-model=\"serverConfig['etcd-expose-metrics']\"\n                name=\"etcd-expose-metrics\"\n                :options=\"[false, true]\"\n                :label=\"t('cluster.rke2.etcd.exportMetric.label')\"\n                :labels=\"[t('cluster.rke2.etcd.exportMetric.false'), t('cluster.rke2.etcd.exportMetric.true')]\"\n                :mode=\"mode\"\n              />\n            </div>\n          </div>\n        </Tab>\n\n        <!-- Networking -->\n        <Tab\n          v-if=\"haveArgInfo\"\n          name=\"networking\"\n          label-key=\"cluster.tabs.networking\"\n        >\n          <h3>\n            {{ t('cluster.rke2.address.header') }}\n            <i\n              v-clean-tooltip=\"t('cluster.rke2.address.tooltip')\"\n              class=\"icon icon-info\"\n            />\n          </h3>\n          <Banner\n            v-if=\"showIpv6Warning\"\n            color=\"warning\"\n          >\n            {{ t('cluster.rke2.address.ipv6.warning') }}\n          </Banner>\n          <div class=\"row mb-20\">\n            <div\n              v-if=\"serverArgs['cluster-cidr']\"\n              class=\"col span-6\"\n            >\n              <LabeledInput\n                v-model=\"serverConfig['cluster-cidr']\"\n                :mode=\"mode\"\n                :disabled=\"clusterIsAlreadyCreated\"\n                :label=\"t('cluster.rke2.address.clusterCidr.label')\"\n              />\n            </div>\n            <div\n              v-if=\"serverArgs['service-cidr']\"\n              class=\"col span-6\"\n            >\n              <LabeledInput\n                v-model=\"serverConfig['service-cidr']\"\n                :mode=\"mode\"\n                :disabled=\"clusterIsAlreadyCreated\"\n                :label=\"t('cluster.rke2.address.serviceCidr.label')\"\n              />\n            </div>\n          </div>\n\n          <div class=\"row mb-20\">\n            <div\n              v-if=\"serverArgs['cluster-dns']\"\n              class=\"col span-6\"\n            >\n              <LabeledInput\n                v-model=\"serverConfig['cluster-dns']\"\n                :mode=\"mode\"\n                :disabled=\"clusterIsAlreadyCreated\"\n                :label=\"t('cluster.rke2.address.dns.label')\"\n              />\n            </div>\n            <div\n              v-if=\"serverArgs['cluster-domain']\"\n              class=\"col span-6\"\n            >\n              <LabeledInput\n                v-model=\"serverConfig['cluster-domain']\"\n                :mode=\"mode\"\n                :disabled=\"clusterIsAlreadyCreated\"\n                :label=\"t('cluster.rke2.address.domain.label')\"\n              />\n            </div>\n          </div>\n\n          <div\n            v-if=\"serverArgs['service-node-port-range']\"\n            class=\"row mb-20\"\n          >\n            <div class=\"col span-6\">\n              <LabeledInput\n                v-model=\"serverConfig['service-node-port-range']\"\n                :mode=\"mode\"\n                :label=\"t('cluster.rke2.address.nodePortRange.label')\"\n              />\n            </div>\n            <div\n              class=\"col span-6\"\n            >\n              <Checkbox\n                v-if=\"!isView || isView && !hostnameTruncationManuallySet\"\n                v-model=\"truncateHostnames\"\n                class=\"mt-20\"\n                :disabled=\"isEdit || isView || hostnameTruncationManuallySet\"\n                :mode=\"mode\"\n                :label=\"t('cluster.rke2.truncateHostnames')\"\n                @input=\"truncateName\"\n              />\n              <Banner\n                v-if=\"hostnameTruncationManuallySet\"\n                color=\"info\"\n              >\n                <div class=\"text\">\n                  {{ t('cluster.machinePool.truncationCluster', { limit: truncateLimit }) }}\n                </div>\n              </Banner>\n            </div>\n          </div>\n\n          <div\n            v-if=\"serverArgs['tls-san']\"\n            class=\"row mb-20\"\n          >\n            <div class=\"col span-6\">\n              <ArrayList\n                v-model=\"serverConfig['tls-san']\"\n                :protip=\"false\"\n                :mode=\"mode\"\n                :title=\"t('cluster.rke2.address.tlsSan.label')\"\n              />\n            </div>\n          </div>\n\n          <ACE\n            v-model=\"value\"\n            :mode=\"mode\"\n          />\n        </Tab>\n\n        <!-- Upgrade -->\n        <Tab\n          name=\"upgrade\"\n          label-key=\"cluster.tabs.upgrade\"\n        >\n          <Banner\n            v-if=\"get(rkeConfig, 'upgradeStrategy.controlPlaneDrainOptions.deleteEmptyDirData')\"\n            color=\"warning\"\n          >\n            {{ t('cluster.rke2.drain.deleteEmptyDir.warning', {}, true) }}\n          </Banner>\n          <div class=\"row\">\n            <div class=\"col span-6\">\n              <h3>{{ t('cluster.rke2.controlPlaneConcurrency.header') }}</h3>\n              <LabeledInput\n                v-model=\"rkeConfig.upgradeStrategy.controlPlaneConcurrency\"\n                :mode=\"mode\"\n                :label=\"t('cluster.rke2.controlPlaneConcurrency.label')\"\n                :tooltip=\"t('cluster.rke2.controlPlaneConcurrency.toolTip')\"\n              />\n              <div class=\"spacer\" />\n              <DrainOptions\n                v-model=\"rkeConfig.upgradeStrategy.controlPlaneDrainOptions\"\n                :mode=\"mode\"\n              />\n            </div>\n            <div class=\"col span-6\">\n              <h3>\n                {{ t('cluster.rke2.workNode.label') }}\n              </h3>\n              <LabeledInput\n                v-model=\"rkeConfig.upgradeStrategy.workerConcurrency\"\n                :mode=\"mode\"\n                :label=\"t('cluster.rke2.workerConcurrency.label')\"\n                :tooltip=\"t('cluster.rke2.workerConcurrency.toolTip')\"\n              />\n              <div class=\"spacer\" />\n              <DrainOptions\n                v-model=\"rkeConfig.upgradeStrategy.workerDrainOptions\"\n                :mode=\"mode\"\n              />\n            </div>\n          </div>\n        </Tab>\n\n        <!-- Registries -->\n        <Tab\n          name=\"registry\"\n          label-key=\"cluster.tabs.registry\"\n        >\n          <div class=\"row\">\n            <h3>{{ t('cluster.privateRegistry.label') }}</h3>\n          </div>\n          <div class=\"row\">\n            <div class=\"col span-12\">\n              <Banner\n                :closable=\"false\"\n                class=\"cluster-tools-tip\"\n                color=\"info\"\n                label-key=\"cluster.privateRegistry.description\"\n              />\n            </div>\n          </div>\n          <div class=\"row\">\n            <Checkbox\n              v-model=\"showCustomRegistryInput\"\n              class=\"mb-20\"\n              :label=\"t('cluster.privateRegistry.label')\"\n              @input=\"toggleCustomRegistry\"\n            />\n          </div>\n          <div\n            v-if=\"showCustomRegistryInput\"\n            class=\"row\"\n          >\n            <div class=\"col span-6\">\n              <LabeledInput\n                v-model=\"registryHost\"\n                label-key=\"catalog.chart.registry.custom.inputLabel\"\n                placeholder-key=\"catalog.chart.registry.custom.placeholder\"\n                :min-height=\"30\"\n              />\n              <SelectOrCreateAuthSecret\n                v-model=\"registrySecret\"\n                :register-before-hook=\"registerBeforeHook\"\n                :hook-priority=\"1\"\n                :mode=\"mode\"\n                in-store=\"management\"\n                :allow-ssh=\"false\"\n                :allow-rke=\"true\"\n                :vertical=\"true\"\n                :namespace=\"value.metadata.namespace\"\n                generate-name=\"registryconfig-auth-\"\n              />\n            </div>\n          </div>\n          <template>\n            <div\n              v-if=\"showCustomRegistryInput\"\n              class=\"row\"\n            >\n              <AdvancedSection\n                class=\"col span-12 advanced\"\n                :is-open-by-default=\"showCustomRegistryAdvancedInput\"\n                :mode=\"mode\"\n              >\n                <Banner\n                  :closable=\"false\"\n                  class=\"cluster-tools-tip\"\n                  color=\"info\"\n                  :label-key=\"isK3s ? 'cluster.privateRegistry.docsLinkK3s' : 'cluster.privateRegistry.docsLinkRke2'\"\n                />\n                <RegistryMirrors\n                  v-model=\"value\"\n                  class=\"mt-20\"\n                  :mode=\"mode\"\n                />\n                <RegistryConfigs\n                  v-model=\"value\"\n                  class=\"mt-20\"\n                  :mode=\"mode\"\n                  :cluster-register-before-hook=\"registerBeforeHook\"\n                  @updateConfigs=\"updateConfigs\"\n                />\n              </AdvancedSection>\n            </div>\n          </template>\n        </Tab>\n\n        <!-- Add-on Config -->\n        <Tab\n          name=\"addons\"\n          label-key=\"cluster.tabs.addons\"\n          @active=\"showAddons\"\n        >\n          <Banner\n            v-if=\"isEdit\"\n            color=\"warning\"\n          >\n            {{ t('cluster.addOns.dependencyBanner') }}\n          </Banner>\n          <div\n            v-if=\"versionInfo && addonVersions.length\"\n            :key=\"addonsRev\"\n          >\n            <div\n              v-for=\"v in addonVersions\"\n              :key=\"v._key\"\n            >\n              <h3>{{ labelForAddon(v.name) }}</h3>\n              <Questions\n                v-if=\"versionInfo[v.name] && versionInfo[v.name].questions && v.name && userChartValuesTemp[v.name]\"\n                v-model=\"userChartValuesTemp[v.name]\"\n                :emit=\"true\"\n                in-store=\"management\"\n                :mode=\"mode\"\n                :tabbed=\"false\"\n                :source=\"versionInfo[v.name]\"\n                :target-namespace=\"value.metadata.namespace\"\n                @updated=\"updateQuestions(v.name)\"\n              />\n              <YamlEditor\n                v-else\n                ref=\"yaml-values\"\n                :value=\"initYamlEditor(v.name)\"\n                :scrolling=\"true\"\n                :as-object=\"true\"\n                :editor-mode=\"mode === 'view' ? 'VIEW_CODE' : 'EDIT_CODE'\"\n                :hide-preview-buttons=\"true\"\n                @input=\"data => updateValues(v.name, data)\"\n              />\n              <div class=\"spacer\" />\n            </div>\n          </div>\n\n          <div>\n            <h3>\n              {{ t('cluster.addOns.additionalManifest.title') }}\n              <i\n                v-clean-tooltip=\"t('cluster.addOns.additionalManifest.tooltip')\"\n                class=\"icon icon-info\"\n              />\n            </h3>\n            <YamlEditor\n              ref=\"yaml-additional\"\n              v-model=\"rkeConfig.additionalManifest\"\n              :editor-mode=\"mode === 'view' ? 'VIEW_CODE' : 'EDIT_CODE'\"\n              initial-yaml-values=\"# Additional Manifest YAML\"\n              class=\"yaml-editor\"\n            />\n          </div>\n        </Tab>\n\n        <!-- Cluster Agent Configuration -->\n        <Tab\n          name=\"clusteragentconfig\"\n          label-key=\"cluster.agentConfig.tabs.cluster\"\n        >\n          <AgentConfiguration\n            v-if=\"value.spec.clusterAgentDeploymentCustomization\"\n            v-model=\"value.spec.clusterAgentDeploymentCustomization\"\n            data-testid=\"rke2-cluster-agent-config\"\n            type=\"cluster\"\n            :mode=\"mode\"\n          />\n        </Tab>\n\n        <!-- Fleet Agent Configuration -->\n        <Tab\n          name=\"fleetagentconfig\"\n          label-key=\"cluster.agentConfig.tabs.fleet\"\n        >\n          <AgentConfiguration\n            v-if=\"value.spec.fleetAgentDeploymentCustomization\"\n            v-model=\"value.spec.fleetAgentDeploymentCustomization\"\n            data-testid=\"rke2-fleet-agent-config\"\n            type=\"fleet\"\n            :mode=\"mode\"\n          />\n        </Tab>\n\n        <!-- Advanced -->\n        <Tab\n          v-if=\"haveArgInfo || agentArgs['protect-kernel-defaults']\"\n          name=\"advanced\"\n          label-key=\"cluster.tabs.advanced\"\n          :weight=\"-1\"\n          @active=\"refreshYamls\"\n        >\n          <template v-if=\"haveArgInfo\">\n            <h3>{{ t('cluster.advanced.argInfo.title') }}</h3>\n            <ArrayListGrouped\n              v-if=\"agentArgs['kubelet-arg']\"\n              v-model=\"rkeConfig.machineSelectorConfig\"\n              class=\"mb-20\"\n              :add-label=\"t('cluster.advanced.argInfo.machineSelector.label')\"\n              :can-remove=\"canRemoveKubeletRow\"\n              :default-add-value=\"{machineLabelSelector: { matchExpressions: [], matchLabels: {} }, config: {'kubelet-arg': []}}\"\n            >\n              <template #default=\"{row}\">\n                <template v-if=\"row.value.machineLabelSelector\">\n                  <h3>{{ t('cluster.advanced.argInfo.machineSelector.title') }}</h3>\n                  <MatchExpressions\n                    v-model=\"row.value.machineLabelSelector\"\n                    class=\"mb-20\"\n                    :mode=\"mode\"\n                    :show-remove=\"false\"\n                    :initial-empty-row=\"true\"\n                  />\n                  <h3>{{ t('cluster.advanced.argInfo.machineSelector.subTitle') }}</h3>\n                </template>\n                <h3 v-else>\n                  {{ advancedTitleAlt }}\n                </h3>\n\n                <ArrayList\n                  v-model=\"row.value.config['kubelet-arg']\"\n                  :mode=\"mode\"\n                  :add-label=\"t('cluster.advanced.argInfo.machineSelector.listLabel')\"\n                  :initial-empty-row=\"!!row.value.machineLabelSelector\"\n                />\n              </template>\n            </ArrayListGrouped>\n            <Banner\n              v-if=\"rkeConfig.machineSelectorConfig.length > 1\"\n              color=\"info\"\n              :label=\"t('cluster.advanced.argInfo.machineSelector.bannerLabel')\"\n            />\n\n            <ArrayList\n              v-if=\"serverArgs['kube-controller-manager-arg']\"\n              v-model=\"serverConfig['kube-controller-manager-arg']\"\n              :mode=\"mode\"\n              :title=\"t('cluster.advanced.argInfo.machineSelector.kubeControllerManagerTitle')\"\n              class=\"mb-20\"\n            />\n            <ArrayList\n              v-if=\"serverArgs['kube-apiserver-arg']\"\n              v-model=\"serverConfig['kube-apiserver-arg']\"\n              :mode=\"mode\"\n              :title=\"t('cluster.advanced.argInfo.machineSelector.kubeApiServerTitle')\"\n              class=\"mb-20\"\n            />\n            <ArrayList\n              v-if=\"serverArgs['kube-scheduler-arg']\"\n              v-model=\"serverConfig['kube-scheduler-arg']\"\n              :mode=\"mode\"\n              :title=\"t('cluster.advanced.argInfo.machineSelector.kubeSchedulerTitle')\"\n            />\n          </template>\n          <template v-if=\"agentArgs['protect-kernel-defaults']\">\n            <div class=\"spacer\" />\n\n            <div class=\"row\">\n              <div class=\"col span-12\">\n                <Checkbox\n                  v-model=\"agentConfig['protect-kernel-defaults']\"\n                  :mode=\"mode\"\n                  :label=\"t('cluster.advanced.agentArgs.label')\"\n                />\n              </div>\n            </div>\n          </template>\n        </Tab>\n\n        <AgentEnv\n          v-model=\"value\"\n          :mode=\"mode\"\n        />\n        <Labels\n          v-model=\"value\"\n          :mode=\"mode\"\n        />\n\n        <!-- Extension tabs -->\n        <Tab\n          v-for=\"tab, i in extensionTabs\"\n          :key=\"`${tab.name}${i}`\"\n          :name=\"tab.name\"\n          :label=\"tab.label\"\n          :label-key=\"tab.labelKey\"\n          :weight=\"tab.weight\"\n          :tooltip=\"tab.tooltip\"\n          :show-header=\"tab.showHeader\"\n          :display-alert-icon=\"tab.displayAlertIcon\"\n          :error=\"tab.error\"\n          :badge=\"tab.badge\"\n        >\n          <component\n            :is=\"tab.component\"\n            :resource=\"value\"\n          />\n        </Tab>\n      </Tabbed>\n    </div>\n\n    <Banner\n      v-if=\"unsupportedSelectorConfig\"\n      color=\"warning\"\n      :label=\"t('cluster.banner.warning')\"\n    />\n\n    <template\n      v-if=\"needCredential && !credentialId\"\n      #form-footer\n    >\n      <div><!-- Hide the outer footer --></div>\n    </template>\n  </CruResource>\n</template>\n\n<style lang=\"scss\" scoped>\n  .min-height {\n    min-height: 40em;\n  }\n  .patch-version {\n    margin-top: 5px;\n  }\n  .header-warnings .banner {\n    margin-bottom: 0;\n  }\n</style>\n"]}]}