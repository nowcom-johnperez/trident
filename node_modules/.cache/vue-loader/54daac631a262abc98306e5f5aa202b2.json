{"remainingRequest":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/@rancher/shell/components/nav/NamespaceFilter.vue?vue&type=script&lang=js","dependencies":[{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/@rancher/shell/components/nav/NamespaceFilter.vue","mtime":1716430447141},{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/cache-loader/dist/cjs.js","mtime":1716430465924},{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/babel-loader/lib/index.js","mtime":1716430465839},{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/cache-loader/dist/cjs.js","mtime":1716430465924},{"path":"/Users/nowcom/Documents/nowcom/trident-extension-package/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js","mtime":1716430467929}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmltcG9ydCB7IG1hcEdldHRlcnMgfSBmcm9tICd2dWV4JzsKaW1wb3J0IHsgTkFNRVNQQUNFX0ZJTFRFUlMsIEFMTF9OQU1FU1BBQ0VTIH0gZnJvbSAnQHNoZWxsL3N0b3JlL3ByZWZzJzsKaW1wb3J0IHsgTkFNRVNQQUNFLCBNQU5BR0VNRU5UIH0gZnJvbSAnQHNoZWxsL2NvbmZpZy90eXBlcyc7CmltcG9ydCB7IHNvcnRCeSB9IGZyb20gJ0BzaGVsbC91dGlscy9zb3J0JzsKaW1wb3J0IHsgaXNBcnJheSwgYWRkT2JqZWN0cywgZmluZEJ5LCBmaWx0ZXJCeSB9IGZyb20gJ0BzaGVsbC91dGlscy9hcnJheSc7CmltcG9ydCB7CiAgTkFNRVNQQUNFX0ZJTFRFUl9BTExfVVNFUiBhcyBBTExfVVNFUiwKICBOQU1FU1BBQ0VfRklMVEVSX0FMTCBhcyBBTEwsCiAgTkFNRVNQQUNFX0ZJTFRFUl9BTExfU1lTVEVNIGFzIEFMTF9TWVNURU0sCiAgTkFNRVNQQUNFX0ZJTFRFUl9BTExfT1JQSEFOUyBhcyBBTExfT1JQSEFOUywKICBOQU1FU1BBQ0VfRklMVEVSX05BTUVTUEFDRURfWUVTIGFzIE5BTUVTUEFDRURfWUVTLAogIE5BTUVTUEFDRV9GSUxURVJfTkFNRVNQQUNFRF9OTyBhcyBOQU1FU1BBQ0VEX05PLAogIGNyZWF0ZU5hbWVzcGFjZUZpbHRlcktleSwKICBOQU1FU1BBQ0VfRklMVEVSX0tJTkRTLAogIE5BTUVTUEFDRV9GSUxURVJfTlNfRlVMTF9QUkVGSVgsCiAgTkFNRVNQQUNFX0ZJTFRFUl9QX0ZVTExfUFJFRklYLAp9IGZyb20gJ0BzaGVsbC91dGlscy9uYW1lc3BhY2UtZmlsdGVyJzsKaW1wb3J0IHsgS0VZIH0gZnJvbSAnQHNoZWxsL3V0aWxzL3BsYXRmb3JtJzsKaW1wb3J0IHBBbmRORmlsdGVyaW5nIGZyb20gJ0BzaGVsbC91dGlscy9wcm9qZWN0QW5kTmFtZXNwYWNlRmlsdGVyaW5nLnV0aWxzJzsKaW1wb3J0IHsgU0VUVElORyB9IGZyb20gJ0BzaGVsbC9jb25maWcvc2V0dGluZ3MnOwoKY29uc3QgZm9yY2VkTmFtZXNwYWNlVmFsaWRUeXBlcyA9IFtOQU1FU1BBQ0VfRklMVEVSX0tJTkRTLkRJVklERVIsIE5BTUVTUEFDRV9GSUxURVJfS0lORFMuUFJPSkVDVCwgTkFNRVNQQUNFX0ZJTFRFUl9LSU5EUy5OQU1FU1BBQ0VdOwoKZXhwb3J0IGRlZmF1bHQgewoKICBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgaXNPcGVuOiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgIGZpbHRlcjogICAgICAgICAgICAgICcnLAogICAgICBoaWRkZW46ICAgICAgICAgICAgICAwLAogICAgICB0b3RhbDogICAgICAgICAgICAgICAwLAogICAgICBhY3RpdmVFbGVtZW50OiAgICAgICBudWxsLAogICAgICBjYWNoZWRGaWx0ZXJlZDogICAgICBbXSwKICAgICAgTkFNRVNQQUNFX0ZJTFRFUl9LSU5EUywKICAgICAgbmFtZXNwYWNlRmlsdGVyTW9kZTogdW5kZWZpbmVkLAogICAgfTsKICB9LAoKICBhc3luYyBmZXRjaCgpIHsKICAgIC8vIERldGVybWluZSBpZiBmaWx0ZXJpbmcgYnkgc3BlY2lmaWMgbmFtZXNwYWNlcy9wcm9qZWN0cyBpcyByZXF1aXJlZAogICAgLy8gVGhpcyBpcyBkb25lIG9uY2UgYW5kIHVwIGZyb250CiAgICAvLyAtIGl0IGRvZXNuJ3QgbmVlZCB0byBiZSByZS1hY3RpdmUKICAgIC8vIC0gYWRkZWQgaXQgYXMgYSBjb21wdXRlZCBjYXVzZWQgbWFzc2l2ZSBhbW91bnRzIG9mIGNodXJuIGFyb3VuZCB0aGUgYGZpbHRlcmVkYCB3YXRjaGVyCiAgICBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnbWFuYWdlbWVudC9maW5kJywgeyB0eXBlOiBNQU5BR0VNRU5ULlNFVFRJTkcsIGlkOiBTRVRUSU5HLlVJX1BFUkZPUk1BTkNFIH0pOwogICAgdGhpcy5uYW1lc3BhY2VGaWx0ZXJNb2RlID0gdGhpcy5jYWxjTmFtZXNwYWNlRmlsdGVyTW9kZSgpOwogIH0sCgogIGNvbXB1dGVkOiB7CiAgICAuLi5tYXBHZXR0ZXJzKFsnY3VycmVudFByb2R1Y3QnXSksCgogICAgaGFzRmlsdGVyKCkgewogICAgICByZXR1cm4gdGhpcy5maWx0ZXIubGVuZ3RoID4gMDsKICAgIH0sCgogICAgZmlsdGVyZWQoKSB7CiAgICAgIGxldCBvdXQgPSB0aGlzLm9wdGlvbnM7CgogICAgICBvdXQgPSBvdXQuZmlsdGVyKChpdGVtKSA9PiB7CiAgICAgICAgLy8gRmlsdGVyIG91dCBhbnl0aGluZyBub3QgYXBwbGljYWJsZSB0byBzaW5nbGV0b24gc2VsZWN0aW9uCiAgICAgICAgaWYgKHRoaXMubmFtZXNwYWNlRmlsdGVyTW9kZT8ubGVuZ3RoKSB7CiAgICAgICAgICAvLyBXZSBhbHdheXMgc2hvdyBkaXZpZGVycywgcHJvamVjdHMgYW5kIG5hbWVzcGFjZXMKICAgICAgICAgIGlmICghZm9yY2VkTmFtZXNwYWNlVmFsaWRUeXBlcy5pbmNsdWRlcyhpdGVtLmtpbmQpKSB7CiAgICAgICAgICAgIGNvbnN0IHZhbGlkQ3VzdG9tVHlwZSA9IHRoaXMubmFtZXNwYWNlRmlsdGVyTW9kZS5maW5kKChwcmVmaXgpID0+IGl0ZW0ua2luZC5zdGFydHNXaXRoKHByZWZpeCkpOwoKICAgICAgICAgICAgaWYgKCF2YWxpZEN1c3RvbVR5cGUpIHsKICAgICAgICAgICAgICAvLyBIaWRlIGFueSBpbnZhbGlkIG9wdGlvbiB0aGF0J3Mgbm90IHNlbGVjdGVkCiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFsdWUuZmluZEluZGV4KCh2KSA9PiB2LmlkID09PSBpdGVtLmlkKSA+PSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGaWx0ZXIgYnkgdGhlIGN1cnJlbnQgZmlsdGVyCiAgICAgICAgaWYgKHRoaXMuaGFzRmlsdGVyKSB7CiAgICAgICAgICByZXR1cm4gaXRlbS5raW5kICE9PSBOQU1FU1BBQ0VfRklMVEVSX0tJTkRTLlNQRUNJQUwgJiYgaXRlbS5sYWJlbC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHRoaXMuZmlsdGVyLnRvTG93ZXJDYXNlKCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwoKICAgICAgaWYgKG91dD8uWzBdPy5raW5kID09PSBOQU1FU1BBQ0VfRklMVEVSX0tJTkRTLkRJVklERVIpIHsKICAgICAgICBvdXQuc3BsaWNlKDAsIDEpOwogICAgICB9CgogICAgICBjb25zdCBtYXBwZWQgPSB0aGlzLnZhbHVlLnJlZHVjZSgobSwgdikgPT4gewogICAgICAgIG1bdi5pZF0gPSB2OwoKICAgICAgICByZXR1cm4gbTsKICAgICAgfSwge30pOwoKICAgICAgLy8gTWFyayBhbGwgb2YgdGhlIHNlbGVjdGVkIG9wdGlvbnMKICAgICAgb3V0LmZvckVhY2goKGkpID0+IHsKICAgICAgICBpLnNlbGVjdGVkID0gISFtYXBwZWRbaS5pZF0gfHwgKGkuaWQgPT09IEFMTCAmJiB0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUubGVuZ3RoID09PSAwKTsKICAgICAgICBpLmVsZW1lbnRJZCA9IChpLmlkIHx8ICcnKS5yZXBsYWNlKCc6Ly8nLCAnXycpOwogICAgICAgIGkuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgLy8gQXJlIHdlIGluIHJlc3RyaWN0ZWQgcmVzb3VyY2UgdHlwZSBtb2RlLCBpZiBzbyBpcyB0aGlzIGFuIGFsbG93ZWQgdHlwZT8KICAgICAgICBpZiAodGhpcy5uYW1lc3BhY2VGaWx0ZXJNb2RlPy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IGlzTGFzdFNlbGVjdGVkID0gaS5zZWxlY3RlZCAmJiAoaS5pZCA9PT0gQUxMIHx8IHRoaXMudmFsdWUubGVuZ3RoID09PSAxKTsKICAgICAgICAgIGNvbnN0IGtpbmRBbGxvd2VkID0gdGhpcy5uYW1lc3BhY2VGaWx0ZXJNb2RlLmZpbmQoKGYpID0+IGYgPT09IGkua2luZCk7CiAgICAgICAgICBjb25zdCBpc05vdEluUHJvamVjdEdyb3VwID0gaS5pZCA9PT0gQUxMX09SUEhBTlM7CgogICAgICAgICAgaS5lbmFibGVkID0gKCFpc0xhc3RTZWxlY3RlZCAmJiBraW5kQWxsb3dlZCkgJiYgIWlzTm90SW5Qcm9qZWN0R3JvdXA7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBvdXQ7CiAgICB9LAoKICAgIHRvb2x0aXAoKSB7CiAgICAgIGlmICh0aGlzLmlzT3BlbiB8fCAodGhpcy50b3RhbCArIHRoaXMuaGlkZGVuKSA9PT0gMCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICBsZXQgdG9vbHRpcCA9ICc8ZGl2IGNsYXNzPSJucy1maWx0ZXItdG9vbHRpcCI+JzsKCiAgICAgICh0aGlzLnZhbHVlIHx8IFtdKS5mb3JFYWNoKCh2KSA9PiB7CiAgICAgICAgdG9vbHRpcCArPSBgPGRpdiBjbGFzcz0ibnMtZmlsdGVyLXRvb2x0aXAtaXRlbSI+PGRpdj4keyB2LmxhYmVsIH08L2Rpdj48L2Rpdj5gOwogICAgICB9KTsKCiAgICAgIHRvb2x0aXAgKz0gJzwvZGl2Pic7CgogICAgICByZXR1cm4gewogICAgICAgIGNvbnRlbnQ6ICAgdG9vbHRpcCwKICAgICAgICBwbGFjZW1lbnQ6ICdib3R0b20nLAogICAgICAgIGRlbGF5OiAgICAgeyBzaG93OiA1MDAgfQogICAgICB9OwogICAgfSwKCiAgICBrZXkoKSB7CiAgICAgIHJldHVybiBjcmVhdGVOYW1lc3BhY2VGaWx0ZXJLZXkodGhpcy4kc3RvcmUuZ2V0dGVyc1snY2x1c3RlcklkJ10sIHRoaXMuY3VycmVudFByb2R1Y3QpOwogICAgfSwKCiAgICBvcHRpb25zKCkgewogICAgICBjb25zdCB0ID0gdGhpcy4kc3RvcmUuZ2V0dGVyc1snaTE4bi90J107CiAgICAgIGxldCBvdXQgPSBbXTsKCiAgICAgIGNvbnN0IHBhcmFtcyA9IHsgLi4udGhpcy4kcm91dGUucGFyYW1zIH07CiAgICAgIGNvbnN0IHJlc291cmNlID0gcGFyYW1zLnJlc291cmNlOwogICAgICAvLyBTb21ldGltZXMsIGRpZmZlcmVudCBwYWdlcyBtYXkgaGF2ZSBkaWZmZXJlbnQgbmFtZXNwYWNlcyB0byBmaWx0ZXIKICAgICAgY29uc3Qgbm90RmlsdGVyTmFtZXNwYWNlcyA9IHRoaXMuJHN0b3JlLmdldHRlcnNbYHR5cGUtbWFwL29wdGlvbnNGb3JgXShyZXNvdXJjZSkubm90RmlsdGVyTmFtZXNwYWNlIHx8IFtdOwoKICAgICAgLy8gVE9ETzogQWRkIHJldHVybiBpbmZvCiAgICAgIGlmICh0aGlzLmN1cnJlbnRQcm9kdWN0Py5jdXN0b21OYW1lc3BhY2VGaWx0ZXIgJiYgdGhpcy5jdXJyZW50UHJvZHVjdD8uaW5TdG9yZSkgewogICAgICAgIC8vIFNvbWV0aW1lcyB0aGUgY29tcG9uZW50IGNhbiBzaG93IGJlZm9yZSB0aGUgJ2N1cnJlbnRQcm9kdWN0JyBoYXMgY2F1Z2h0IHVwLCBzbyBhY2Nlc3MgdGhlIHByb2R1Y3QgdmlhIHRoZSBnZXR0ZXIgcmF0aGVyCiAgICAgICAgLy8gdGhhbiBjYWNoaW5nIGl0IGluIHRoZSBgZmV0Y2hgCgogICAgICAgIC8vIFRoZSBuYW1lc3BhY2UgZGlzcGxheSBvbiB0aGUgbGlzdCBhbmQgZWRpdCBwYWdlcyBzaG91bGQgYmUgdGhlIHNhbWUgYXMgaW4gdGhlIG5hbWVzcGFjZUZpbHRlciBjb21wb25lbnQKICAgICAgICBpZiAodGhpcy4kc3RvcmUuZ2V0dGVyc1tgJHsgdGhpcy5jdXJyZW50UHJvZHVjdC5pblN0b3JlIH0vZmlsdGVyTmFtZXNwYWNlYF0pIHsKICAgICAgICAgIGNvbnN0IGFsbE5hbWVzcGFjZXMgPSB0aGlzLiRzdG9yZS5nZXR0ZXJzW2AkeyB0aGlzLmN1cnJlbnRQcm9kdWN0LmluU3RvcmUgfS9maWx0ZXJOYW1lc3BhY2VgXShub3RGaWx0ZXJOYW1lc3BhY2VzKTsKCiAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ2NoYW5nZUFsbE5hbWVzcGFjZXMnLCBhbGxOYW1lc3BhY2VzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLiRzdG9yZS5nZXR0ZXJzW2AkeyB0aGlzLmN1cnJlbnRQcm9kdWN0LmluU3RvcmUgfS9uYW1lc3BhY2VGaWx0ZXJPcHRpb25zYF0oewogICAgICAgICAgYWRkTmFtZXNwYWNlLAogICAgICAgICAgZGl2aWRlciwKICAgICAgICAgIG5vdEZpbHRlck5hbWVzcGFjZXMKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgLy8gVE9ETzogQWRkIHJldHVybiBpbmZvCiAgICAgIGlmICghdGhpcy5jdXJyZW50UHJvZHVjdD8uaGlkZVN5c3RlbVJlc291cmNlcykgewogICAgICAgIG91dCA9IFsKICAgICAgICAgIHsKICAgICAgICAgICAgaWQ6ICAgIEFMTCwKICAgICAgICAgICAga2luZDogIE5BTUVTUEFDRV9GSUxURVJfS0lORFMuU1BFQ0lBTCwKICAgICAgICAgICAgbGFiZWw6IHQoJ25hdi5ucy5hbGwnKSwKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgIGlkOiAgICBBTExfVVNFUiwKICAgICAgICAgICAga2luZDogIE5BTUVTUEFDRV9GSUxURVJfS0lORFMuU1BFQ0lBTCwKICAgICAgICAgICAgbGFiZWw6IHQoJ25hdi5ucy51c2VyJyksCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBpZDogICAgQUxMX1NZU1RFTSwKICAgICAgICAgICAga2luZDogIE5BTUVTUEFDRV9GSUxURVJfS0lORFMuU1BFQ0lBTCwKICAgICAgICAgICAgbGFiZWw6IHQoJ25hdi5ucy5zeXN0ZW0nKSwKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgIGlkOiAgICBOQU1FU1BBQ0VEX1lFUywKICAgICAgICAgICAga2luZDogIE5BTUVTUEFDRV9GSUxURVJfS0lORFMuU1BFQ0lBTCwKICAgICAgICAgICAgbGFiZWw6IHQoJ25hdi5ucy5uYW1lc3BhY2VkJyksCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBpZDogICAgTkFNRVNQQUNFRF9OTywKICAgICAgICAgICAga2luZDogIE5BTUVTUEFDRV9GSUxURVJfS0lORFMuU1BFQ0lBTCwKICAgICAgICAgICAgbGFiZWw6IHQoJ25hdi5ucy5jbHVzdGVyTGV2ZWwnKSwKICAgICAgICAgIH0sCiAgICAgICAgXTsKCiAgICAgICAgZGl2aWRlcihvdXQpOwogICAgICB9CgogICAgICBjb25zdCBpblN0b3JlID0gdGhpcy4kc3RvcmUuZ2V0dGVyc1snY3VycmVudFN0b3JlJ10oTkFNRVNQQUNFKTsKCiAgICAgIGlmICghaW5TdG9yZSkgewogICAgICAgIHJldHVybiBvdXQ7CiAgICAgIH0KCiAgICAgIGxldCBuYW1lc3BhY2VzID0gc29ydEJ5KAogICAgICAgIHRoaXMuJHN0b3JlLmdldHRlcnNbYCR7IGluU3RvcmUgfS9hbGxgXShOQU1FU1BBQ0UpLAogICAgICAgIFsnbmFtZURpc3BsYXknXQogICAgICApOwoKICAgICAgbmFtZXNwYWNlcyA9IHRoaXMuZmlsdGVyTmFtZXNwYWNlcyhuYW1lc3BhY2VzKTsKCiAgICAgIC8vIGlzUmFuY2hlciA9IG1nbXQgc2NoZW1hcyBhcmUgbG9hZGVkIGFuZCB0aGVyZSdzIGEgcHJvamVjdCBzY2hlbWEKICAgICAgaWYgKHRoaXMuJHN0b3JlLmdldHRlcnNbJ2lzUmFuY2hlciddKSB7CiAgICAgICAgY29uc3QgY2x1c3RlciA9IHRoaXMuJHN0b3JlLmdldHRlcnNbJ2N1cnJlbnRDbHVzdGVyJ107CiAgICAgICAgbGV0IHByb2plY3RzID0gdGhpcy4kc3RvcmUuZ2V0dGVyc1snbWFuYWdlbWVudC9hbGwnXSgKICAgICAgICAgIE1BTkFHRU1FTlQuUFJPSkVDVAogICAgICAgICk7CgogICAgICAgIHByb2plY3RzID0gcHJvamVjdHMuZmlsdGVyKChwKSA9PiB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50UHJvZHVjdD8uaGlkZVN5c3RlbVJlc291cmNlcyA/ICFwLmlzU3lzdGVtICYmIHAuc3BlYy5jbHVzdGVyTmFtZSA9PT0gY2x1c3Rlci5pZCA6IHAuc3BlYy5jbHVzdGVyTmFtZSA9PT0gY2x1c3Rlci5pZDsKICAgICAgICB9KTsKICAgICAgICBwcm9qZWN0cyA9IHNvcnRCeShmaWx0ZXJCeShwcm9qZWN0cywgJ3NwZWMuY2x1c3Rlck5hbWUnLCBjbHVzdGVyLmlkKSwgWwogICAgICAgICAgJ25hbWVEaXNwbGF5JywKICAgICAgICBdKTsKICAgICAgICBjb25zdCBwcm9qZWN0c0J5SWQgPSB7fTsKICAgICAgICBjb25zdCBuYW1lc3BhY2VzQnlQcm9qZWN0ID0ge307CiAgICAgICAgbGV0IGZpcnN0UHJvamVjdCA9IHRydWU7CgogICAgICAgIG5hbWVzcGFjZXNCeVByb2plY3RbbnVsbF0gPSBbXTsgLy8gRm9yIG5hbWVzcGFjZXMgbm90IGluIGEgcHJvamVjdAogICAgICAgIGZvciAoY29uc3QgcHJvamVjdCBvZiBwcm9qZWN0cykgewogICAgICAgICAgcHJvamVjdHNCeUlkW3Byb2plY3QubWV0YWRhdGEubmFtZV0gPSBwcm9qZWN0OwogICAgICAgIH0KCiAgICAgICAgZm9yIChjb25zdCBuYW1lc3BhY2Ugb2YgbmFtZXNwYWNlcykgewogICAgICAgICAgbGV0IHByb2plY3RJZCA9IG5hbWVzcGFjZS5wcm9qZWN0SWQ7CgogICAgICAgICAgaWYgKCFwcm9qZWN0SWQgfHwgIXByb2plY3RzQnlJZFtwcm9qZWN0SWRdKSB7CiAgICAgICAgICAgIC8vIElmIHRoZXJlJ3MgYSBwcm9qZWN0SWQgYnV0IHRoYXQgcHJvamVjdCBkb2Vzbid0IGV4aXN0LCB0cmVhdCBpdCBsaWtlIG5vIHByb2plY3QKICAgICAgICAgICAgcHJvamVjdElkID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICBsZXQgZW50cnkgPSBuYW1lc3BhY2VzQnlQcm9qZWN0W3Byb2plY3RJZF07CgogICAgICAgICAgaWYgKCFlbnRyeSkgewogICAgICAgICAgICBlbnRyeSA9IFtdOwogICAgICAgICAgICBuYW1lc3BhY2VzQnlQcm9qZWN0W25hbWVzcGFjZS5wcm9qZWN0SWRdID0gZW50cnk7CiAgICAgICAgICB9CiAgICAgICAgICBlbnRyeS5wdXNoKG5hbWVzcGFjZSk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGNvbnN0IHByb2plY3Qgb2YgcHJvamVjdHMpIHsKICAgICAgICAgIGNvbnN0IGlkID0gcHJvamVjdC5tZXRhZGF0YS5uYW1lOwoKICAgICAgICAgIGlmIChmaXJzdFByb2plY3QpIHsKICAgICAgICAgICAgZmlyc3RQcm9qZWN0ID0gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkaXZpZGVyKG91dCk7CiAgICAgICAgICB9CgogICAgICAgICAgb3V0LnB1c2goewogICAgICAgICAgICBpZDogICAgYCR7IE5BTUVTUEFDRV9GSUxURVJfUF9GVUxMX1BSRUZJWCB9JHsgaWQgfWAsCiAgICAgICAgICAgIGtpbmQ6ICBOQU1FU1BBQ0VfRklMVEVSX0tJTkRTLlBST0pFQ1QsCiAgICAgICAgICAgIGxhYmVsOiB0KCduYXYubnMucHJvamVjdCcsIHsgbmFtZTogcHJvamVjdC5uYW1lRGlzcGxheSB9KSwKICAgICAgICAgIH0pOwoKICAgICAgICAgIGNvbnN0IGZvclRoaXNQcm9qZWN0ID0gbmFtZXNwYWNlc0J5UHJvamVjdFtpZF0gfHwgW107CgogICAgICAgICAgYWRkTmFtZXNwYWNlKG91dCwgZm9yVGhpc1Byb2plY3QpOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgb3JwaGFucyA9IG5hbWVzcGFjZXNCeVByb2plY3RbbnVsbF07CgogICAgICAgIGlmIChvcnBoYW5zLmxlbmd0aCkgewogICAgICAgICAgaWYgKCFmaXJzdFByb2plY3QpIHsKICAgICAgICAgICAgZGl2aWRlcihvdXQpOwogICAgICAgICAgfQoKICAgICAgICAgIG91dC5wdXNoKHsKICAgICAgICAgICAgaWQ6ICAgICAgIEFMTF9PUlBIQU5TLAogICAgICAgICAgICBraW5kOiAgICAgTkFNRVNQQUNFX0ZJTFRFUl9LSU5EUy5QUk9KRUNULAogICAgICAgICAgICBsYWJlbDogICAgdCgnbmF2Lm5zLm9ycGhhbicpLAogICAgICAgICAgICBkaXNhYmxlZDogdHJ1ZSwKICAgICAgICAgIH0pOwoKICAgICAgICAgIGFkZE5hbWVzcGFjZShvdXQsIG9ycGhhbnMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBhZGROYW1lc3BhY2Uob3V0LCBuYW1lc3BhY2VzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG91dDsKCiAgICAgIGZ1bmN0aW9uIGFkZE5hbWVzcGFjZShvdXQsIG5hbWVzcGFjZXMpIHsKICAgICAgICBpZiAoIWlzQXJyYXkobmFtZXNwYWNlcykpIHsKICAgICAgICAgIG5hbWVzcGFjZXMgPSBbbmFtZXNwYWNlc107CiAgICAgICAgfQoKICAgICAgICBhZGRPYmplY3RzKAogICAgICAgICAgb3V0LAogICAgICAgICAgbmFtZXNwYWNlcy5tYXAoKG5hbWVzcGFjZSkgPT4gewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGlkOiAgICBgJHsgTkFNRVNQQUNFX0ZJTFRFUl9OU19GVUxMX1BSRUZJWCB9JHsgbmFtZXNwYWNlLmlkIH1gLAogICAgICAgICAgICAgIGtpbmQ6ICBOQU1FU1BBQ0VfRklMVEVSX0tJTkRTLk5BTUVTUEFDRSwKICAgICAgICAgICAgICBsYWJlbDogdCgnbmF2Lm5zLm5hbWVzcGFjZScsIHsgbmFtZTogbmFtZXNwYWNlLm5hbWVEaXNwbGF5IH0pLAogICAgICAgICAgICB9OwogICAgICAgICAgfSkKICAgICAgICApOwogICAgICB9CgogICAgICBmdW5jdGlvbiBkaXZpZGVyKG91dCkgewogICAgICAgIG91dC5wdXNoKHsKICAgICAgICAgIGtpbmQ6ICAgICBOQU1FU1BBQ0VfRklMVEVSX0tJTkRTLkRJVklERVIsCiAgICAgICAgICBsYWJlbDogICAgYERpdmlkZXIgJHsgb3V0Lmxlbmd0aCB9YCwKICAgICAgICAgIGRpc2FibGVkOiB0cnVlLAogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIGlzU2luZ2xlU3BlY2lhbCgpIHsKICAgICAgcmV0dXJuIHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5sZW5ndGggPT09IDEgJiYgdGhpcy52YWx1ZVswXS5raW5kID09PSBOQU1FU1BBQ0VfRklMVEVSX0tJTkRTLlNQRUNJQUw7CiAgICB9LAoKICAgIHZhbHVlOiB7CiAgICAgIGdldCgpIHsKICAgICAgICAvLyBVc2UgbGFzdCBwaWNrZWQgZmlsdGVyIGZyb20gdXNlciBwcmVmZXJlbmNlcwogICAgICAgIGNvbnN0IHByZWZzID0gdGhpcy4kc3RvcmUuZ2V0dGVyc1sncHJlZnMvZ2V0J10oTkFNRVNQQUNFX0ZJTFRFUlMpOwogICAgICAgIGNvbnN0IHZhbHVlcyA9IHByZWZzICYmIHByZWZzW3RoaXMua2V5XSA/IHByZWZzW3RoaXMua2V5XSA6IHRoaXMuZGVmYXVsdE9wdGlvbigpOwogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgogICAgICAgIC8vIFJlbW92ZSB2YWx1ZXMgdGhhdCBhcmUgbm90IHZhbGlkIG9wdGlvbnMKICAgICAgICBjb25zdCBmaWx0ZXJzID0gdmFsdWVzCiAgICAgICAgICAubWFwKCh2YWx1ZSkgPT4gewogICAgICAgICAgICByZXR1cm4gZmluZEJ5KG9wdGlvbnMsICdpZCcsIHZhbHVlKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuZmlsdGVyKCh4KSA9PiAhIXgpOwoKICAgICAgICByZXR1cm4gZmlsdGVyczsKICAgICAgfSwKCiAgICAgIHNldChuZXUpIHsKICAgICAgICBjb25zdCBvbGQgPSAodGhpcy52YWx1ZSB8fCBbXSkuc2xpY2UoKTsKCiAgICAgICAgbmV1ID0gbmV1LmZpbHRlcigoeCkgPT4gISF4LmlkKTsKCiAgICAgICAgY29uc3QgbGFzdCA9IG5ldVtuZXUubGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgbGFzdElzU3BlY2lhbCA9IGxhc3Q/LmtpbmQgPT09IE5BTUVTUEFDRV9GSUxURVJfS0lORFMuU1BFQ0lBTDsKICAgICAgICBjb25zdCBoYWRVc2VyID0gISFvbGQuZmluZCgoeCkgPT4geC5pZCA9PT0gQUxMX1VTRVIpOwogICAgICAgIGNvbnN0IGhhZEFsbCA9ICEhb2xkLmZpbmQoKHgpID0+IHguaWQgPT09IEFMTCk7CgogICAgICAgIGlmIChsYXN0SXNTcGVjaWFsKSB7CiAgICAgICAgICBuZXUgPSBbbGFzdF07CiAgICAgICAgfQoKICAgICAgICBpZiAobmV1Lmxlbmd0aCA+IDEpIHsKICAgICAgICAgIG5ldSA9IG5ldS5maWx0ZXIoKHgpID0+IHgua2luZCAhPT0gTkFNRVNQQUNFX0ZJTFRFUl9LSU5EUy5TUEVDSUFMKTsKICAgICAgICB9CgogICAgICAgIGlmIChuZXUuZmluZCgoeCkgPT4geC5pZCA9PT0gJ2FsbCcpKSB7CiAgICAgICAgICBuZXUgPSBbXTsKICAgICAgICB9CgogICAgICAgIGxldCBpZHM7CgogICAgICAgIC8vIElmIHRoZXJlIHdhcyBzb21ldGhpbmcgc2VsZWN0ZWQgYW5kIHlvdSByZW1vdmUgaXQsIGdvIGJhY2sgdG8gdXNlciBieSBkZWZhdWx0CiAgICAgICAgLy8gVW5sZXNzIGl0IHdhcyB1c2VyIG9yIGFsbAogICAgICAgIGlmIChuZXUubGVuZ3RoID09PSAwICYmICFoYWRVc2VyICYmICFoYWRBbGwpIHsKICAgICAgICAgIGlkcyA9IHRoaXMuZGVmYXVsdE9wdGlvbigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZHMgPSBuZXUubWFwKCh4KSA9PiB4LmlkKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICAgIHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdzd2l0Y2hOYW1lc3BhY2VzJywgewogICAgICAgICAgICBpZHMsCiAgICAgICAgICAgIGtleTogdGhpcy5rZXkKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9LAogICAgfQogIH0sCgogIGJlZm9yZURlc3Ryb3koKSB7CiAgICB0aGlzLnJlbW92ZUNsb3NlS2V5SGFuZGxlcigpOwogIH0sCgogIG1vdW50ZWQoKSB7CiAgICB0aGlzLmxheW91dCgpOwogIH0sCgogIHdhdGNoOiB7CiAgICB2YWx1ZShuZXUpIHsKICAgICAgdGhpcy5sYXlvdXQoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBXaGVuIHRoZXJlIGFyZSB0aG91c2FuZHMgb2YgZW50cmllcyBjZXJ0YWluIGFjdGlvbnMgKGRyb3AgZG93biBvcGVuZWQsIHNlbGVjdGlvbiBjaGFuZ2VkLCBldGMpIHRha2UgYSBsb25nIHRpbWUgdG8gY29tcGxldGUgKHVwd2FyZHMKICAgICAqIG9mIDUgc2Vjb25kcykKICAgICAqCiAgICAgKiBUaGlzIGlzIGNhdXNlZCBieSBjaHVybiBvZiB0aGUgZmlsdGVyZWQgYW5kIG9wdGlvbnMgY29tcHV0ZWQgcHJvcGVydGllcyBjYXVzaW5nIG11bHRpcGxlIHJlbmRlcnMgZm9yIGVhY2ggYWN0aW9uLgogICAgICoKICAgICAqIFRvIGJyZWFrIHRoaXMgbXVsdGlwbGUtcmVuZGVyIHBlciBjeWNsZSBiZWhhdmlvdXIgZGV0YXRjaCBgZmlsdGVyZWRgIGZyb20gdGhlIHZhbHVlIHVzZWQgaW4gYHYtZm9yYC4KICAgICAqCiAgICAgKi8KICAgIGZpbHRlcmVkKG5ldSkgewogICAgICBpZiAoISFuZXUpIHsKICAgICAgICB0aGlzLmNhY2hlZEZpbHRlcmVkID0gbmV1OwogICAgICB9CiAgICB9CiAgfSwKCiAgbWV0aG9kczogewogICAgZmlsdGVyTmFtZXNwYWNlcyhuYW1lc3BhY2VzKSB7CiAgICAgIGlmICh0aGlzLiRzdG9yZS5nZXR0ZXJzWydwcmVmcy9nZXQnXShBTExfTkFNRVNQQUNFUykpIHsKICAgICAgICAvLyBJZiBhbGwgbmFtZXNwYWNlcyBvcHRpb25zIGFyZSB0dXJuZWQgb24gaW4gdGhlIHVzZXIgcHJlZmVyZW5jZXMsCiAgICAgICAgLy8gcmV0dXJuIGFsbCBuYW1lc3BhY2VzIGluY2x1ZGluZyBzeXN0ZW0gbmFtZXNwYWNlcyBhbmQgUkJBQwogICAgICAgIC8vIG1hbmFnZW1lbnQgbmFtZXNwYWNlcy4KICAgICAgICByZXR1cm4gbmFtZXNwYWNlczsKICAgICAgfQoKICAgICAgcmV0dXJuIG5hbWVzcGFjZXMuZmlsdGVyKChuYW1lc3BhY2UpID0+IHsKICAgICAgICAvLyBPdGhlcndpc2Ugb25seSBmaWx0ZXIgb3V0IG9ic2N1cmUgbmFtZXNwYWNlcywgc3VjaCBhcyBuYW1lc3BhY2VzCiAgICAgICAgLy8gdGhhdCBSYW5jaGVyIHVzZXMgdG8gbWFuYWdlIFJCQUMgZm9yIHByb2plY3RzLCB3aGljaCBzaG91bGQgbm90IGJlCiAgICAgICAgLy8gZWRpdGVkIG9yIGRlbGV0ZWQgYnkgUmFuY2hlciB1c2Vycy4KICAgICAgICByZXR1cm4gIW5hbWVzcGFjZS5pc09ic2N1cmU7CiAgICAgIH0pOwogICAgfSwKICAgIC8vIExheW91dCB0aGUgY29udGVudCBpbiB0aGUgZHJvcGRvd24gYm94IHRvIGJlc3QgdXNlIHRoZSBzcGFjZSB0byBzaG93IHRoZSBzZWxlY3Rpb24KICAgIGxheW91dCgpIHsKICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgIC8vIE9uZSB3ZSBoYXZlIHJlLXJlbmRlcmVkLCBzZWUgd2hhdCB3ZSBjYW4gZml0IGluIHRoZSBjb250cm9sIHRvIHNob3cgdGhlIHNlbGVjdGVkIG5hbWVzcGFjZXMKICAgICAgICBpZiAodGhpcy4kcmVmcy52YWx1ZXMpIHsKICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuJHJlZnMudmFsdWVzOwogICAgICAgICAgY29uc3Qgb3ZlcmZsb3cgPSBjb250YWluZXIuc2Nyb2xsV2lkdGggPiBjb250YWluZXIub2Zmc2V0V2lkdGg7CiAgICAgICAgICBsZXQgaGlkZGVuID0gMDsKCiAgICAgICAgICBjb25zdCBkcm9wZG93biA9IHRoaXMuJHJlZnMuZHJvcGRvd247CiAgICAgICAgICAvLyBSZW1vdmUgcGFkZGluZyBhbmQgZHJvcGRvd24gYXJyb3cgc2l6ZQogICAgICAgICAgY29uc3QgbWF4V2lkdGggPSBkcm9wZG93bi5vZmZzZXRXaWR0aCAtIDIwIC0gMjQ7CgogICAgICAgICAgLy8gSWYgd2UgYXJlIG92ZXJmbG93aW5nLCB0aGVuIGFsbG93IHNvbWUgc3BhY2UgZm9yIHRoZSArTiBpbmRpY2F0b3IKICAgICAgICAgIGNvbnN0IGl0ZW1Db3VudCA9IHRoaXMuJHJlZnMudmFsdWUgPyB0aGlzLiRyZWZzLnZhbHVlLmxlbmd0aCA6IDA7CiAgICAgICAgICBsZXQgY3VycmVudFdpZHRoID0gMDsKICAgICAgICAgIGxldCBzaG93ID0gdHJ1ZTsKCiAgICAgICAgICB0aGlzLnRvdGFsID0gMDsKCiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1Db3VudDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLiRyZWZzLnZhbHVlW2ldOwogICAgICAgICAgICBsZXQgaXRlbVdpZHRoID0gaXRlbS5vZmZzZXRXaWR0aCArIDEwOwoKICAgICAgICAgICAgLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgaXRlbSBhbmQgd2UgaGF2ZSBvdmVyZmxvdyB0aGVuIGFkZCBvbiBzb21lIHNwYWNlIGZvciB0aGUgK04KICAgICAgICAgICAgaWYgKGkgPT09IDAgJiYgb3ZlcmZsb3cpIHsKICAgICAgICAgICAgICBpdGVtV2lkdGggKz0gNDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN1cnJlbnRXaWR0aCArPSBpdGVtV2lkdGg7CgogICAgICAgICAgICBpZiAoc2hvdykgewogICAgICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBDYW4ndCBldmVuIGZpdCB0aGUgZmlyc3QgaXRlbSBpbgogICAgICAgICAgICAgICAgaWYgKGl0ZW1XaWR0aCA+IG1heFdpZHRoKSB7CiAgICAgICAgICAgICAgICAgIHNob3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgdGhpcy50b3RhbCA9IHRoaXMudmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG93ID0gY3VycmVudFdpZHRoIDwgbWF4V2lkdGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBoaWRkZW4gKz0gc2hvdyA/IDAgOiAxOwogICAgICAgICAgICBpdGVtLnN0eWxlLnZpc2liaWxpdHkgPSBzaG93ID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5oaWRkZW4gPSB0aGlzLnRvdGFsID4gMCA/IDAgOiBoaWRkZW47CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBhZGRDbG9zZUtleUhhbmRsZXIoKSB7CiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgdGhpcy5jbG9zZUtleUhhbmRsZXIpOwogICAgfSwKICAgIHJlbW92ZUNsb3NlS2V5SGFuZGxlcigpIHsKICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB0aGlzLmNsb3NlS2V5SGFuZGxlcik7CiAgICB9LAogICAgY2xvc2VLZXlIYW5kbGVyKGUpIHsKICAgICAgaWYgKGUua2V5Q29kZSA9PT0gS0VZLkVTQ0FQRSApIHsKICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBLZXlib2FyZCBzdXBwb3J0CiAgICBpdGVtS2V5SGFuZGxlcihlLCBvcHQpIHsKICAgICAgaWYgKGUua2V5Q29kZSA9PT0gS0VZLkRPV04gKSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgdGhpcy5kb3duKCk7CiAgICAgIH0gZWxzZSBpZiAoZS5rZXlDb2RlID09PSBLRVkuVVAgKSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgdGhpcy51cCgpOwogICAgICB9IGVsc2UgaWYgKGUua2V5Q29kZSA9PT0gS0VZLlNQQUNFIHx8IGUua2V5Q29kZSA9PT0gS0VZLkNSKSB7CiAgICAgICAgaWYgKHRoaXMubmFtZXNwYWNlRmlsdGVyTW9kZSAmJiAhb3B0LmVuYWJsZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgdGhpcy5zZWxlY3RPcHRpb24ob3B0KTsKICAgICAgICBlLnRhcmdldC5mb2N1cygpOwogICAgICB9CiAgICB9LAogICAgaW5wdXRLZXlIYW5kbGVyKGUpIHsKICAgICAgc3dpdGNoIChlLmtleUNvZGUpIHsKICAgICAgY2FzZSBLRVkuRE9XTjoKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICB0aGlzLmRvd24odHJ1ZSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgS0VZLlRBQjoKICAgICAgICAvLyBUYWIgb3V0IG9mIHRoZSBpbnB1dCBib3gKICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgZS50YXJnZXQuYmx1cigpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIEtFWS5DUjoKICAgICAgICBpZiAodGhpcy5maWx0ZXJlZC5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIHRoaXMuc2VsZWN0T3B0aW9uKHRoaXMuZmlsdGVyZWRbMF0pOwogICAgICAgICAgdGhpcy5maWx0ZXIgPSAnJzsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0sCiAgICBtb3VzZU92ZXIoZXZlbnQpIHsKICAgICAgY29uc3QgZWwgPSBldmVudD8ucGF0aD8uZmluZCgoZSkgPT4gZS5jbGFzc0xpc3QuY29udGFpbnMoJ25zLW9wdGlvbicpKTsKCiAgICAgIHRoaXMuYWN0aXZlRWxlbWVudCA9IGVsOwogICAgfSwKICAgIHNldEFjdGl2ZUVsZW1lbnQoZWwpIHsKICAgICAgaWYgKCFlbD8uZm9jdXMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGVsLmZvY3VzKCk7CiAgICAgIHRoaXMuYWN0aXZlRWxlbWVudCA9IG51bGw7CiAgICB9LAogICAgZG93bihpbnB1dCkgewogICAgICBjb25zdCBleGlzaW5nID0gdGhpcy5hY3RpdmVFbGVtZW50IHx8IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CgogICAgICAvLyBGb2N1cyB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgbGlzdAogICAgICBpZiAoaW5wdXQgfHwgIWV4aXNpbmcpIHsKICAgICAgICBpZiAodGhpcy4kcmVmcy5vcHRpb25zKSB7CiAgICAgICAgICBjb25zdCBjID0gdGhpcy4kcmVmcy5vcHRpb25zLmNoaWxkcmVuOwoKICAgICAgICAgIGlmIChjICYmIGMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB0aGlzLnNldEFjdGl2ZUVsZW1lbnQoY1swXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGxldCBuZXh0ID0gZXhpc2luZy5uZXh0U2libGluZzsKCiAgICAgICAgaWYgKG5leHQ/LmNoaWxkcmVuPy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBuZXh0LmNoaWxkcmVuWzBdOwoKICAgICAgICAgIC8vIFNraXAgb3ZlciBkaXZpZGVycyAoYXNzdW1lcyB3ZSBkb24ndCBoYXZlIHR3byBkaXZpZGVycyBuZXh0IHRvIGVhY2ggb3RoZXIpCiAgICAgICAgICBpZiAoaXRlbS5jbGFzc0xpc3QuY29udGFpbnMoJ25zLWRpdmlkZXInKSkgewogICAgICAgICAgICBuZXh0ID0gbmV4dC5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuZXh0Py5mb2N1cykgewogICAgICAgICAgdGhpcy5zZXRBY3RpdmVFbGVtZW50KG5leHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHVwKCkgewogICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgewogICAgICAgIGxldCBwcmV2ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5wcmV2aW91c1NpYmxpbmc7CgogICAgICAgIGlmIChwcmV2Py5jaGlsZHJlbj8ubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCBpdGVtID0gcHJldi5jaGlsZHJlblswXTsKCiAgICAgICAgICBpZiAoaXRlbS5jbGFzc0xpc3QuY29udGFpbnMoJ25zLWRpdmlkZXInKSkgewogICAgICAgICAgICBwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAocHJldj8uZm9jdXMpIHsKICAgICAgICAgIHRoaXMuc2V0QWN0aXZlRWxlbWVudChwcmV2KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICB0b2dnbGUoKSB7CiAgICAgIGlmICh0aGlzLmlzT3BlbikgewogICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wZW4oKTsKICAgICAgfQogICAgfSwKICAgIG9wZW4oKSB7CiAgICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTsKICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgIHRoaXMuJHJlZnMuZmlsdGVyLmZvY3VzKCk7CiAgICAgIH0pOwogICAgICB0aGlzLmFkZENsb3NlS2V5SGFuZGxlcigpOwogICAgICB0aGlzLmxheW91dCgpOwogICAgfSwKICAgIGNsb3NlKCkgewogICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlOwogICAgICB0aGlzLmFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICB0aGlzLnJlbW92ZUNsb3NlS2V5SGFuZGxlcigpOwogICAgICB0aGlzLmxheW91dCgpOwogICAgfSwKICAgIGNsZWFyKCkgewogICAgICB0aGlzLnZhbHVlID0gW107CiAgICB9LAogICAgc2VsZWN0T3B0aW9uKG9wdGlvbikgewogICAgICAvLyBJZ25vcmUgY2xpY2sgZm9yIGEgZGl2aWRlcgogICAgICBpZiAob3B0aW9uLmtpbmQgPT09IE5BTUVTUEFDRV9GSUxURVJfS0lORFMuRElWSURFUikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmFsdWU7CgogICAgICAvLyBSZW1vdmUgaW52YWxpZAogICAgICBpZiAoISF0aGlzLm5hbWVzcGFjZUZpbHRlck1vZGU/Lmxlbmd0aCkgewogICAgICAgIHRoaXMudmFsdWUuZm9yRWFjaCgodikgPT4gewogICAgICAgICAgaWYgKCF0aGlzLm5hbWVzcGFjZUZpbHRlck1vZGUuZmluZCgoZikgPT4gZiA9PT0gdi5raW5kKSkgewogICAgICAgICAgICBjb25zdCBpbmRleCA9IGN1cnJlbnQuZmluZEluZGV4KChjKSA9PiBjLmlkID09PSB2LmlkKTsKCiAgICAgICAgICAgIGN1cnJlbnQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgY29uc3QgZXhpc3RzID0gY3VycmVudC5maW5kSW5kZXgoKHYpID0+IHYuaWQgPT09IG9wdGlvbi5pZCk7CgogICAgICAvLyBSZW1vdmUgaWYgaXQgZXhpc3RzIChvciBhbHdheXMgYWRkIGlmIGluIHNpbmdsZXRvbiBtb2RlIC0gd2UndmUgcmVzZXQgdGhlIGxpc3QgYWJvdmUpCiAgICAgIGlmIChleGlzdHMgIT09IC0xKSB7CiAgICAgICAgY3VycmVudC5zcGxpY2UoZXhpc3RzLCAxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJyZW50LnB1c2gob3B0aW9uKTsKICAgICAgfQoKICAgICAgdGhpcy52YWx1ZSA9IGN1cnJlbnQ7CgogICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgewogICAgICAgIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQuYmx1cigpOwogICAgICB9CiAgICB9LAogICAgaGFuZGxlVmFsdWVNb3VzZURvd24obnMsIGV2ZW50KSB7CiAgICAgIHRoaXMucmVtb3ZlT3B0aW9uKG5zLCBldmVudCk7CgogICAgICBpZiAodGhpcy52YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLm9wZW4oKTsKICAgICAgfQogICAgfSwKCiAgICByZW1vdmVPcHRpb24obnMsIGV2ZW50KSB7CiAgICAgIHRoaXMuc2VsZWN0T3B0aW9uKG5zKTsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9LAoKICAgIGRlZmF1bHRPcHRpb24oKSB7CiAgICAgIC8vIE5vdGUgLSBUaGlzIGlzIG9uZSBwbGFjZSB3aGVyZSBhIGRlZmF1bHQgbnMvcHJvamVjdCBmaWx0ZXIgdmFsdWUgaXMgcHJvdmlkZWQgKEFMTF9VU0VSKQogICAgICAvLyBUaGVyZSdzIGFsc28uLgogICAgICAvLyAtIGRhc2hib2FyZCByb290IHN0b3JlIGBsb2FkQ2x1c3RlcmAgLS0+IHdoZW4gYHVwZGF0ZU5hbWVzcGFjZXNgIGlzIGRpc3BhdGNoZWQKICAgICAgLy8gLSBoYXJ2ZXN0ZXIgcm9vdCBzdG9yZSBgbG9hZENsdXN0ZXJgIC0tPiB3aGVuIGB1cGRhdGVOYW1lc3BhY2VzYCBpcyBkaXNwYXRjaGVkIChjYW4gYmUgZGlzY2FyZGVkKQogICAgICAvLyBEdWUgdG8gdGhpcywgd2UgY2FuJ3QgcmVhbGx5IHNldCBhIG5pY2VyIGRlZmF1bHQgd2hlbiBmb3JjZWQgbnMvcHJvamVjdCBmaWx0ZXJpbmcgaXMgb24gKEFMTF9VU0VSIGlzIGludmFsaWQpCiAgICAgIGlmICh0aGlzLmN1cnJlbnRQcm9kdWN0Py5jdXN0b21OYW1lc3BhY2VGaWx0ZXIpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KCiAgICAgIHJldHVybiBbQUxMX1VTRVJdOwogICAgfSwKCiAgICBjYWxjTmFtZXNwYWNlRmlsdGVyTW9kZSgpIHsKICAgICAgaWYgKHBBbmRORmlsdGVyaW5nLmlzRW5hYmxlZCh0aGlzLiRzdG9yZS5nZXR0ZXJzKSkgewogICAgICAgIHJldHVybiBbTkFNRVNQQUNFX0ZJTFRFUl9LSU5EUy5OQU1FU1BBQ0UsIE5BTUVTUEFDRV9GSUxURVJfS0lORFMuUFJPSkVDVF07CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfSwKICB9Cn07Cg=="},{"version":3,"sources":["NamespaceFilter.vue"],"names":[],"mappings":";AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA","file":"NamespaceFilter.vue","sourceRoot":"node_modules/@rancher/shell/components/nav","sourcesContent":["<script>\nimport { mapGetters } from 'vuex';\nimport { NAMESPACE_FILTERS, ALL_NAMESPACES } from '@shell/store/prefs';\nimport { NAMESPACE, MANAGEMENT } from '@shell/config/types';\nimport { sortBy } from '@shell/utils/sort';\nimport { isArray, addObjects, findBy, filterBy } from '@shell/utils/array';\nimport {\n  NAMESPACE_FILTER_ALL_USER as ALL_USER,\n  NAMESPACE_FILTER_ALL as ALL,\n  NAMESPACE_FILTER_ALL_SYSTEM as ALL_SYSTEM,\n  NAMESPACE_FILTER_ALL_ORPHANS as ALL_ORPHANS,\n  NAMESPACE_FILTER_NAMESPACED_YES as NAMESPACED_YES,\n  NAMESPACE_FILTER_NAMESPACED_NO as NAMESPACED_NO,\n  createNamespaceFilterKey,\n  NAMESPACE_FILTER_KINDS,\n  NAMESPACE_FILTER_NS_FULL_PREFIX,\n  NAMESPACE_FILTER_P_FULL_PREFIX,\n} from '@shell/utils/namespace-filter';\nimport { KEY } from '@shell/utils/platform';\nimport pAndNFiltering from '@shell/utils/projectAndNamespaceFiltering.utils';\nimport { SETTING } from '@shell/config/settings';\n\nconst forcedNamespaceValidTypes = [NAMESPACE_FILTER_KINDS.DIVIDER, NAMESPACE_FILTER_KINDS.PROJECT, NAMESPACE_FILTER_KINDS.NAMESPACE];\n\nexport default {\n\n  data() {\n    return {\n      isOpen:              false,\n      filter:              '',\n      hidden:              0,\n      total:               0,\n      activeElement:       null,\n      cachedFiltered:      [],\n      NAMESPACE_FILTER_KINDS,\n      namespaceFilterMode: undefined,\n    };\n  },\n\n  async fetch() {\n    // Determine if filtering by specific namespaces/projects is required\n    // This is done once and up front\n    // - it doesn't need to be re-active\n    // - added it as a computed caused massive amounts of churn around the `filtered` watcher\n    await this.$store.dispatch('management/find', { type: MANAGEMENT.SETTING, id: SETTING.UI_PERFORMANCE });\n    this.namespaceFilterMode = this.calcNamespaceFilterMode();\n  },\n\n  computed: {\n    ...mapGetters(['currentProduct']),\n\n    hasFilter() {\n      return this.filter.length > 0;\n    },\n\n    filtered() {\n      let out = this.options;\n\n      out = out.filter((item) => {\n        // Filter out anything not applicable to singleton selection\n        if (this.namespaceFilterMode?.length) {\n          // We always show dividers, projects and namespaces\n          if (!forcedNamespaceValidTypes.includes(item.kind)) {\n            const validCustomType = this.namespaceFilterMode.find((prefix) => item.kind.startsWith(prefix));\n\n            if (!validCustomType) {\n              // Hide any invalid option that's not selected\n              return this.value.findIndex((v) => v.id === item.id) >= 0;\n            }\n          }\n        }\n\n        // Filter by the current filter\n        if (this.hasFilter) {\n          return item.kind !== NAMESPACE_FILTER_KINDS.SPECIAL && item.label.toLowerCase().includes(this.filter.toLowerCase());\n        }\n\n        return true;\n      });\n\n      if (out?.[0]?.kind === NAMESPACE_FILTER_KINDS.DIVIDER) {\n        out.splice(0, 1);\n      }\n\n      const mapped = this.value.reduce((m, v) => {\n        m[v.id] = v;\n\n        return m;\n      }, {});\n\n      // Mark all of the selected options\n      out.forEach((i) => {\n        i.selected = !!mapped[i.id] || (i.id === ALL && this.value && this.value.length === 0);\n        i.elementId = (i.id || '').replace('://', '_');\n        i.enabled = true;\n        // Are we in restricted resource type mode, if so is this an allowed type?\n        if (this.namespaceFilterMode?.length) {\n          const isLastSelected = i.selected && (i.id === ALL || this.value.length === 1);\n          const kindAllowed = this.namespaceFilterMode.find((f) => f === i.kind);\n          const isNotInProjectGroup = i.id === ALL_ORPHANS;\n\n          i.enabled = (!isLastSelected && kindAllowed) && !isNotInProjectGroup;\n        }\n      });\n\n      return out;\n    },\n\n    tooltip() {\n      if (this.isOpen || (this.total + this.hidden) === 0) {\n        return null;\n      }\n\n      let tooltip = '<div class=\"ns-filter-tooltip\">';\n\n      (this.value || []).forEach((v) => {\n        tooltip += `<div class=\"ns-filter-tooltip-item\"><div>${ v.label }</div></div>`;\n      });\n\n      tooltip += '</div>';\n\n      return {\n        content:   tooltip,\n        placement: 'bottom',\n        delay:     { show: 500 }\n      };\n    },\n\n    key() {\n      return createNamespaceFilterKey(this.$store.getters['clusterId'], this.currentProduct);\n    },\n\n    options() {\n      const t = this.$store.getters['i18n/t'];\n      let out = [];\n\n      const params = { ...this.$route.params };\n      const resource = params.resource;\n      // Sometimes, different pages may have different namespaces to filter\n      const notFilterNamespaces = this.$store.getters[`type-map/optionsFor`](resource).notFilterNamespace || [];\n\n      // TODO: Add return info\n      if (this.currentProduct?.customNamespaceFilter && this.currentProduct?.inStore) {\n        // Sometimes the component can show before the 'currentProduct' has caught up, so access the product via the getter rather\n        // than caching it in the `fetch`\n\n        // The namespace display on the list and edit pages should be the same as in the namespaceFilter component\n        if (this.$store.getters[`${ this.currentProduct.inStore }/filterNamespace`]) {\n          const allNamespaces = this.$store.getters[`${ this.currentProduct.inStore }/filterNamespace`](notFilterNamespaces);\n\n          this.$store.commit('changeAllNamespaces', allNamespaces);\n        }\n\n        return this.$store.getters[`${ this.currentProduct.inStore }/namespaceFilterOptions`]({\n          addNamespace,\n          divider,\n          notFilterNamespaces\n        });\n      }\n\n      // TODO: Add return info\n      if (!this.currentProduct?.hideSystemResources) {\n        out = [\n          {\n            id:    ALL,\n            kind:  NAMESPACE_FILTER_KINDS.SPECIAL,\n            label: t('nav.ns.all'),\n          },\n          {\n            id:    ALL_USER,\n            kind:  NAMESPACE_FILTER_KINDS.SPECIAL,\n            label: t('nav.ns.user'),\n          },\n          {\n            id:    ALL_SYSTEM,\n            kind:  NAMESPACE_FILTER_KINDS.SPECIAL,\n            label: t('nav.ns.system'),\n          },\n          {\n            id:    NAMESPACED_YES,\n            kind:  NAMESPACE_FILTER_KINDS.SPECIAL,\n            label: t('nav.ns.namespaced'),\n          },\n          {\n            id:    NAMESPACED_NO,\n            kind:  NAMESPACE_FILTER_KINDS.SPECIAL,\n            label: t('nav.ns.clusterLevel'),\n          },\n        ];\n\n        divider(out);\n      }\n\n      const inStore = this.$store.getters['currentStore'](NAMESPACE);\n\n      if (!inStore) {\n        return out;\n      }\n\n      let namespaces = sortBy(\n        this.$store.getters[`${ inStore }/all`](NAMESPACE),\n        ['nameDisplay']\n      );\n\n      namespaces = this.filterNamespaces(namespaces);\n\n      // isRancher = mgmt schemas are loaded and there's a project schema\n      if (this.$store.getters['isRancher']) {\n        const cluster = this.$store.getters['currentCluster'];\n        let projects = this.$store.getters['management/all'](\n          MANAGEMENT.PROJECT\n        );\n\n        projects = projects.filter((p) => {\n          return this.currentProduct?.hideSystemResources ? !p.isSystem && p.spec.clusterName === cluster.id : p.spec.clusterName === cluster.id;\n        });\n        projects = sortBy(filterBy(projects, 'spec.clusterName', cluster.id), [\n          'nameDisplay',\n        ]);\n        const projectsById = {};\n        const namespacesByProject = {};\n        let firstProject = true;\n\n        namespacesByProject[null] = []; // For namespaces not in a project\n        for (const project of projects) {\n          projectsById[project.metadata.name] = project;\n        }\n\n        for (const namespace of namespaces) {\n          let projectId = namespace.projectId;\n\n          if (!projectId || !projectsById[projectId]) {\n            // If there's a projectId but that project doesn't exist, treat it like no project\n            projectId = null;\n          }\n\n          let entry = namespacesByProject[projectId];\n\n          if (!entry) {\n            entry = [];\n            namespacesByProject[namespace.projectId] = entry;\n          }\n          entry.push(namespace);\n        }\n\n        for (const project of projects) {\n          const id = project.metadata.name;\n\n          if (firstProject) {\n            firstProject = false;\n          } else {\n            divider(out);\n          }\n\n          out.push({\n            id:    `${ NAMESPACE_FILTER_P_FULL_PREFIX }${ id }`,\n            kind:  NAMESPACE_FILTER_KINDS.PROJECT,\n            label: t('nav.ns.project', { name: project.nameDisplay }),\n          });\n\n          const forThisProject = namespacesByProject[id] || [];\n\n          addNamespace(out, forThisProject);\n        }\n\n        const orphans = namespacesByProject[null];\n\n        if (orphans.length) {\n          if (!firstProject) {\n            divider(out);\n          }\n\n          out.push({\n            id:       ALL_ORPHANS,\n            kind:     NAMESPACE_FILTER_KINDS.PROJECT,\n            label:    t('nav.ns.orphan'),\n            disabled: true,\n          });\n\n          addNamespace(out, orphans);\n        }\n      } else {\n        addNamespace(out, namespaces);\n      }\n\n      return out;\n\n      function addNamespace(out, namespaces) {\n        if (!isArray(namespaces)) {\n          namespaces = [namespaces];\n        }\n\n        addObjects(\n          out,\n          namespaces.map((namespace) => {\n            return {\n              id:    `${ NAMESPACE_FILTER_NS_FULL_PREFIX }${ namespace.id }`,\n              kind:  NAMESPACE_FILTER_KINDS.NAMESPACE,\n              label: t('nav.ns.namespace', { name: namespace.nameDisplay }),\n            };\n          })\n        );\n      }\n\n      function divider(out) {\n        out.push({\n          kind:     NAMESPACE_FILTER_KINDS.DIVIDER,\n          label:    `Divider ${ out.length }`,\n          disabled: true,\n        });\n      }\n    },\n\n    isSingleSpecial() {\n      return this.value && this.value.length === 1 && this.value[0].kind === NAMESPACE_FILTER_KINDS.SPECIAL;\n    },\n\n    value: {\n      get() {\n        // Use last picked filter from user preferences\n        const prefs = this.$store.getters['prefs/get'](NAMESPACE_FILTERS);\n        const values = prefs && prefs[this.key] ? prefs[this.key] : this.defaultOption();\n        const options = this.options;\n\n        // Remove values that are not valid options\n        const filters = values\n          .map((value) => {\n            return findBy(options, 'id', value);\n          })\n          .filter((x) => !!x);\n\n        return filters;\n      },\n\n      set(neu) {\n        const old = (this.value || []).slice();\n\n        neu = neu.filter((x) => !!x.id);\n\n        const last = neu[neu.length - 1];\n        const lastIsSpecial = last?.kind === NAMESPACE_FILTER_KINDS.SPECIAL;\n        const hadUser = !!old.find((x) => x.id === ALL_USER);\n        const hadAll = !!old.find((x) => x.id === ALL);\n\n        if (lastIsSpecial) {\n          neu = [last];\n        }\n\n        if (neu.length > 1) {\n          neu = neu.filter((x) => x.kind !== NAMESPACE_FILTER_KINDS.SPECIAL);\n        }\n\n        if (neu.find((x) => x.id === 'all')) {\n          neu = [];\n        }\n\n        let ids;\n\n        // If there was something selected and you remove it, go back to user by default\n        // Unless it was user or all\n        if (neu.length === 0 && !hadUser && !hadAll) {\n          ids = this.defaultOption();\n        } else {\n          ids = neu.map((x) => x.id);\n        }\n\n        this.$nextTick(() => {\n          this.$store.dispatch('switchNamespaces', {\n            ids,\n            key: this.key\n          });\n        });\n      },\n    }\n  },\n\n  beforeDestroy() {\n    this.removeCloseKeyHandler();\n  },\n\n  mounted() {\n    this.layout();\n  },\n\n  watch: {\n    value(neu) {\n      this.layout();\n    },\n\n    /**\n     * When there are thousands of entries certain actions (drop down opened, selection changed, etc) take a long time to complete (upwards\n     * of 5 seconds)\n     *\n     * This is caused by churn of the filtered and options computed properties causing multiple renders for each action.\n     *\n     * To break this multiple-render per cycle behaviour detatch `filtered` from the value used in `v-for`.\n     *\n     */\n    filtered(neu) {\n      if (!!neu) {\n        this.cachedFiltered = neu;\n      }\n    }\n  },\n\n  methods: {\n    filterNamespaces(namespaces) {\n      if (this.$store.getters['prefs/get'](ALL_NAMESPACES)) {\n        // If all namespaces options are turned on in the user preferences,\n        // return all namespaces including system namespaces and RBAC\n        // management namespaces.\n        return namespaces;\n      }\n\n      return namespaces.filter((namespace) => {\n        // Otherwise only filter out obscure namespaces, such as namespaces\n        // that Rancher uses to manage RBAC for projects, which should not be\n        // edited or deleted by Rancher users.\n        return !namespace.isObscure;\n      });\n    },\n    // Layout the content in the dropdown box to best use the space to show the selection\n    layout() {\n      this.$nextTick(() => {\n        // One we have re-rendered, see what we can fit in the control to show the selected namespaces\n        if (this.$refs.values) {\n          const container = this.$refs.values;\n          const overflow = container.scrollWidth > container.offsetWidth;\n          let hidden = 0;\n\n          const dropdown = this.$refs.dropdown;\n          // Remove padding and dropdown arrow size\n          const maxWidth = dropdown.offsetWidth - 20 - 24;\n\n          // If we are overflowing, then allow some space for the +N indicator\n          const itemCount = this.$refs.value ? this.$refs.value.length : 0;\n          let currentWidth = 0;\n          let show = true;\n\n          this.total = 0;\n\n          for (let i = 0; i < itemCount; i++) {\n            const item = this.$refs.value[i];\n            let itemWidth = item.offsetWidth + 10;\n\n            // If this is the first item and we have overflow then add on some space for the +N\n            if (i === 0 && overflow) {\n              itemWidth += 40;\n            }\n\n            currentWidth += itemWidth;\n\n            if (show) {\n              if (i === 0) {\n                // Can't even fit the first item in\n                if (itemWidth > maxWidth) {\n                  show = false;\n                  this.total = this.value.length;\n                }\n              } else {\n                show = currentWidth < maxWidth;\n              }\n            }\n\n            hidden += show ? 0 : 1;\n            item.style.visibility = show ? 'visible' : 'hidden';\n          }\n\n          this.hidden = this.total > 0 ? 0 : hidden;\n        }\n      });\n    },\n    addCloseKeyHandler() {\n      document.addEventListener('keyup', this.closeKeyHandler);\n    },\n    removeCloseKeyHandler() {\n      document.removeEventListener('keyup', this.closeKeyHandler);\n    },\n    closeKeyHandler(e) {\n      if (e.keyCode === KEY.ESCAPE ) {\n        this.close();\n      }\n    },\n    // Keyboard support\n    itemKeyHandler(e, opt) {\n      if (e.keyCode === KEY.DOWN ) {\n        e.preventDefault();\n        e.stopPropagation();\n        this.down();\n      } else if (e.keyCode === KEY.UP ) {\n        e.preventDefault();\n        e.stopPropagation();\n        this.up();\n      } else if (e.keyCode === KEY.SPACE || e.keyCode === KEY.CR) {\n        if (this.namespaceFilterMode && !opt.enabled) {\n          return;\n        }\n        e.preventDefault();\n        e.stopPropagation();\n        this.selectOption(opt);\n        e.target.focus();\n      }\n    },\n    inputKeyHandler(e) {\n      switch (e.keyCode) {\n      case KEY.DOWN:\n        e.preventDefault();\n        e.stopPropagation();\n        this.down(true);\n        break;\n      case KEY.TAB:\n        // Tab out of the input box\n        this.close();\n        e.target.blur();\n        break;\n      case KEY.CR:\n        if (this.filtered.length === 1) {\n          this.selectOption(this.filtered[0]);\n          this.filter = '';\n        }\n        break;\n      }\n    },\n    mouseOver(event) {\n      const el = event?.path?.find((e) => e.classList.contains('ns-option'));\n\n      this.activeElement = el;\n    },\n    setActiveElement(el) {\n      if (!el?.focus) {\n        return;\n      }\n\n      el.focus();\n      this.activeElement = null;\n    },\n    down(input) {\n      const exising = this.activeElement || document.activeElement;\n\n      // Focus the first element in the list\n      if (input || !exising) {\n        if (this.$refs.options) {\n          const c = this.$refs.options.children;\n\n          if (c && c.length > 0) {\n            this.setActiveElement(c[0]);\n          }\n        }\n      } else {\n        let next = exising.nextSibling;\n\n        if (next?.children?.length) {\n          const item = next.children[0];\n\n          // Skip over dividers (assumes we don't have two dividers next to each other)\n          if (item.classList.contains('ns-divider')) {\n            next = next.nextSibling;\n          }\n        }\n\n        if (next?.focus) {\n          this.setActiveElement(next);\n        }\n      }\n    },\n    up() {\n      if (document.activeElement) {\n        let prev = document.activeElement.previousSibling;\n\n        if (prev?.children?.length) {\n          const item = prev.children[0];\n\n          if (item.classList.contains('ns-divider')) {\n            prev = prev.previousSibling;\n          }\n        }\n\n        if (prev?.focus) {\n          this.setActiveElement(prev);\n        }\n      }\n    },\n    toggle() {\n      if (this.isOpen) {\n        this.close();\n      } else {\n        this.open();\n      }\n    },\n    open() {\n      this.isOpen = true;\n      this.$nextTick(() => {\n        this.$refs.filter.focus();\n      });\n      this.addCloseKeyHandler();\n      this.layout();\n    },\n    close() {\n      this.isOpen = false;\n      this.activeElement = null;\n      this.removeCloseKeyHandler();\n      this.layout();\n    },\n    clear() {\n      this.value = [];\n    },\n    selectOption(option) {\n      // Ignore click for a divider\n      if (option.kind === NAMESPACE_FILTER_KINDS.DIVIDER) {\n        return;\n      }\n\n      const current = this.value;\n\n      // Remove invalid\n      if (!!this.namespaceFilterMode?.length) {\n        this.value.forEach((v) => {\n          if (!this.namespaceFilterMode.find((f) => f === v.kind)) {\n            const index = current.findIndex((c) => c.id === v.id);\n\n            current.splice(index, 1);\n          }\n        });\n      }\n\n      const exists = current.findIndex((v) => v.id === option.id);\n\n      // Remove if it exists (or always add if in singleton mode - we've reset the list above)\n      if (exists !== -1) {\n        current.splice(exists, 1);\n      } else {\n        current.push(option);\n      }\n\n      this.value = current;\n\n      if (document.activeElement) {\n        document.activeElement.blur();\n      }\n    },\n    handleValueMouseDown(ns, event) {\n      this.removeOption(ns, event);\n\n      if (this.value.length === 0) {\n        this.open();\n      }\n    },\n\n    removeOption(ns, event) {\n      this.selectOption(ns);\n      event.preventDefault();\n      event.stopPropagation();\n    },\n\n    defaultOption() {\n      // Note - This is one place where a default ns/project filter value is provided (ALL_USER)\n      // There's also..\n      // - dashboard root store `loadCluster` --> when `updateNamespaces` is dispatched\n      // - harvester root store `loadCluster` --> when `updateNamespaces` is dispatched (can be discarded)\n      // Due to this, we can't really set a nicer default when forced ns/project filtering is on (ALL_USER is invalid)\n      if (this.currentProduct?.customNamespaceFilter) {\n        return [];\n      }\n\n      return [ALL_USER];\n    },\n\n    calcNamespaceFilterMode() {\n      if (pAndNFiltering.isEnabled(this.$store.getters)) {\n        return [NAMESPACE_FILTER_KINDS.NAMESPACE, NAMESPACE_FILTER_KINDS.PROJECT];\n      }\n\n      return null;\n    },\n  }\n};\n</script>\n\n<template>\n  <div\n    v-if=\"!$fetchState.pending\"\n    class=\"ns-filter\"\n    data-testid=\"namespaces-filter\"\n    tabindex=\"0\"\n    @focus=\"open()\"\n  >\n    <div\n      v-if=\"isOpen\"\n      class=\"ns-glass\"\n      @click=\"close()\"\n    />\n\n    <!-- Select Dropdown control -->\n    <div\n      ref=\"dropdown\"\n      class=\"ns-dropdown\"\n      data-testid=\"namespaces-dropdown\"\n      :class=\"{ 'ns-open': isOpen }\"\n      @click=\"toggle()\"\n    >\n      <!-- No filters found or available -->\n      <div\n        v-if=\"value.length === 0\"\n        ref=\"values\"\n        data-testid=\"namespaces-values-none\"\n        class=\"ns-values\"\n      >\n        {{ t('nav.ns.all') }}\n      </div>\n\n      <!-- Filtered by set with custom label E.g. \"All namespaces\" -->\n      <div\n        v-else-if=\"isSingleSpecial\"\n        ref=\"values\"\n        data-testid=\"namespaces-values-label\"\n        class=\"ns-values\"\n      >\n        {{ value[0].label }}\n      </div>\n\n      <!-- All the selected namespaces -->\n      <div\n        v-else\n        ref=\"values\"\n        v-clean-tooltip=\"tooltip\"\n        data-testid=\"namespaces-values\"\n        class=\"ns-values\"\n      >\n        <div\n          v-if=\"total\"\n          ref=\"total\"\n          data-testid=\"namespaces-values-total\"\n          class=\"ns-value ns-abs\"\n        >\n          {{ t('namespaceFilter.selected.label', { total }) }}\n        </div>\n        <div\n          v-for=\"(ns, j) in value\"\n          ref=\"value\"\n          :key=\"ns.id\"\n          :data-testid=\"`namespaces-value-${j}`\"\n          class=\"ns-value\"\n        >\n          <div>{{ ns.label }}</div>\n          <!-- block user from removing the last selection if ns forced filtering is on -->\n          <i\n            v-if=\"!namespaceFilterMode || value.length > 1\"\n            class=\"icon icon-close\"\n            :data-testid=\"`namespaces-values-close-${j}`\"\n            @click=\"removeOption(ns, $event)\"\n            @mousedown=\"handleValueMouseDown(ns, $event)\"\n          />\n        </div>\n      </div>\n\n      <!-- Inform user if more namespaces are selected -->\n      <div\n        v-if=\"hidden > 0\"\n        ref=\"more\"\n        v-clean-tooltip=\"tooltip\"\n        class=\"ns-more\"\n      >\n        {{ t('namespaceFilter.more', { more: hidden }) }}\n      </div>\n      <i\n        v-if=\"!isOpen\"\n        class=\"icon icon-chevron-down\"\n      />\n      <i\n        v-else\n        class=\"icon icon-chevron-up\"\n      />\n    </div>\n    <button\n      v-shortkey.once=\"['n']\"\n      class=\"hide\"\n      @shortkey=\"open()\"\n    />\n\n    <!-- Dropdown menu -->\n    <div\n      v-if=\"isOpen\"\n      class=\"ns-dropdown-menu\"\n      data-testid=\"namespaces-menu\"\n    >\n      <div class=\"ns-controls\">\n        <div class=\"ns-input\">\n          <input\n            ref=\"filter\"\n            v-model=\"filter\"\n            tabindex=\"0\"\n            class=\"ns-filter-input\"\n            @keydown=\"inputKeyHandler($event)\"\n          >\n          <i\n            v-if=\"hasFilter\"\n            class=\"ns-filter-clear icon icon-close\"\n            @click=\"filter = ''\"\n          />\n        </div>\n        <div\n          v-if=\"namespaceFilterMode\"\n          class=\"ns-singleton-info\"\n        >\n          <i\n            v-clean-tooltip=\"t('resourceList.nsFilterToolTip')\"\n            class=\"icon icon-info\"\n          />\n        </div>\n        <div\n          v-else\n          class=\"ns-clear\"\n        >\n          <i\n            class=\"icon icon-close\"\n            @click=\"clear()\"\n          />\n        </div>\n      </div>\n      <div class=\"ns-divider mt-0\" />\n      <div\n        ref=\"options\"\n        class=\"ns-options\"\n        role=\"list\"\n      >\n        <div\n          v-for=\"(opt, i) in cachedFiltered\"\n          :id=\"opt.elementId\"\n          :key=\"opt.id\"\n          tabindex=\"0\"\n          class=\"ns-option\"\n          :disabled=\"!opt.enabled\"\n          :class=\"{\n            'ns-selected': opt.selected,\n            'ns-single-match': cachedFiltered.length === 1 && !opt.selected,\n          }\"\n          :data-testid=\"`namespaces-option-${i}`\"\n          @click=\"opt.enabled && selectOption(opt)\"\n          @mouseover=\"opt.enabled && mouseOver($event)\"\n          @keydown=\"itemKeyHandler($event, opt)\"\n        >\n          <div\n            v-if=\"opt.kind === NAMESPACE_FILTER_KINDS.DIVIDER\"\n            class=\"ns-divider\"\n          />\n          <div\n            v-else\n            class=\"ns-item\"\n          >\n            <i\n              v-if=\"opt.kind === NAMESPACE_FILTER_KINDS.NAMESPACE\"\n              class=\"icon icon-folder\"\n            />\n            <div>{{ opt.label }}</div>\n            <i\n              v-if=\"opt.selected\"\n              class=\"icon icon-checkmark\"\n            />\n          </div>\n        </div>\n        <div\n          v-if=\"cachedFiltered.length === 0\"\n          class=\"ns-none\"\n          data-testid=\"namespaces-option-none\"\n        >\n          {{ t('namespaceFilter.noMatchingOptions') }}\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<style lang=\"scss\" scoped>\n  $ns_dropdown_size: 24px;\n\n  .ns-abs {\n    position: absolute;\n  }\n\n  .ns-filter {\n    width: 280px;\n    display: inline-block;\n\n    $glass-z-index: 2;\n    $dropdown-z-index: 1000;\n\n    .ns-glass {\n      height: 100vh;\n      left: 0;\n      opacity: 0;\n      position: absolute;\n      top: 0;\n      width: 100vw;\n      z-index: $glass-z-index;\n    }\n\n    .ns-controls {\n      align-items: center;\n      display: flex;\n    }\n\n    .ns-clear {\n      &:hover {\n        color: var(--primary);\n        cursor: pointer;\n      }\n    }\n\n    .ns-singleton-info, .ns-clear {\n      align-items: center;\n      display: flex;\n      > i {\n        padding-right: 5px;\n      }\n    }\n\n    .ns-input {\n      flex: 1;\n      padding: 5px;\n      position: relative;\n    }\n\n    .ns-filter-input {\n      height: 24px;\n    }\n\n    .ns-filter-clear {\n      cursor: pointer;\n      position: absolute;\n      right: 10px;\n      top: 5px;\n      line-height: 24px;\n      text-align: center;\n      width: 24px;\n    }\n\n    .ns-dropdown-menu {\n      background-color: var(--header-bg);\n      border: 1px solid var(--primary-border);\n      border-bottom-left-radius: var(--border-radius);\n      border-bottom-right-radius: var(--border-radius);\n      color: var(--header-btn-text);\n      margin-top: -1px;\n      padding-bottom: 10px;\n      position: relative;\n      z-index: $dropdown-z-index;\n\n      .ns-options {\n        max-height: 50vh;\n        overflow-y: auto;\n\n        .ns-none {\n          color: var(--muted);\n          padding: 0 10px;\n        }\n      }\n\n      .ns-divider {\n        border-top: 1px solid var(--border);\n        cursor: default;\n        margin-top: 10px;\n        padding-bottom: 10px;\n      }\n\n      .ns-option {\n\n        &[disabled] {\n          cursor: default;\n        }\n\n        &:not([disabled]) {\n          &:focus {\n            background-color: var(--dropdown-hover-bg);\n            color: var(--dropdown-hover-text);\n          }\n          .ns-item {\n             &:hover, &:focus {\n              background-color: var(--dropdown-hover-bg);\n              color: var(--dropdown-hover-text);\n              cursor: pointer;\n\n              > i {\n                color: var(--dropdown-hover-text);\n              }\n            }\n          }\n\n          &.ns-selected {\n            &:hover,&:focus {\n              .ns-item {\n                > * {\n                  background-color: var(--dropdown-hover-bg);\n                  color: var(--dropdown-hover-text);\n                }\n              }\n            }\n          }\n\n          &.ns-selected:not(:hover) {\n            .ns-item {\n              > * {\n                color: var(--dropdown-hover-bg);\n              }\n            }\n\n            &:focus {\n              .ns-item {\n                > * {\n                  color: var(--dropdown-hover-text);\n                }\n              }\n            }\n          }\n        }\n\n        .ns-item {\n          align-items: center;\n          display: flex;\n          height: 24px;\n          line-height: 24px;\n          padding: 0 10px;\n\n          > i {\n            color: var(--muted);\n            margin: 0 5px;\n          }\n\n          > div {\n            flex: 1;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n          }\n\n        }\n\n        &.ns-single-match {\n          .ns-item {\n            background-color: var(--dropdown-hover-bg);\n            > * {\n              color: var(--dropdown-hover-text);\n            }\n          }\n        }\n      }\n    }\n\n    .ns-dropdown {\n      align-items: center;\n      display: flex;\n      border: 1px solid var(--header-border);\n      border-radius: var(--border-radius);\n      color: var(--header-btn-text);\n      cursor: pointer;\n      height: 40px;\n      padding: 0 10px;\n      position: relative;\n      z-index: $dropdown-z-index;\n\n      &.ns-open {\n        border-bottom-left-radius: 0;\n        border-bottom-right-radius: 0;\n        border-color: var(--primary-border);\n      }\n\n      > .ns-values {\n        flex: 1;\n      }\n\n      &:hover {\n        > i {\n          color: var(--primary);\n        }\n      }\n\n      > i {\n        height: $ns_dropdown_size;\n        width: $ns_dropdown_size;\n        cursor: pointer;\n        text-align: center;\n        line-height: $ns_dropdown_size;\n      }\n\n      .ns-more {\n        border: 1px solid var(--header-border);\n        border-radius: 5px;\n        padding: 2px 8px;\n        margin-left: 4px;\n      }\n\n      .ns-values {\n        display: flex;\n        overflow: hidden;\n\n        .ns-value {\n          align-items: center;\n          background-color: rgba(0,0,0,.05);\n          border: 1px solid var(--header-border);\n          border-radius: 5px;\n          color: var(--tag-text);\n          display: flex;\n          line-height: 20px;\n          padding: 2px 5px;\n          white-space: nowrap;\n\n          > i {\n            margin-left: 5px;\n\n            &:hover {\n              color: var(--primary);\n            };\n          }\n\n          // Spacing between tags\n          &:not(:last-child) {\n            margin-right: 5px;\n          }\n        }\n      }\n    }\n  }\n</style>\n<style lang=\"scss\">\n  .tooltip {\n    .ns-filter-tooltip {\n      background-color: var(--body-bg);\n      margin: -6px;\n      padding: 6px;\n\n      .ns-filter-tooltip-item {\n        > div {\n          background-color: rgba(0,0,0,.05);\n          border: 1px solid var(--header-border);\n          border-radius: 5px;\n          color: var(--tag-text);\n          display: inline-block;\n          line-height: 20px;\n          padding: 2px 5px;\n          white-space: nowrap;\n          margin: 4px 0;\n        }\n      }\n    }\n  }\n</style>\n"]}]}